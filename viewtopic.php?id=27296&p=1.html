<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> how to force 10BaseT-FD for switchport on WR1043nd (rtl8366rb)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 21 Apr 2018 and 22 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=27296&amp;p=2.html">2</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p120899">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						12 Nov 2010, 15:20					</div>
				</div>
				<div class="post-content content">
					<p>Hello !</p><p>I&#039;m looking for a hint how to force 10BaseT-FD for a switchport on WR1043nd (rtl8366rb) with openwrt.<br />Got some old devices not capable of autonegotiation.<br />mii-tool will not do it, swconfig not either.</p><p>But since swconfig is capable of reading all neccessary registers from the switch,<br />should it be not to much effort to make it capable of writing those ?<br />Unfortunately my coding experience is very close to zero.<br />Can anybody help ?</p><p>Regards,<br />Ralph</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p121611">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						21 Nov 2010, 15:18					</div>
				</div>
				<div class="post-content content">
					<p>Push...</p><p>Regards,<br />Ralph</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p122336">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						1 Dec 2010, 12:04					</div>
				</div>
				<div class="post-content content">
					<p>Nobody can help ?<br />Please...</p><p>Regards,<br />Ralph</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p124008">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						27 Dec 2010, 16:32					</div>
				</div>
				<div class="post-content content">
					<p>push.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p124126">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">jal2</div>
					<div class="post-datetime">
						29 Dec 2010, 14:39					</div>
				</div>
				<div class="post-content content">
					<p>Have you tried your old devices? No idea about swconfig and the 1043ND switch, but IMHO modern PHY do parallel detection, i.e.<br />they can detect normal link pulses from a 10BaseT device. They will configure half duplex in this case.</p>											<p class="post-edited">(Last edited by <strong>jal2</strong> on 29 Dec 2010, 14:39)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p124131">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						29 Dec 2010, 16:48					</div>
				</div>
				<div class="post-content content">
					<p>Thank You, <br />but the problem is, that the old device is set up fixed to 10MBit fullduplex, no way to change that.<br />And any switch, that does autonegotiation will set it&#039;s own side to 10 MBit halfduplex,<br />which doesn&#039;t fit together...</p><p>Regards,<br />Ralph</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p127366">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">mjonsson</div>
					<div class="post-datetime">
						5 Feb 2011, 01:56					</div>
				</div>
				<div class="post-content content">
					<p>The driver does not yet support changing the auto negotiation. I have tried to find the datasheet for rtl8366rb to get the correct addresses, so I can try adding this feature to the driver, without success <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>I&#039;m in a similar situation where my 1043nd connection to my 24 Mbit ADSL modem is limited to 10Mbit link on openwrt, but have 100Mbit link on the factory firmware.</p><p>If someone have the register addresses (primarily PortN_Ability, Port Advertising Ability Control Register) for the rtl8366rb I would be happy to try to implement more of the features into the driver. If only I have the datasheet, I could also try to implement features like port mirroring etc. that the chip seems to supports.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p127371">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">sborilla</div>
					<div class="post-datetime">
						5 Feb 2011, 03:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mjonsson wrote:</cite><blockquote><p>The driver does not yet support changing the auto negotiation. I have tried to find the datasheet for rtl8366rb to get the correct addresses, so I can try adding this feature to the driver, without success <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p></blockquote></div><p>If you find the time to try:</p><p><a href="http://realtek.info/pdf/rtl8366_8369_datasheet_1-1.pdf">http://realtek.info/pdf/rtl8366_8369_datasheet_1-1.pdf</a></p><p>Chapter 8.14</p><p>The chip seems to load the config only upon reset, but even that shouldn&#039;t be much of a problem, because according to 10.4.1, even a soft reset does the trick.</p>											<p class="post-edited">(Last edited by <strong>sborilla</strong> on 5 Feb 2011, 03:33)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p127476">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						6 Feb 2011, 12:41					</div>
				</div>
				<div class="post-content content">
					<p>Maybe this one could be helpful, especially the belkin sources:</p><p><a href="https://dev.openwrt.org/ticket/7977">https://dev.openwrt.org/ticket/7977</a></p><p>Regards,<br />Ralph</p>											<p class="post-edited">(Last edited by <strong>sagemol</strong> on 6 Feb 2011, 12:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p127715">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						8 Feb 2011, 20:01					</div>
				</div>
				<div class="post-content content">
					<p>Hi,<br />I made a small review of the RTL8366rb controller driver in the openwrt&#039;s source branch, particularly : /target/linux/generic/files/drivers/net/phy/rtl8366rb.c and found several options which should be possible to be parsed via swconfig, but not sure if these have to be enabled in the config file first<br />However, the link options should work, so try this (let&#039;s say, you are configuring port 1 - the first LAN port):<br /></p><div class="codebox"><pre><code>$ swconfig dev rtl8366rb port 1 get link</code></pre></div><div class="codebox"><pre><code>$ swconfig dev rtl8366rb port 1 set link &lt;option&gt;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p127720">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						8 Feb 2011, 20:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>dir2cas wrote:</cite><blockquote><p>Hi,<br />I made a small review of the RTL8366rb controller driver in the openwrt&#039;s source branch, particularly : /target/linux/generic/files/drivers/net/phy/rtl8366rb.c and found several options which should be possible to be parsed via swconfig, but not sure if these have to be enabled in the config file first<br />However, the link options should work, so try this (let&#039;s say, you are configuring port 1 - the first LAN port):<br /></p><div class="codebox"><pre><code>$ swconfig dev rtl8366rb port 1 get link</code></pre></div><div class="codebox"><pre><code>$ swconfig dev rtl8366rb port 1 set link &lt;option&gt;</code></pre></div></blockquote></div><p>Hi,</p><p>sorry, tried this before. Anything i tried with &quot;set link&quot; didn&#039;t work.<br />But although i&#039;m not a programmer, i can read some code (i hope).<br />And when i went through the sources, there was the &quot;get link&quot; only, &quot;set link&quot; doesn&#039;t seem to be implemented...</p><br /><p>Regards,<br />Ralph</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p127725">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						8 Feb 2011, 20:59					</div>
				</div>
				<div class="post-content content">
					<p>Hmm, unfortunately you are right, I walked through the driver file and only<br />.get = rtl8366rb_sw_get_port_link,<br />line present, no set function. I am not a programmer too, simply trying to figure out some functionality of the controller as reviewing the c code.</p><p>I am also very interested and impressed by the optional features of RTL8366rb controller as sated in the link given by you above: <a href="https://dev.openwrt.org/ticket/7977">https://dev.openwrt.org/ticket/7977</a><br />However I cannot find the entries regarding the jumbo frames, broadcast/multicast storm prevention, etc in the current state of rtl8366rb.c <br />Is this patch added to the trunk branch, or these statements should be added/enabled manually before recompiling the image?<br />Regrds,dir2cas</p>											<p class="post-edited">(Last edited by <strong>dir2cas</strong> on 8 Feb 2011, 21:03)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p127727">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						8 Feb 2011, 21:14					</div>
				</div>
				<div class="post-content content">
					<p>went through the trunk sources, looks like at least jumbos are in there:</p><p>...<br />#define RTL8366RB_SGCR_MAX_LENGTH_9216<br />...</p><p>Edit:</p><p>....<br />#define RTL8366RB_SGCR_EN_BC_STORM_CTRL <br />....</p><br /><p>Regards,<br />Ralph</p>											<p class="post-edited">(Last edited by <strong>sagemol</strong> on 8 Feb 2011, 21:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p127730">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">dir2cas</div>
					<div class="post-datetime">
						8 Feb 2011, 21:49					</div>
				</div>
				<div class="post-content content">
					<p>Yes, I also noticed the define statements at the beginning, but the functions enabling, this to be triggered with swconfig , etc are not present in comparison to the patch, given in the link<br /><a href="https://dev.openwrt.org/attachment/ticket/7977/patch">https://dev.openwrt.org/attachment/ticket/7977/patch</a></p>											<p class="post-edited">(Last edited by <strong>dir2cas</strong> on 8 Feb 2011, 21:50)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p127768">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						9 Feb 2011, 09:14					</div>
				</div>
				<div class="post-content content">
					<p>Yep, You&#039;re right.<br />Seems, the patch wasn&#039;t implemented in trunk.<br />So You&#039;ll have to patch it manually.</p><p>Regards,<br />Ralph</p>											<p class="post-edited">(Last edited by <strong>sagemol</strong> on 9 Feb 2011, 09:14)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p130705">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						14 Mar 2011, 16:12					</div>
				</div>
				<div class="post-content content">
					<p>Hum, nothing new here for a month ?</p><p>mjonsson, didn&#039;t you want to do some work on the driver ?</p><p>regards,<br />ralph</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p130706">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">mjonsson</div>
					<div class="post-datetime">
						14 Mar 2011, 16:14					</div>
				</div>
				<div class="post-content content">
					<p>There is some problem getting time to do it... I have done a hack to read and write all registers, but have not yet have time to analyze the results <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p130707">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						14 Mar 2011, 16:29					</div>
				</div>
				<div class="post-content content">
					<p>Sorry to hear that...<br />Maybe i could help You with testing ? </p><p>regards,<br />Ralph</p>											<p class="post-edited">(Last edited by <strong>sagemol</strong> on 14 Mar 2011, 16:29)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p133346">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						18 Apr 2011, 15:12					</div>
				</div>
				<div class="post-content content">
					<p>A little push...</p><p>Regards,<br />Ralph</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138038">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						28 Jun 2011, 10:12					</div>
				</div>
				<div class="post-content content">
					<p>Hum, as nobody seems to care, i created a patch myself,<br />although i really do NOT know, what i&#039;m doing here in depth...</p><p>I&#039;m not a programmer, so the code might not be compliant to anything it probably should,<br />but it works and it does what it is expected to do.<br />If some &quot;real&quot; coder could take a look over it and possibly submit this or something<br />similar to svn....</p><div class="codebox"><pre><code> /* See later Posting for better patch....*/</code></pre></div><p>With this patch swconfig will be able to set any port to any speed fixed, e.g.</p><p>&quot;swconfig dev rtl8366rb port 2 set forcephy 3&quot;</p><p>will set port 2 to 10-MBit-Full-Duplex with autonegotiation disabled.</p><p>I still wonder why nobody seemed to care about this feature request since my first post regarding this<br />in 04/2010 in the WR1043nd-thread, although in some early sources this seemed to be included already:</p><p><a href="http://svn.dd-wrt.com/browser/src/linux/pb42/linux-2.6.23/drivers/net/phy/rtl8366rb_smi.c?rev=13863">http://svn.dd-wrt.com/browser/src/linux â€¦ ?rev=13863</a></p><p>(rtl8366rb_setEthernetPHY, probably not accesible via swconfig....)</p><p>Anyway, i finally got what i needed.<br />Thanks to all helpers.</p><p>regards,<br />Ralph</p>											<p class="post-edited">(Last edited by <strong>sagemol</strong> on 29 Jun 2011, 14:13)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138047">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						28 Jun 2011, 11:54					</div>
				</div>
				<div class="post-content content">
					<p>That looks pretty nice to me. I guess you should sign a ticket with that patch, so one of the developers will step over it and add it to trunk.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138088">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						28 Jun 2011, 19:27					</div>
				</div>
				<div class="post-content content">
					<p>Uh, eh, err....... ehm, sign a ticket ? :-)<br />I&#039;m new to submitting patches and tickets.... How ? </p><p>regards,<br />Ralph</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138095">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						28 Jun 2011, 20:43					</div>
				</div>
				<div class="post-content content">
					<p>Me too. But what I would do is visiting <a href="https://dev.openwrt.org/newticket">https://dev.openwrt.org/newticket</a> and enter your information about what that patch does. After signing, you will get the chance to append any files: that should be the patch you posted here.<br />Another way (which is actually explained on dev.openwrt.org) is to join the openwrt mailing list and post your patch there. I did that before as well, but I haven&#039;t seen any progress so far, but I receive like 10 mails per day of other people discussing and submitting things.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138158">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">sagemol</div>
					<div class="post-datetime">
						29 Jun 2011, 14:11					</div>
				</div>
				<div class="post-content content">
					<p>Lol, my first patch and i already had to revise it....<br />But now it&#039;s stable.</p><div class="codebox"><pre><code>Index: target/linux/generic/files/drivers/net/phy/rtl8366rb.c
===================================================================
--- target/linux/generic/files/drivers/net/phy/rtl8366rb.c    (revision 27302)
+++ target/linux/generic/files/drivers/net/phy/rtl8366rb.c    (working copy)
@@ -21,7 +21,7 @@
 #include &quot;rtl8366_smi.h&quot;
 
 #define RTL8366RB_DRIVER_DESC    &quot;Realtek RTL8366RB ethernet switch driver&quot;
-#define RTL8366RB_DRIVER_VER    &quot;0.2.3&quot;
+#define RTL8366RB_DRIVER_VER    &quot;0.2.4&quot;
 
 #define RTL8366RB_PHY_NO_MAX    4
 #define RTL8366RB_PHY_PAGE_MAX    7
@@ -64,11 +64,17 @@
 #define RTL8366RB_PHY_CTRL_READ            1
 #define RTL8366RB_PHY_CTRL_WRITE        0
 
+#define RTL8366RB_PHY_CONTROL_REG               0
 #define RTL8366RB_PHY_REG_MASK            0x1f
 #define RTL8366RB_PHY_PAGE_OFFSET        5
 #define RTL8366RB_PHY_PAGE_MASK            (0xf &lt;&lt; 5)
 #define RTL8366RB_PHY_NO_OFFSET            9
 #define RTL8366RB_PHY_NO_MASK            (0x1f &lt;&lt; 9)
+#define RTL8366RB_PHY_FORCE_10_BASE_T_HALF    0x0000
+#define RTL8366RB_PHY_FORCE_10_BASE_T_FULL    0x0100
+#define RTL8366RB_PHY_FORCE_100_BASE_T_HALF    0x2000
+#define RTL8366RB_PHY_FORCE_100_BASE_T_FULL    0x2100
+#define RTL8366RB_PHY_FORCE_AUTONEGOTIATION    0x1340
 
 #define RTL8366RB_VLAN_INGRESS_CTRL2_REG    0x037f
 
@@ -738,6 +744,43 @@
     return 0;
 }
 
+static int rtl8366rb_sw_set_port_phy_force(struct switch_dev *dev,
+                    const struct switch_attr *attr,
+                    struct switch_val *val)
+{
+    struct rtl8366_smi *smi = sw_to_rtl8366_smi(dev);
+    u32 phy_force = 0; /* is zero for failsafe */
+    u32 reg;
+    int ret;
+    
+    if (val-&gt;port_vlan &gt;= RTL8366RB_NUM_PORTS)
+        return -EINVAL;
+
+/* There&#039;s no way to set forced speed/duplex at 1000Base-T, autonegotion MUST always be on. */
+
+    if ((val-&gt;value.i &gt; 4 ) || (val-&gt;value.i &lt; 0 ))
+        return -EINVAL;
+
+    if (val-&gt;value.i == 4 ) {
+        phy_force = RTL8366RB_PHY_FORCE_10_BASE_T_HALF;
+    }
+    if (val-&gt;value.i == 3 ) {
+        phy_force = RTL8366RB_PHY_FORCE_10_BASE_T_FULL;
+    }
+    if (val-&gt;value.i == 2 ) {
+        phy_force = RTL8366RB_PHY_FORCE_100_BASE_T_HALF;
+    }
+    if (val-&gt;value.i == 1 ) {
+        phy_force = RTL8366RB_PHY_FORCE_100_BASE_T_FULL;
+    }
+    if (val-&gt;value.i == 0 ) {
+        phy_force = RTL8366RB_PHY_FORCE_AUTONEGOTIATION;
+    }
+
+    return rtl8366rb_write_phy_reg(smi,val-&gt;port_vlan,0,RTL8366RB_PHY_CONTROL_REG,phy_force);
+
+}
+
 static int rtl8366rb_sw_set_port_led(struct switch_dev *dev,
                     const struct switch_attr *attr,
                     struct switch_val *val)
@@ -1025,6 +1068,14 @@
         .set = NULL,
         .get = rtl8366rb_sw_get_port_link,
     }, {
+        .type = SWITCH_TYPE_INT,
+        .name = &quot;forcephy&quot;,
+        .description = &quot;Set Force Speed/Duplex (0 = Auto, 1 = 100Full,&quot;
+        &quot; 2 = 100Half, 3 = 10Full, 4 = 10Half,)&quot;,
+        .max = 4,
+        .set = rtl8366rb_sw_set_port_phy_force,
+        .get = NULL,
+    }, {
         .type = SWITCH_TYPE_NOVAL,
         .name = &quot;reset_mib&quot;,
         .description = &quot;Reset single port MIB counters&quot;,</code></pre></div><p>I have &quot;hijacked&quot; a ticket already:</p><p><a href="https://dev.openwrt.org/ticket/7977">https://dev.openwrt.org/ticket/7977</a></p><p>Let&#039;s see, what happens.<br />I made it, i gave it, i can live with that.</p><p>regards,<br />Ralph</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p138191">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						29 Jun 2011, 20:59					</div>
				</div>
				<div class="post-content content">
					<p>I would recommend to make use of that &quot;attach file&quot; button. Don&#039;t know how notification with the tickets works, so I don&#039;t know how far the developers get to know about your comments.</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=27296&amp;p=2.html">2</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>