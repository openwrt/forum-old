<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Need help at backfire 10.3(bcm-24) to acces gpio(led-button)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 24 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p143930">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">strelok-ac</div>
					<div class="post-datetime">
						18 Sep 2011, 17:37					</div>
				</div>
				<div class="post-content content">
					<p>Second day im try to find the way how-to access GPIO, read the button state and set LED state. Read a lot websites but cannot find how to do at kernel 2.6.<br />My router is chinese one same with WL-500gp, model is ?? db-5005g. Please help me howto work with buttons/LED&#039;s at bcm-2.4 kernel. And when im try to set command nvram, see this:</p><p>Could not open nvram! Possible reasons are:<br />&nbsp; &nbsp; &nbsp; &nbsp; - No device found (/proc not mounted or no nvram present)<br />&nbsp; &nbsp; &nbsp; &nbsp; - Insufficient permissions to open mtd device<br />&nbsp; &nbsp; &nbsp; &nbsp; - Insufficient memory to complete operation<br />&nbsp; &nbsp; &nbsp; &nbsp; - Memory mapping failed or not supported</p><br /><p>dmesg:</p><p>CPU revision is: 00029029<br />Primary instruction cache 16kB, physically tagged, 4-way, linesize 16 bytes.<br />Primary data cache 16kB, 2-way, linesize 16 bytes.<br />Linux version 2.4.37.9 (openwrt@wrt1.marcant.net) (gcc version 3.4.6 (OpenWrt-2.0)) #42 Tue Apr 6 15:59:04 CEST 2010<br />Setting the PFC to its default value<br />Determined physical RAM map:<br /> memory: 02000000 @ 00000000 (usable)<br />On node 0 totalpages: 8192<br />zone(0): 8192 pages.<br />zone(1): 0 pages.<br />zone(2): 0 pages.<br />Kernel command line: root=/dev/mtdblock2 rootfstype=squashfs,jffs2 init=/etc/preinit noinitrd console=ttyS0,115200<br />CPU: BCM5354 rev 2 at 240 MHz<br />Using 120.000 MHz high precision timer.<br />Calibrating delay loop... 237.56 BogoMIPS<br />Memory: 30448k/32768k available (1447k kernel code, 2320k reserved, 100k data, 84k init, 0k highmem)<br />Dentry cache hash table entries: 4096 (order: 3, 32768 bytes)<br />Inode cache hash table entries: 2048 (order: 2, 16384 bytes)<br />Mount cache hash table entries: 512 (order: 0, 4096 bytes)<br />Buffer cache hash table entries: 1024 (order: 0, 4096 bytes)<br />Page-cache hash table entries: 8192 (order: 3, 32768 bytes)<br />Checking for &#039;wait&#039; instruction...&nbsp; unavailable.<br />POSIX conformance testing by UNIFIX<br />PCI: no core<br />PCI: Fixing up bus 0<br />Linux NET4.0 for Linux 2.4<br />Based upon Swansea University Computer Society NET3.039<br />Initializing RT netlink socket<br />Starting kswapd<br />Registering mini_fo version $Id$<br />devfs: v1.12c (20020818) Richard Gooch (rgooch@atnf.csiro.au)<br />devfs: boot_options: 0x1<br />JFFS2 version 2.1. (C) 2001 Red Hat, Inc., designed by Axis Communications AB.<br />squashfs: version 3.0 (2006/03/15) Phillip Lougher<br />pty: 256 Unix98 ptys configured<br />Serial driver version 5.05c (2001-07-08) with MANY_PORTS SHARE_IRQ SERIAL_PCI enabled<br />ttyS00 at 0xb8000300 (irq = 3) is a 16550A<br />ttyS01 at 0xb8000400 (irq = 3) is a 16550A<br />b44.c:v0.93 (Mar, 2004)<br />PCI: Setting latency timer of device 00:01.0 to 64<br />eth0: Broadcom 47xx 10/100BaseT Ethernet 00:11:22:33:44:54<br />Physically mapped flash: Found an alias at 0x1000000 for the chip at 0x0<br /> Amd/Fujitsu Extended Query Table v1.3 at 0x0040<br />number of CFI chips: 1<br />cfi_cmdset_0002: Disabling fast programming due to code brokenness.<br />Flash device: 0x1000000 at 0x1c000000<br />bootloader size: 131072<br />Physically mapped flash: Filesystem type: squashfs, size=0x1a68f2<br />Creating 5 MTD partitions on &quot;Physically mapped flash&quot;:<br />0x00000000-0x00020000 : &quot;cfe&quot;<br />0x00020000-0x00fe0000 : &quot;linux&quot;<br />0x0009c000-0x00260000 : &quot;rootfs&quot;<br />mtd: partition &quot;rootfs&quot; doesn&#039;t start on an erase block boundary -- force read-only<br />0x00fe0000-0x01000000 : &quot;nvram&quot;<br />0x00260000-0x00fe0000 : &quot;rootfs_data&quot;<br />sflash: found no supported devices<br />Initializing Cryptographic API<br />NET4: Linux TCP/IP 1.0 for NET4.0<br />IP Protocols: ICMP, UDP, TCP, IGMP<br />IP: routing cache hash table of 512 buckets, 4Kbytes<br />TCP: Hash tables configured (established 2048 bind 4096)<br />Linux IP multicast router 0.06 plus PIM-SM<br />NET4: Unix domain sockets 1.0/SMP for Linux NET4.0.<br />NET4: Ethernet Bridge 008 for NET4.0<br />802.1Q VLAN Support v1.8 Ben Greear &lt;greearb@candelatech.com&gt;<br />All bugs added by David S. Miller &lt;davem@redhat.com&gt;<br />VFS: Mounted root (squashfs filesystem) readonly.<br />Mounted devfs on /dev<br />Freeing unused kernel memory: 84k freed<br />diag: Router model not detected.<br />b44: eth0: Link is up at 100 Mbps, full duplex.<br />b44: eth0: Flow control is off for TX and off for RX.<br />roboswitch: Probing device eth0: found a 5325! It&#039;s a 5350.<br />b44: eth0: Link is up at 100 Mbps, full duplex.<br />b44: eth0: Flow control is off for TX and off for RX.<br />b44: eth0: Link is up at 100 Mbps, full duplex.<br />b44: eth0: Flow control is off for TX and off for RX.<br />mini_fo: using base directory: /<br />mini_fo: using storage directory: /overlay<br />b44: eth0: Link is up at 100 Mbps, full duplex.<br />b44: eth0: Flow control is off for TX and off for RX.<br />b44: eth0: Link is up at 100 Mbps, full duplex.<br />b44: eth0: Flow control is off for TX and off for RX.<br />jffs2.bbc: SIZE compression mode activated.<br />b44: eth0: Link is up at 100 Mbps, full duplex.<br />b44: eth0: Flow control is off for TX and off for RX.<br />SCSI subsystem driver Revision: 1.00<br />usb.c: registered new driver usbdevfs<br />usb.c: registered new driver hub<br />eth0.0: add 01:00:5e:00:00:01 mcast address to master interface<br />eth0.1: add 01:00:5e:00:00:01 mcast address to master interface<br />eth0.1: del 01:00:5e:00:00:01 mcast address from vlan interface<br />eth0.1: del 01:00:5e:00:00:01 mcast address from master interface<br />eth0.1: Setting MAC address to&nbsp; 00 21 00 5a ef b0.<br />device eth0 entered promiscuous mode<br />VLAN (eth0.1):&nbsp; Setting underlying device (eth0) to promiscious mode.<br />eth0.1: add 01:00:5e:00:00:01 mcast address to master interface<br />eth0.0: dev_set_promiscuity(master, 1)<br />device eth0.0 entered promiscuous mode<br />br-lan: port 1(eth0.0) entering learning state<br />br-lan: port 1(eth0.0) entering forwarding state<br />br-lan: topology change detected, propagating<br />PCI: Setting latency timer of device 00:05.0 to 64<br />PCI/DMA<br />wl0: wlc_attach: chiprev 2 coreunit 0 corerev 13 cccap 0x104007ea maccap 0x30482205 band 2.4G, phy_type 5 phy_rev 0 ana_rev 6<br />wl0: Broadcom BCM4318 802.11 Wireless Controller 4.150.10.5<br />CSLIP: code copyright 1989 Regents of the University of California<br />PPP generic driver version 2.4.2<br />Journalled Block Device driver loaded<br />ip_tables: (C) 2000-2002 Netfilter core team<br />SB USB20H init<br />SB COREREV: 2<br />SB USB20H resetting<br />USB20H fcr: 0x64<br />USB20H shim cr: 0x8f7<br />PCI: Setting latency timer of device 00:03.1 to 64<br />ehci_hcd 00:03.1: PCI device 14e4:471a<br />ehci_hcd 00:03.1: irq 6, pci mem b8003800<br />usb.c: new USB bus registered, assigned bus number 1<br />ehci_hcd 00:03.1: illegal capability!<br />ehci_hcd 00:03.1: USB 0.0 enabled, EHCI 1.00, driver 2003-Dec-29/2.4<br />hub.c: USB hub found<br />hub.c: 2 ports detected<br />ip_conntrack version 2.1 (5953 buckets, 5953 max) - 352 bytes per conntrack<br />ipt_recent v0.3.1: Stephen Frost &lt;sfrost@snowman.net&gt;.&nbsp; <a href="http://snowman.net/projects/ipt_recent/">http://snowman.net/projects/ipt_recent/</a><br />imq driver loaded.<br />SB USB20H init<br />SB COREREV: 2<br />USB20H fcr: 0x64<br />USB20H shim cr: 0x8f7<br />PCI: Setting latency timer of device 00:03.0 to 64<br />usb-ohci.c: USB OHCI at membase 0xb8003000, IRQ 6<br />usb-ohci.c: usb-00:03.0, PCI device 14e4:471a<br />usb.c: new USB bus registered, assigned bus number 2<br />hub.c: USB hub found<br />hub.c: 2 ports detected<br />uhci.c: USB Universal Host Controller Interface driver v1.1<br />Initializing USB Mass Storage driver...<br />usb.c: registered new driver usb-storage<br />USB Mass Storage support registered.<br />fuse init (API version 7.5)<br />fuse distribution version: 2.5.3<br />fuse init: DCACHE_BUG enabled<br />device wl0.1 entered promiscuous mode<br />br-lan: port 2(wl0.1) entering learning state<br />br-lan: port 2(wl0.1) entering forwarding state<br />br-lan: topology change detected, propagating<br />imq driver loaded.<br />Warning: DQ5 raised while program operation was in progress, however operation completed OK<br />Warning: DQ5 raised while program operation was in progress, however operation completed OK<br />Warning: DQ5 raised while program operation was in progress, however operation completed OK<br />Warning: DQ5 raised while program operation was in progress, however operation completed OK</p>											<p class="post-edited">(Last edited by <strong>strelok-ac</strong> on 18 Sep 2011, 17:39)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p144228">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">strelok-ac</div>
					<div class="post-datetime">
						22 Sep 2011, 14:13					</div>
				</div>
				<div class="post-content content">
					<p>RESOLVED! Need to modify kmod-diag.o:</p><br /><p>Index: package/broadcom-diag/src/diag.c<br />===================================================================<br />--- package/broadcom-diag/src/diag.c&nbsp; &nbsp; (revision 14605)<br />+++ package/broadcom-diag/src/diag.c&nbsp; &nbsp; (working copy)<br />@@ -910,9 +910,25 @@</p><p> static void register_buttons(struct button_t *b)<br /> {<br />-&nbsp; &nbsp; &nbsp; &nbsp;for (; b-&gt;name; b++)<br />+&nbsp; &nbsp; &nbsp; &nbsp;buttons = proc_mkdir(&quot;button&quot;, diag);<br />+&nbsp; &nbsp; &nbsp; &nbsp;if (!buttons)<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return;<br />+<br />+&nbsp; &nbsp; &nbsp; &nbsp;for (; b-&gt;name; b++) {<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;struct proc_dir_entry *p;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; platform.button_mask |= b-&gt;gpio;</p><p>+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (b-&gt;gpio &amp; gpiomask)<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;continue;<br />+<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if ((p = create_proc_entry(b-&gt;name, S_IRUSR, buttons))) {<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b-&gt;proc.type = PROC_BUTTON;<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b-&gt;proc.ptr = b;<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p-&gt;data = (void *) &amp;b-&gt;proc;<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p-&gt;proc_fops = &amp;diag_proc_fops;<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br />+&nbsp; &nbsp; &nbsp; &nbsp;}<br />+<br />&nbsp; &nbsp; &nbsp; &nbsp; platform.button_mask &amp;= ~gpiomask;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; gpio_outen(platform.button_mask, 0);<br />@@ -926,6 +942,9 @@</p><p> static void unregister_buttons(struct button_t *b)<br /> {<br />+&nbsp; &nbsp; &nbsp; &nbsp;for(; b-&gt;name; b++)<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;remove_proc_entry(b-&gt;name, buttons);<br />+<br />&nbsp; &nbsp; &nbsp; &nbsp; gpio_intmask(platform.button_mask, 0);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; gpio_set_irqenable(0, button_handler);<br />@@ -1179,6 +1198,12 @@<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;case PROC_BUTTON: {<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;struct button_t * button = (struct button_t *) handler-&gt;ptr;<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;u32 in = (gpio_in() &amp; button-&gt;gpio ? 1 : 0);<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;len = sprintf(page, &quot;%d\n&quot;, in);<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;break;<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case PROC_MODEL:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = sprintf(page, &quot;%s\n&quot;, platform.name);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />Index: package/broadcom-diag/src/diag.h<br />===================================================================<br />--- package/broadcom-diag/src/diag.h&nbsp; &nbsp; (revision 14605)<br />+++ package/broadcom-diag/src/diag.h&nbsp; &nbsp; (working copy)<br />@@ -125,7 +125,7 @@</p><p> /* proc */</p><p>-static struct proc_dir_entry *diag, *leds;<br />+static struct proc_dir_entry *diag, *leds, *buttons;</p><p> static ssize_t diag_proc_read(struct file *file, char *buf, size_t count, loff_t *ppos);<br /> static ssize_t diag_proc_write(struct file *file, const char *buf, size_t count, loff_t *ppos);</p><p>Already maked package(for broadcom 2.4 kernel): <a href="http://strelok-burn.narod.ru/kmod-diag_2.4.37.9-6_brcm-2.4.ipk">http://strelok-burn.narod.ru/kmod-diag_ â€¦ cm-2.4.ipk</a></p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>