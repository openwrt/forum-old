<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Multiuser Openwrt/luci</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 27 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=54593&amp;p=2.html">2</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p257784">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						15 Dec 2014, 22:19					</div>
				</div>
				<div class="post-content content">
					<p>I have implemented a multi-user setup for Openwrt/Luci. Not only does it provide multi user access, it also allows the root user to ..</p><p>- add/remove users <br />- select what group the user/s shall belong to<br />- choose whether or not the user/s should have ssh access<br />- choose what parts of the luci ui are available to the user on an individual basis</p><p>This can all be done from the luci ui by the root user <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p> I would like to release it as a luci module but there are a few issues that make adding it or more so removing it as a package difficult to obtain with out inconvenience. The main problem is that there is mods to the dispatcher.lua file, one to allow ALL system users to sign in and another to remove parts of the index from the ctx.tree . I have also moved some menus around in the ui layout (controllers) to accommodate the multi-user setup. So the problems are.. the menus would remain in the order i&#039;ve set for the multi-user setup ...which is not really a big deal. however the major problem is the luci-core and/or the luci-admin-full pkg&#039;s ( which ever one contains the dispatcher.lua file) would need to be removed and then reinstalled because the dispatcher.lua file would be removed with multi-user package.</p><br /><p>I would like to work with the developers on this to improve it a little and incorporate it into openwrt as a maintainable and convenient multi-user pkg for the openwrt/luci systems. The src code is available for those who wish to help</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p267303">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						1 Mar 2015, 22:27					</div>
				</div>
				<div class="post-content content">
					<p>bump ..bump&nbsp; I have a multi-user implimentation completed. I can add/remove users from the&nbsp; luci ui as well as set which menus the user can access, ssh permissions ..etc. The users can set their own password without effecting the root password from the ui and never has root access to the device. I would like to make a few improvments to it and possibly ad it as a ipk option for luci. The package no longer has any dependencies and with a few conditional statements added in the dispatcher, index and serviceclt can be added and removed with no negitive effects to the standard luci functionality.</p><p>I also have a pure lua ftp server i would like to possibly add as well, I could really use some constructive critism if Jow or any of the other devs would like to help out.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p267304">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						1 Mar 2015, 22:30					</div>
				</div>
				<div class="post-content content">
					<p>We could certainly add the required changes to the dispatcher to standard luci. I suggest to make a PR against openwrt/luci on Github, so we can discuss it there.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p267308">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						1 Mar 2015, 23:00					</div>
				</div>
				<div class="post-content content">
					<p>Ok sounds good jow. I will get things cleaned up and commented then add it to git this week. I look forward to working with you</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p267754">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						5 Mar 2015, 16:00					</div>
				</div>
				<div class="post-content content">
					<p>I have added the project to Github, here <a href="https://github.com/Hostle/openwrt-luci-multi-user">https://github.com/Hostle/openwrt-luci-multi-user</a> I only included the files pertaining to the project to make it easier to see what i have done so far. I commented the dispatcher.lua in regards to what i have added, comments are at the top of the file. The changes to servicectl.lua and index lua a pretty evident. It works fine for me, although the code is still a little rudimentary. I think it could be improved allot by utilizing cbi/uci to do allot more, however i am not so familiar with the functions available nor how to use them properly. If nothing else it serves as a great proof of concept, with a little polishing I think it should work pretty good.</p>											<p class="post-edited">(Last edited by <strong>hostle19</strong> on 5 Mar 2015, 16:01)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p269075">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">m_koziol</div>
					<div class="post-datetime">
						18 Mar 2015, 01:32					</div>
				</div>
				<div class="post-content content">
					<p>Hi, <br />I compiled your openwrt-luci-multi-user from github after the entry in the &quot;edit user&quot; I get the following error:<br /></p><div class="codebox"><pre><code>/usr/lib/lua/luci/dispatcher.lua:526: Failed to execute function dispatcher target for entry &#039;/admin/users&#039;.
The called action terminated with an exception:
/usr/lib/lua/luci/dispatcher.lua:526: Failed to execute cbi dispatcher target for entry &#039;/admin/users/users&#039;.
The called action terminated with an exception:
/usr/lib/lua/luci/cbi.lua:311: Unable to read UCI data: users
stack traceback:
    [C]: in function &#039;assert&#039;
    /usr/lib/lua/luci/dispatcher.lua:526: in function &#039;dispatch&#039;
    /usr/lib/lua/luci/dispatcher.lua:182: in function &lt;/usr/lib/lua/luci/dispatcher.lua:181&gt;</code></pre></div><p>You can ask for direction to solve the problem?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p269076">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						18 Mar 2015, 02:37					</div>
				</div>
				<div class="post-content content">
					<p>That error is telling you that the config file for the users module is missing. Just add an empty file &quot;/etc/config/users&quot; and it should work. Its strange that file is missing, you must have got the src before i was finished working on it. You should update the src and rebuild, i fix a few small bugs before i uploaded the complete package and you&#039;ll want the new src. I have added the src to the LuCI src so you can build it just as you would any luci pkg. Just add the feed and update then you will see the pkg in the menuconfig under LuCI &gt;&gt; Modules called &quot;admin-multi-user&quot;.</p><p>## LuCI 0.12 / 14.07 Barrier Breaker Branch ## <br />src-git luci <a href="https://github.com/Hostle/openwrt-luci-multi-user.git;luci-0.12">https://github.com/Hostle/openwrt-luci- … ;luci-0.12</a></p><p>or the development branch</p><p>## LuCI trunk / Chaos Calmer Branch ## <br />src-git luci <a href="https://github.com/Hostle/openwrt-luci-multi-user.git">https://github.com/Hostle/openwrt-luci-multi-user.git</a></p><p>just add the appropriate feed to your &quot;feeds.conf.default&quot; and then put a &quot;#&quot; in front of the original luci feed and then update the luci feed</p><p>./scripts/feeds update luci<br />./scripts/feeds install -a -p luci</p><p>then you should see the new pkg in the menuconfig under LuCI &gt;&gt; Modules &gt; admin-multi-user</p>											<p class="post-edited">(Last edited by <strong>hostle19</strong> on 18 Mar 2015, 03:32)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p269101">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">m_koziol</div>
					<div class="post-datetime">
						18 Mar 2015, 12:00					</div>
				</div>
				<div class="post-content content">
					<p>Thank you for your quick and substantial response. I complie BB rev. 44874 with openwrt-luci-multi-user built-in image.<br />touch /etc/config/users - solved the problem or mkdir -p files/etc/config and touch files/etc/config/users before compilation.</p><p>I still question whether there is a possibility to hide submenu eg. network -&gt; switch in some way?</p><p>There is a security problem;). If the user has a hidden menu system can still get to it by modifying the link, eg. /admin/system/startup.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p269124">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						18 Mar 2015, 16:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>m_koziol wrote:</cite><blockquote><p>Thank you for your quick and substantial response. I complie BB rev. 44874 with openwrt-luci-multi-user built-in image.<br />touch /etc/config/users - solved the problem or mkdir -p files/etc/config and touch files/etc/config/users before compilation.</p><p>I still question whether there is a possibility to hide submenu eg. network -&gt; switch in some way?</p><p>There is a security problem;). If the user has a hidden menu system can still get to it by modifying the link, eg. /admin/system/startup.</p></blockquote></div><p>I will look into why the config file is not being included in the build, that&#039;s strange.</p><p>To your question, I am hoping Jow or someone with more intimate knowledge of the dispatcher can point out a way to hide sub-menu&#039;s instead of removing the entire tree from the index.This is way I have not enable the option to hide sub-menus from the interface. For now the only option is to remove the entire tree from the index. I am sure there is away to ignore a sub menu and keep from adding it to the tree but I just haven&#039;t found it yet <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> time has been limited lately so when i get some free time I will look into it further. </p><p>Just to clarify, you are not able to access a sub-menu of a menu you have checked as hidden in the user configuration ? you are trying to add them in manually to the dispatcher like remove_idx(ctx.tree, &quot;startup&quot;)... correct ?</p>											<p class="post-edited">(Last edited by <strong>hostle19</strong> on 18 Mar 2015, 16:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p291639">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						13 Sep 2015, 16:56					</div>
				</div>
				<div class="post-content content">
					<p>I have added the ability to hide sub menus and fixed the direct url access so that when a menu is hidden it CAN NOT be accessed by using the url directly as suggested in the previous post. One last thing to do is to enable hiding the top layer of the menus without disabling the sub menu&#039;s from that section as well... Status, System ..etc. </p><p>@Jow .. I know your a busy man but I would love some productive criticism or even just criticism so I can move toward adding this to luci for all members to benefit from.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p294422">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						3 Oct 2015, 04:33					</div>
				</div>
				<div class="post-content content">
					<p>I have finished and tested the code. As far as I am concerned I have completed a full blown multi-user setup for luci/openwrt. I have added the ability to hide ANY menu from ANY non root user ... finally <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p><strong>Available Features</strong><br />- add/remove users from the luci ui<br />- set ssh access to on or off on a per user basis<br />- set user type to user(basic ssh permissions) or admin(elevated ssh permissions)&nbsp; per user basis<br />- set what luci ui menus options are visible and available for new users on a per user basis<br />- initial password for new users is openwrt, users can set there own password once logged in</p><p><strong>Build Instructions</strong><br /><span style="color: blue">Just add the feed and update then you will see the pkg in the menuconfig under LuCI &gt;&gt; Modules called &quot;admin-multi-user&quot;.</span></p><p><span style="color: #FF0000">## LuCI 0.12 / 14.07 Barrier Breaker Branch ##<br /></span><span style="color: blue">src-git luci <a href="https://github.com/Hostle/openwrt-luci-multi-user.git;luci-0.12">https://github.com/Hostle/openwrt-luci- … ;luci-0.12</a></span></p><p>or the development branch<br /><span style="color: #FF0000">## LuCI trunk / Chaos Calmer Branch ##</span><br /><span style="color: blue">src-git luci <a href="https://github.com/Hostle/openwrt-luci-multi-user.git">https://github.com/Hostle/openwrt-luci-multi-user.git</a></span></p><p>just add the appropriate feed to your &quot;feeds.conf.default&quot; and then put a &quot;#&quot; in front of the original luci feed and then update the luci feed</p><p><span style="color: #FF0000">./scripts/feeds update luci<br />./scripts/feeds install -a -p luci</span></p><p>then you should see the new pkg in the menuconfig under LuCI &gt;&gt; Modules &gt; admin-multi-user</p><br /><p>The mods to the luci src are minimal, and luci functions fine when package is removed. Aside for the code added I have to rename a few files in the luasrc in the admin-full and admin-base but again this does not effect luci functionality . I think this could easily be pushed to the luci src and become a valuable tool in which the openwrt community could really benefit from. I have my own respo set up were the code can be fetched and built but ultimately I would like to see it become part of the luci repository or at least have the necessary changes made to the luci src to accommodate the multi-user package.</p>											<p class="post-edited">(Last edited by <strong>hostle19</strong> on 3 Oct 2015, 04:49)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p301265">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">stepheng</div>
					<div class="post-datetime">
						26 Nov 2015, 05:39					</div>
				</div>
				<div class="post-content content">
					<p>As there been any progress in getting a patch integrated into the trunk? I&#039;ve tried the implementation and it&#039;s been working great.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p301474">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						27 Nov 2015, 19:40					</div>
				</div>
				<div class="post-content content">
					<p>Unfortunately not, I have added the git respo as requested by Jow but I&nbsp; have not had any sort of input from him or any other developers. It needs a little work before a patch or package can be made that would allow a seamless installation/removal process. I would bet Jow or any other luci developer could work it in very quickly, but sadly they seem to be too busy to take a look <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306730">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">cocha1</div>
					<div class="post-datetime">
						8 Jan 2016, 17:21					</div>
				</div>
				<div class="post-content content">
					<p>Hi hostle seems you make my day, i was looking for a luci multiuser interface solution, your solution seems to fit perfectly to my needs, can i count on you to some support during my test?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p306731">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						8 Jan 2016, 17:25					</div>
				</div>
				<div class="post-content content">
					<p>absolutely, you can always get a hold on me at my my new site --&gt; <a href="http://fire-wrt.com/forums/forum.php">http://fire-wrt.com/forums/forum.php</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307475">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						13 Jan 2016, 13:13					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jow wrote:</cite><blockquote><p>We could certainly add the required changes to the dispatcher to standard luci. I suggest to make a PR against openwrt/luci on Github, so we can discuss it there.</p></blockquote></div><div class="quotebox"><cite>hostle19 wrote:</cite><blockquote><p>Unfortunately not, I have added the git respo as requested by Jow but I&nbsp; have not had any sort of input from him or any other developers. It needs a little work before a patch or package can be made that would allow a seamless installation/removal process.</p></blockquote></div><p>Well, actually Jow asked for a Pull Request against the current Luci trunk.<br /><a href="https://github.com/openwrt/luci/pulls">https://github.com/openwrt/luci/pulls</a></p><p>Your github repo is nice, but as it seems to contain Luci from March 2015 plus your changes, it is not very practical to try use that for any merge, as it is too hard to figure out the differences to the current trunk.</p><p>The repo where you develop, should be a &quot;fork&quot; from Luci trunk, so that a pull request can be made easily.</p><p>You should also use git rebase to squash some of your 60 commits as they edit the same files back and forth, reflecting your development process.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307486">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						13 Jan 2016, 14:47					</div>
				</div>
				<div class="post-content content">
					<p>I cloned your github repo and tried to figure out the changes.<br />Below is the summary based on diff against last existing commit before your changes:<br /></p><div class="codebox"><pre><code>perus@ub1510:/Openwrt/github/multiuser$ git diff  --stat 4ab6dce .
 README.md                                                                  |   7 +
 modules/luci-base/luasrc/controller/admin/servicectl.lua                   |  19 +-
 modules/luci-base/luasrc/dispatcher.lua                                    | 155 ++++++++++++-
 modules/luci-mod-admin-full/luasrc/controller/admin/index.lua              |  18 +-
 modules/luci-mod-admin-full/luasrc/controller/admin/network.lua            |   8 +-
 modules/luci-mod-admin-full/luasrc/controller/admin/system.lua             |   4 +-
 modules/luci-mod-admin-full/luasrc/model/cbi/admin_network/iface_add.lua   |   4 +-
 modules/luci-mod-admin-full/luasrc/model/cbi/admin_network/netroutes.lua   |  74 +++++++
 modules/luci-mod-admin-full/luasrc/model/cbi/admin_network/network.lua     |  71 ------
 modules/luci-mod-admin-full/luasrc/model/cbi/admin_network/network_tab.lua |  71 ++++++
 modules/luci-mod-admin-full/luasrc/model/cbi/admin_network/routes.lua      |  74 -------
 modules/luci-mod-admin-full/luasrc/model/cbi/admin_system/admin.lua        | 119 ----------
 modules/luci-mod-admin-full/luasrc/model/cbi/admin_system/admins.lua       | 119 ++++++++++
 modules/luci-mod-admin-full/luasrc/model/cbi/admin_system/system.lua       | 216 -------------------
 modules/luci-mod-admin-full/luasrc/model/cbi/admin_system/system_tab.lua   | 216 +++++++++++++++++++
 modules/luci-mod-admin-full/luasrc/view/admin_network/iface_overview.htm   |   4 +-
 modules/luci-mod-admin-multi-user/Makefile                                 |  10 +
 modules/luci-mod-admin-multi-user/luasrc/controller/admin/users.lua        |  53 +++++
 modules/luci-mod-admin-multi-user/luasrc/model/cbi/admin_users/passwd.lua  |  58 +++++
 modules/luci-mod-admin-multi-user/luasrc/model/cbi/admin_users/users.lua   | 113 ++++++++++
 modules/luci-mod-admin-multi-user/luasrc/users.lua                         | 552 +++++++++++++++++++++++++++++++++++++++++++++++
 modules/luci-mod-admin-multi-user/root/etc/uci-defaults/09_users           |  12 ++
 themes/luci-theme-bootstrap/luasrc/view/themes/bootstrap/header.htm        |   2 +-
 themes/luci-theme-openwrt/luasrc/view/themes/openwrt.org/header.htm        |   2 +-
 24 files changed, 1484 insertions(+), 497 deletions(-)</code></pre></div><p>Based on that and on &quot;git diff 4ab6dce .&quot; I see roughly four different kind of changes:<br />1) renames of existing modules (network, routes, admin, system) and the fallout from that (themes, controller)<br />2) changes affecting the base (dispatcher, servicectl.lua and index.lua)<br />3) new multiuser module in luci-mod-admin-multi-user<br />4) documentation changes at README<br />(plus some unnecessary white space changes)</p><p>Are all the renames really necessary? Necessary in order to avoid some duplication in module paths?</p><p>I also think that the multiuser module might be a luci-application instead of a luci-module. As base files would be edited, the required generic changes (renames , changes to base) would be included already in the default luci, so to me it makes no sense to define this as an alternative to the normal luci. Instead the additional multiuser stuff looks like an add-on application (like statistics, DDNS etc.).</p><p>If you would like to get this included in Luci proper, I suggest that you<br />1) fork a new repo from Luci trunk<br />2) apply the changes in probably three logical commits (renames &amp; related fallout, changes to base, new module) and clearly explain the reasoning in commit messages.<br />&nbsp; &nbsp; (and skip the changes of documentation to include links to screenshots etc.)<br />&nbsp; &nbsp; (skip also the extensive copyright/comments block in uci-defaults file that quadruples the size of that file)<br />3) create a Pull Request at Luci github</p><p>Using &quot;git diff 4ab6dce . &gt; multi.patch&quot; it should be rather straightforward to create a patch for Luci in order to create the new commits.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307508">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						13 Jan 2016, 17:08					</div>
				</div>
				<div class="post-content content">
					<p>Well, I did a trial import to trunk myself and also compiled and flashed it to trunk ar71xx/WNDR3700 router.</p><p>It seems to work, with some minor glitches (although &quot;network&quot; is disabled for an user, it is visible but no page can be opened from it, so the restriction seems to work).</p><p>I used a clone of your repo and &quot;git diff 4ab6dce . &quot; to create a patch file.<br />Then I did the 4 file renames manually and removed those actions from the patch file.<br />Then I tried applying the remaining patch, and it almost succeeded. Only 2-3 minor edits needed for changes done in trunk code since March 2015.<br />I also modified the new &quot;material&quot; theme, simplified the uci-defaults file and discarded the changes to readme file.<br />And I moved the new stuff from luci-modules to luci-applications.</p><p>I committed the changes in three commits, as I proposed in the previous message.<br /><a href="https://github.com/hnyman/luci/commits/multiuser">https://github.com/hnyman/luci/commits/multiuser</a></p><p>Downloadable links to the three patches for Luci trunk (as of 13 Jan 16):<br /><a href="https://github.com/hnyman/luci/commit/81de5e1329b4acf5ace5508dd15df60d7ea9050b.patch">https://github.com/hnyman/luci/commit/8 … 050b.patch</a><br /><a href="https://github.com/hnyman/luci/commit/3e1e035913623e2055948d15090af263cf8dd7e0.patch">https://github.com/hnyman/luci/commit/3 … d7e0.patch</a><br /><a href="https://github.com/hnyman/luci/commit/116c05402718b3d4956388251a7ca679f5a69011.patch">https://github.com/hnyman/luci/commit/1 … 9011.patch</a></p><p>At the first glance, I don&#039;t like the hard-coded permitted page/leaf names for status, system and network tabs in users.lua. That makes it more difficult in the long run to adapt into changes in core Luci.</p><p>Some of the changes, especially the renames to ensure unique names for pages/leafs, could probably be committed into the core luci right away. (although the page/leaf name names might be slightly tweaked first)</p><p>Parts of the code (user management page?) might need to be modified due to the recent link vs. CSRF token change). I did not try to check those aspects.</p><p>Also the copyright headers in the new module could be shortened (as was done by <a href="https://github.com/openwrt/luci/commit/7a3493b1f7d75a3945279115324cf2ff4da26b7b">https://github.com/openwrt/luci/commit/ … ff4da26b7b</a> a year ago )</p><p>I think that I will open a pull request about this for discussion purposes, so that Jow &amp; others can participate and comment directly the code. Or will you do that?</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 13 Jan 2016, 17:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307516">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						13 Jan 2016, 18:19					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>hnyman wrote:</cite><blockquote><p>Well, I did a trial import to trunk myself and also compiled and flashed it to trunk ar71xx/WNDR3700 router.</p><p>I think that I will open a pull request about this for discussion purposes, so that Jow &amp; others can participate and comment directly the code. Or will you do that?</p></blockquote></div><p>If you could do that that would be great, you seem to have much more experience using git then I do. I basically just threw this together for proof of concept, I think if could be improved a lot before actually being implemented into Luci. Also, just this past weekend I decided to make some changes to try and simplify things. The new method has far fewer moving parts and is much less invasive to the luci src. Basically I got rid of most of the modifications to the dispatcher.lua and the need for renaming.I did this by adding simple checks to determine if the user has privileges to use each index entry in the index() function of each controller. </p><div class="codebox"><pre><code>\-- Copyright 2008 Steven Barth &lt;steven@midlink.org&gt;
-- Copyright 2011 Jo-Philipp Wich &lt;jow@openwrt.org&gt;
-- Licensed to the public under the Apache License 2.0.

module(&quot;luci.controller.admin.status&quot;, package.seeall)


function index()
    local fs = require &quot;nixio.fs&quot;

         function user(val)
       if not fs.access(&quot;/usr/lib/lua/luci/users.lua&quot;) then return true end

           local dsp = require &quot;luci.dispatcher&quot;
           local usw = require &quot;luci.users&quot;
           local user = dsp.get_user()
       if user == &quot;root&quot; then return true end
           local name = &quot;status&quot;

       local menu = {}
       menu = usw.hide_menus(user,name) or {}

         for i,v in pairs(menu) do
            if v == val then return true end
         end
         return false
      end

      entry({&quot;admin&quot;, &quot;status&quot;}, alias(&quot;admin&quot;, &quot;status&quot;, &quot;overview&quot;), _(&quot;Status&quot;), 20).index = true
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;overview&quot;}, template(&quot;admin_status/index&quot;), _(&quot;Overview&quot;), 1)

if user(&quot;Firewall&quot;) == true then
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;iptables&quot;}, call(&quot;action_iptables&quot;), _(&quot;Firewall&quot;), 2).leaf = true
    end
if user(&quot;Routes&quot;) == true then
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;routes&quot;}, template(&quot;admin_status/routes&quot;), _(&quot;Routes&quot;), 3)
    end
if user(&quot;System_log&quot;) == true then
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;syslog&quot;}, call(&quot;action_syslog&quot;), _(&quot;System Log&quot;), 4)
    end
if user(&quot;Kernel_log&quot;) == true then
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;dmesg&quot;}, call(&quot;action_dmesg&quot;), _(&quot;Kernel Log&quot;), 5)
    end
if user(&quot;Processes&quot;) == true then
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;processes&quot;}, cbi(&quot;admin_status/processes&quot;), _(&quot;Processes&quot;), 6)
    end
if user(&quot;Realtime_graphs&quot;) == true then
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;}, alias(&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;, &quot;load&quot;), _(&quot;Realtime Graphs&quot;), 7)
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;, &quot;load&quot;}, template(&quot;admin_status/load&quot;), _(&quot;Load&quot;), 1).leaf = true
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;, &quot;load_status&quot;}, call(&quot;action_load&quot;)).leaf = true
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;, &quot;bandwidth&quot;}, template(&quot;admin_status/bandwidth&quot;), _(&quot;Traffic&quot;), 2).leaf = true
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;, &quot;bandwidth_status&quot;}, call(&quot;action_bandwidth&quot;)).leaf = true
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;, &quot;wireless&quot;}, template(&quot;admin_status/wireless&quot;), _(&quot;Wireless&quot;), 3).leaf = true
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;, &quot;wireless_status&quot;}, call(&quot;action_wireless&quot;)).leaf = true
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;, &quot;connections&quot;}, template(&quot;admin_status/connections&quot;), _(&quot;Connections&quot;), 4).leaf = true
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;realtime&quot;, &quot;connections_status&quot;}, call(&quot;action_connections&quot;)).leaf = true
      entry({&quot;admin&quot;, &quot;status&quot;, &quot;nameinfo&quot;}, call(&quot;action_nameinfo&quot;)).leaf = true
    end
end</code></pre></div><p>It is functional and working great though I am still finishing the up a couple last things, I hope to have it completed today, once I finish you can do a diff on it, I think it should merge much nicer then the original version.</p>											<p class="post-edited">(Last edited by <strong>hostle19</strong> on 13 Jan 2016, 18:21)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307549">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						14 Jan 2016, 00:23					</div>
				</div>
				<div class="post-content content">
					<p>Ok i have finished the new version, in my opinion its a much better approach. I have added measures to prevent empty main tabs as you mentioned in your post above. I also moved the package to applications and added more accurate and precise comments. I created a new fork of luci from today and added the commits to it. The new fork can be found here --&gt; <a href="https://github.com/Hostle/luci.git">https://github.com/Hostle/luci.git</a></p><p>I think you&#039;ll find it is much cleaner and it should merge much better. There is still a few more things I would like to see before it is fully committed into luci&nbsp; ...</p><p>1. a nicer interface for the &quot;Edit Users&quot; I was thinking of laying it out like the &quot;Interfaces&quot; pages where the current users are listed with buttons to edit or remove them.</p><p>2. the &quot;luci.users&quot; module needs to be optimized and better error checking implemented.</p><p>3. Perhaps deeper permission options for ssh privileges.</p><p>I am sure Jow and the others can whip this into shape pretty quick, I am back in schoool now but I will do my best to contribute what and when I can.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307591">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						14 Jan 2016, 12:43					</div>
				</div>
				<div class="post-content content">
					<p>Thanks. I quickly browsed the new version, but didn&#039;t try to compile, yet.</p><p>A few observations: I think that you have copied files from CC15.05 to trunk Luci without noticing that the function calls have changed between CC and trunk. That will break things.</p><p>E.g. regarding &quot;network&quot; tab, you have undone <a href="https://github.com/Hostle/luci/commit/8bb749ecc3b5f7f836f744f0056e90ac78522926">https://github.com/Hostle/luci/commit/8 … ac78522926</a> in <a href="https://github.com/Hostle/luci/commit/e041a6417aef2f12427bccac15803f86868cac13">https://github.com/Hostle/luci/commit/e … 86868cac13</a> by erroneously changing the &quot;post&quot; back to &quot;call&quot;.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307599">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						14 Jan 2016, 14:08					</div>
				</div>
				<div class="post-content content">
					<p>I imported your new repo to my own luci repo at github and used editor &amp; git to polish it a bit.<br />* I reverted the invalid call/post changes (CC15 vs. trunk code).<br />* I removed your additional indenting of menu items to minimize the change delta. (that makes the code a bit less clear to read, but makes it much more clear to see the changes at github now in discussion phase)<br />* I also removed unnecessary whitespace changes to avoid clutter of changes</p><p>The &quot;polished&quot; output is here:<br /><a href="https://github.com/hnyman/luci/commits/multi2">https://github.com/hnyman/luci/commits/multi2</a></p><p>I have not yet tried to compile it, but will do that.</p><p>EDIT&nbsp; in Feb 2016:<br />current update branch is &quot;multi3&quot;<br /><a href="https://github.com/hnyman/luci/commits/multi3">https://github.com/hnyman/luci/commits/multi3</a></p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 23 Feb 2016, 17:48)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307611">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						14 Jan 2016, 15:32					</div>
				</div>
				<div class="post-content content">
					<p>yes, I stand corrected on all counts <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> great work</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307633">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">hnyman</div>
					<div class="post-datetime">
						14 Jan 2016, 18:45					</div>
				</div>
				<div class="post-content content">
					<p>I opened a disccussion about this at Luci github.<br /><a href="https://github.com/openwrt/luci/issues/623">https://github.com/openwrt/luci/issues/623</a></p><p>If you want to try the multi-user code with your DD trunk build, you can easily add my Luci repo as a remote to your own git and then pull from &quot;multi2&quot; branch. I used these commands to import this to my own Openwrt build. (I also created a new branch &quot;multiuser&quot; at my local feed repo so that I easily push the changes aside and return to normal default Luci by &quot;git checkout master&quot;):<br /></p><div class="codebox"><pre><code> cd feeds/luci
 git checkout -b multiuser
 git remote add hnyman https://github.com/hnyman/luci.git
 git pull hnyman multi2
 git log --oneline</code></pre></div><p>The multi2 branch contains up-to-date Luci of 11 Jan 2016 for DD trunk + the multi-user commits.</p>											<p class="post-edited">(Last edited by <strong>hnyman</strong> on 14 Jan 2016, 20:32)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307640">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">hostle19</div>
					<div class="post-datetime">
						14 Jan 2016, 20:20					</div>
				</div>
				<div class="post-content content">
					<p>Perfect, thanks hynman</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=54593&amp;p=2.html">2</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>