<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> mwan3; multi-wan policy routing (general topic)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 22 May 2013 and 6 May 2018.
										Unfortunately there are posts â€“ most likely complete pages â€“ missing.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 34 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=32.html">32</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=33.html">33</a></li><li class="pagination-current"><span>34</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=35.html">35</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=36.html">36</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p238777">
				<div class="post-metadata">
					<div class="post-num">Post #826</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						2 Jul 2014, 00:13					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>On a sdie note: I see that you use custom route table 220. This can be a problem as mwan3 might wipe this table when it&#039;s stopped. If you use a number higher then 255 you should be fine...</p></blockquote></div><p>StrongSwan uses route table 220 for VPN routes by default. Perhaps Mwan3 could be made to use higher numbers?</p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 2 Jul 2014, 00:14)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238844">
				<div class="post-metadata">
					<div class="post-num">Post #827</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						2 Jul 2014, 12:07					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>arfett wrote:</cite><blockquote><p>StrongSwan uses route table 220 for VPN routes by default. Perhaps Mwan3 could be made to use higher numbers?</p></blockquote></div><p>Looking back, i can see that it has only impact if you use 220 or more wan interfaces. I guess it safe to say that this risc is minimal...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238895">
				<div class="post-metadata">
					<div class="post-num">Post #828</div>
					<div class="post-author">thiagoc</div>
					<div class="post-datetime">
						2 Jul 2014, 16:52					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze.</p><p>Thanks for this package in the first place.</p><p>On the wiki page there is the follow statement:</p><div class="quotebox"><blockquote><p>If you have a traffic rule that matches a policy, but all the members (interfaces) for that policy are down, it will not match any mwan3 ip rule. Therefore, it will use the main routing table to determine which interface to use.</p></blockquote></div><p>I have 2 rules (tcp and udp) for port 53 (DNS) that I want to redirect just to wan2, but when this interface is down it doesn&#039;t redirect to the default route. I&#039;m testing with traffic originating from the router. Now I&#039;m using the rule wan2_wan and it&#039;s working, but this confused me.</p><p>Here&#039;s my config: <a href="http://pastebin.com/raw.php?i=7Vv12Bvm">http://pastebin.com/raw.php?i=7Vv12Bvm</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238897">
				<div class="post-metadata">
					<div class="post-num">Post #829</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						2 Jul 2014, 17:11					</div>
				</div>
				<div class="post-content content">
					<p>Hi thiagoc,</p><br /><p>I see the confusion. The wiki statement was correct for version 1.3 and earlier. In version 1.4 i replaced this behaviour to unreachable.</p><p>So&nbsp; to summarize: if all members in a policy are down, the exit strategy for that policy is &quot;unreachable&quot;.</p><br /><p>Grtz Adze</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238944">
				<div class="post-metadata">
					<div class="post-num">Post #830</div>
					<div class="post-author">thiagoc</div>
					<div class="post-datetime">
						2 Jul 2014, 22:01					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>I see the confusion. The wiki statement was correct for version 1.3 and earlier. In version 1.4 i replaced this behaviour to unreachable.<br />So&nbsp; to summarize: if all members in a policy are down, the exit strategy for that policy is &quot;unreachable&quot;.</p></blockquote></div><p>OK Adze, I have updated the wiki if you don&#039;t mind.</p><p>Thanks.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p238953">
				<div class="post-metadata">
					<div class="post-num">Post #831</div>
					<div class="post-author">ValdikSS</div>
					<div class="post-datetime">
						2 Jul 2014, 23:10					</div>
				</div>
				<div class="post-content content">
					<p>Hello guys.<br />Thanks for this great script!<br />I need your help. I have 2 WANs and I need to forward traffic from one IP from WAN1 subnet with masquerading. It works perfectly fine without mwan3 with hand-made policy routing scripts, but when I configure mwan3, it wan&#039;t forward traffic from that WAN1 IP anymore.<br />I don&#039;t use any load balancing and even failover, just some policy rules.<br />All I can see in tcpdump is that some traffic does forward (TCP packets on high ports) but on any ICMP or UDP traffic my router sends ICMP Unreachable. WAN forwarding is configured to be accepted by iptables.</p><p>I tried to add WAN subnet to table 1, but that didn&#039;t change a thing.<br />Here is tcpdump log<br /><a href="https://gist.github.com/ValdikSS/fcd5e8c4f4dc564e53cd">https://gist.github.com/ValdikSS/fcd5e8c4f4dc564e53cd</a></p><p>Here is troubleshooting data<br /><a href="https://gist.github.com/ValdikSS/d027b596fd3db087e699">https://gist.github.com/ValdikSS/d027b596fd3db087e699</a></p><p>My ip is 92.xx.xx.58, IP which I should forward is 92.xx.xx.7</p>											<p class="post-edited">(Last edited by <strong>ValdikSS</strong> on 2 Jul 2014, 23:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239021">
				<div class="post-metadata">
					<div class="post-num">Post #832</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						3 Jul 2014, 10:32					</div>
				</div>
				<div class="post-content content">
					<p>Hi ValdikSS,</p><p>I&#039;m not quit sure what you want to achieve. Maybe you could paste your hand-made routing script, so i can see what you mean?</p><p>Thnx</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239172">
				<div class="post-metadata">
					<div class="post-num">Post #833</div>
					<div class="post-author">ValdikSS</div>
					<div class="post-datetime">
						3 Jul 2014, 19:59					</div>
				</div>
				<div class="post-content content">
					<p>Adze, I just need:<br />1) Proper multiwan routing. I have WAN and VPN connection. I need WAN INPUT replies to go via WAN OUTPUT, and VPN INPUT to VPN OUTPUT. Without policy routing, if I have default gateway via VPN, WAN INPUT replies would go via VPN, which is not what I want.<br />2) Forward WAN to WAN for one WAN IP address. I want to be a gateway for one client in WAN subnet.</p><p>I can achieve this by creating new &quot;novpn&quot; routing table, copying everything from main table to novpn, replacing default gateway in novpn table from VPN gateway to WAN gateway and configuring some rules for policy routing and traffic marking.<br />I did this by writing my own interface hook script. I wanted to get rid of it and to use mwan3, because it has luci plugin, and everything works as good as with my scripts, but WAN-to-WAN forwarding is not working at all.</p><p>How to reproduce:<br />1) Connect switch to WAN interface, plug in it ISP cable and another PC (let&#039;s call it PC2) cable<br />2) Configure router to masquerade traffic to WAN. Enable WAN-to-WAN forwarding in firewall configuration.<br />3) Configure PC2 to use our router IP on WAN interface as a default gateway</p><p>Expected result:<br />PC2 can access websites.</p><p>Actual result:<br />PC2 can&#039;t access websites.</p><p>TL;DR: I need not only LAN-to-WAN or LAN-to-VPN forwarding with masquerading, but also WAN-to-WAN forwarding with masquerading, which doesn&#039;t work with mwan3 enabled, but works without mwan3.</p>											<p class="post-edited">(Last edited by <strong>ValdikSS</strong> on 3 Jul 2014, 20:05)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239190">
				<div class="post-metadata">
					<div class="post-num">Post #834</div>
					<div class="post-author">ValdikSS</div>
					<div class="post-datetime">
						3 Jul 2014, 21:18					</div>
				</div>
				<div class="post-content content">
					<p>Uninstalled mwan3, installed multiwan. Multiwan works as expected, so this may be mwan3 bug, or I misconfigured something, but I can&#039;t find what exactly.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239201">
				<div class="post-metadata">
					<div class="post-num">Post #835</div>
					<div class="post-author">JoiNNN</div>
					<div class="post-datetime">
						3 Jul 2014, 22:23					</div>
				</div>
				<div class="post-content content">
					<p>Hello there,<br />I have an issue that might not even be related to this great script (thank you btw) but I have to ask. I&#039;ve been trying connect two wireless connections in repeater mode and then use mwan3 to switch between them if any fail at any time.<br />So I have created the following WiFi connections, all on separate Interfaces:<br /><strong>SSID: OpenWRT</strong> - used to connect to the router<br /><strong>SSID: &lt;RandomSSID1&gt;</strong> - running on channel 11 (dunno if it matters whether they run on different channels)<br /><strong>SSID: &lt;RandomSSID2&gt;</strong> - running on channel 1<br />However while mwan3 seems to work just OK after I add the second (RandomSSID2) wireless connection or if both (RandomSSID1 and RandomSSID2) wireless connections are Enabled at the same time the main connection (OpenWRT) disappears and I&#039;m no longer able to connect to it.<br />So does the router need multi-SSID support for this kind of use or I&#039;m doing something wrong?<br />The router is an <a href="http://wiki.openwrt.org/toh/huawei/hg556a">Huawei HG556a</a>.<br />Thank you for your time.</p>											<p class="post-edited">(Last edited by <strong>JoiNNN</strong> on 3 Jul 2014, 22:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239259">
				<div class="post-metadata">
					<div class="post-num">Post #836</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						4 Jul 2014, 10:42					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ValdikSS wrote:</cite><blockquote><p>How to reproduce:<br />1) Connect switch to WAN interface, plug in it ISP cable and another PC (let&#039;s call it PC2) cable<br />2) Configure router to masquerade traffic to WAN. Enable WAN-to-WAN forwarding in firewall configuration.<br />3) Configure PC2 to use our router IP on WAN interface as a default gateway</p><p>Expected result:<br />PC2 can access websites.</p><p>Actual result:<br />PC2 can&#039;t access websites.</p><p>TL;DR: I need not only LAN-to-WAN or LAN-to-VPN forwarding with masquerading, but also WAN-to-WAN forwarding with masquerading, which doesn&#039;t work with mwan3 enabled, but works without mwan3.</p></blockquote></div><p>Ah, i now know what you mean. Short answer is that mwan3 does not support that without some extra ip rules. Mwan3 has a policy that all packets incomming from wan interfaces are routed via the main routing table (ip rules 1001 to 1250). If you want a different routing policy for PC2 you wil have to add a custom ip rule before rule 1000.</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 4 Jul 2014, 10:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239267">
				<div class="post-metadata">
					<div class="post-num">Post #837</div>
					<div class="post-author">ligf731</div>
					<div class="post-datetime">
						4 Jul 2014, 12:15					</div>
				</div>
				<div class="post-content content">
					<p>How should I configureï¼ŒI need the following rulesï¼š<br />#create a new chain named SHADOWSOCKS<br />iptables -t nat -N SHADOWSOCKS</p><p>#Redirect what you want</p><p>#Google<br />iptables -t nat -A SHADOWSOCKS -p tcp -d 74.125.0.0/16 -j REDIRECT --to-ports 1080<br />iptables -t nat -A SHADOWSOCKS -p tcp -d 173.194.0.0/16 -j REDIRECT --to-ports 1080</p><p>#Youtube<br />iptables -t nat -A SHADOWSOCKS -p tcp -d 208.117.224.0/19 -j REDIRECT --to-ports 1080<br />iptables -t nat -A SHADOWSOCKS -p tcp -d 209.85.128.0/17 -j REDIRECT --to-ports 1080</p><p>#Twitter<br />iptables -t nat -A SHADOWSOCKS -p tcp -d 199.59.148.0/22 -j REDIRECT --to-ports 1080</p><p>#Shadowsocks.org<br />iptables -t nat -A SHADOWSOCKS -p tcp -d 199.27.76.133/32 -j REDIRECT --to-ports 1080</p><p>#1024<br />iptables -t nat -A SHADOWSOCKS -p tcp -d 184.154.128.246/32 -j REDIRECT --to-ports 1080</p><p>#Anything else should be ignore<br />iptables -t nat -A SHADOWSOCKS -p tcp -j RETURN</p><p># Apply the rules<br />iptables -t nat -A PREROUTING -p tcp -j SHADOWSOCKS</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239268">
				<div class="post-metadata">
					<div class="post-num">Post #838</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						4 Jul 2014, 12:39					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>ligf731 wrote:</cite><blockquote><p>How should I configureï¼ŒI need the following rulesï¼š</p></blockquote></div><p>Just like you posted... Mwan3 does nothing with/to NAT.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239284">
				<div class="post-metadata">
					<div class="post-num">Post #839</div>
					<div class="post-author">JoiNNN</div>
					<div class="post-datetime">
						4 Jul 2014, 15:39					</div>
				</div>
				<div class="post-content content">
					<p>Any idea on my issue posted above? Any input is appreciated.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239291">
				<div class="post-metadata">
					<div class="post-num">Post #840</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						4 Jul 2014, 17:06					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>JoiNNN wrote:</cite><blockquote><p>Any idea on my issue posted above? Any input is appreciated.</p></blockquote></div><br /><p>I read you want it repeated. With repeated, do you mean bridged? If yes, then this wont work, as mwan3 works at routing layer. If not, could you paste your config etc etc..</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 4 Jul 2014, 17:06)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239300">
				<div class="post-metadata">
					<div class="post-num">Post #841</div>
					<div class="post-author">JoiNNN</div>
					<div class="post-datetime">
						4 Jul 2014, 18:33					</div>
				</div>
				<div class="post-content content">
					<p><em>Keep in mind that I can only access the router only via web interface, for whatever reason I can&#039;t telnet the router.</em><br />I&#039;m only bridging the LAN over OpenWRT, which is shown as being <strong>Master</strong> since is set as <strong>Access Point</strong>, the other two are set as <strong>Client</strong>s and are displayed as such.<br />If you know another way of doing this or if you are aware whether it&#039;s possible or not to do this, please let me know.<br />Thanks for looking into this.</p><p>Here is the output from <strong>MWAN3 &gt; Advanced &gt; Troubleshooting</strong><br /></p><div class="codebox"><pre><code>Software versions : 

OpenWrt - OpenWrt Barrier Breaker r40006
LuCI - svn-r9961

mwan3 - 1.4-20
luci-app-mwan3 - 1.2-19

Output of &quot;cat /etc/config/mwan3&quot; : 

config interface &#039;wan&#039;
    option enabled &#039;1&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;
    list track_ip &#039;208.67.222.222&#039;
    list track_ip &#039;208.67.220.220&#039;
    option reliability &#039;1&#039;

config interface &#039;wan2&#039;
    list track_ip &#039;8.8.8.8&#039;
    list track_ip &#039;208.67.220.220&#039;
    option reliability &#039;1&#039;
    option count &#039;1&#039;
    option timeout &#039;2&#039;
    option interval &#039;5&#039;
    option down &#039;3&#039;
    option up &#039;8&#039;
    option enabled &#039;1&#039;

config member &#039;wan_m1_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;1&#039;
    option weight &#039;3&#039;

config member &#039;wan_m2_w3&#039;
    option interface &#039;wan&#039;
    option metric &#039;2&#039;
    option weight &#039;3&#039;

config member &#039;wan2_m1_w2&#039;
    option interface &#039;wan2&#039;
    option metric &#039;1&#039;
    option weight &#039;2&#039;

config member &#039;wan2_m2_w2&#039;
    option interface &#039;wan2&#039;
    option metric &#039;2&#039;
    option weight &#039;2&#039;

config policy &#039;wan_only&#039;
    list use_member &#039;wan_m1_w3&#039;

config policy &#039;wan2_only&#039;
    list use_member &#039;wan2_m1_w2&#039;

config policy &#039;balanced&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;wan2_m1_w2&#039;

config policy &#039;wan_wan2&#039;
    list use_member &#039;wan_m1_w3&#039;
    list use_member &#039;wan2_m2_w2&#039;

config policy &#039;wan2_wan&#039;
    list use_member &#039;wan_m2_w3&#039;
    list use_member &#039;wan2_m1_w2&#039;

config rule &#039;sticky_even&#039;
    option src_ip &#039;0.0.0.0/0.0.0.1&#039;
    option dest_port &#039;443&#039;
    option proto &#039;tcp&#039;
    option use_policy &#039;wan_wan2&#039;

config rule &#039;sticky_odd&#039;
    option src_ip &#039;0.0.0.1/0.0.0.1&#039;
    option dest_port &#039;443&#039;
    option proto &#039;tcp&#039;
    option use_policy &#039;wan2_wan&#039;

config rule &#039;default_rule&#039;
    option use_policy &#039;balanced&#039;
    option src_ip &#039;192.168.1.0/24&#039;
    option src_port &#039;all&#039;
    option dest_ip &#039;192.168.1.0/24&#039;
    option dest_port &#039;all&#039;
    option proto &#039;all&#039;

Output of &quot;cat /etc/config/network&quot; : 

config interface &#039;loopback&#039;
    option ifname &#039;lo&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;127.0.0.1&#039;
    option netmask &#039;255.0.0.0&#039;

config globals &#039;globals&#039;
    option ula_prefix &#039;fd71:3514:65a8::/48&#039;

config interface &#039;lan&#039;
    option type &#039;bridge&#039;
    option proto &#039;static&#039;
    option netmask &#039;255.255.255.0&#039;
    option ip6assign &#039;60&#039;
    option ipaddr &#039;192.168.2.1&#039;
    option _orig_ifname &#039;eth0.1&#039;
    option _orig_bridge &#039;true&#039;
    option ifname &#039;eth0.1&#039;

config switch
    option name &#039;eth0&#039;
    option reset &#039;1&#039;
    option enable_vlan &#039;1&#039;

config switch_vlan
    option device &#039;eth0&#039;
    option vlan &#039;1&#039;
    option ports &#039;0 1 2 3 4 5t&#039;

config interface &#039;wan&#039;
    option proto &#039;dhcp&#039;
    option peerdns &#039;0&#039;
    option metric &#039;1&#039;

config interface &#039;wan2&#039;
    option proto &#039;dhcp&#039;
    option metric &#039;2&#039;

Output of &quot;ifconfig&quot; : 

br-lan    Link encap:Ethernet  HWaddr 4C:54:99:DC:44:85  
          inet addr:192.168.2.1  Bcast:192.168.2.255  Mask:255.255.255.0
          inet6 addr: fe80::4e54:99ff:fedc:4485/64 Scope:Link
          inet6 addr: fd71:3514:65a8::1/60 Scope:Global
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:3406038 errors:0 dropped:0 overruns:0 frame:0
          TX packets:5630572 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:216456625 (206.4 MiB)  TX bytes:7744936594 (7.2 GiB)

eth0      Link encap:Ethernet  HWaddr 4C:54:99:DC:44:85  
          inet6 addr: fe80::4e54:99ff:fedc:4485/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:4366 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:960367 (937.8 KiB)
          Interrupt:14 

eth0.1    Link encap:Ethernet  HWaddr 4C:54:99:DC:44:85  
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:4359 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:0 (0.0 B)  TX bytes:942125 (920.0 KiB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:24577 errors:0 dropped:0 overruns:0 frame:0
          TX packets:24577 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:1285848 (1.2 MiB)  TX bytes:1285848 (1.2 MiB)

wlan0     Link encap:Ethernet  HWaddr 4C:54:99:DC:44:86  
          inet addr:192.168.0.198  Bcast:192.168.0.255  Mask:255.255.255.0
          inet6 addr: fe80::4e54:99ff:fedc:4486/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:5638761 errors:0 dropped:0 overruns:0 frame:0
          TX packets:3409058 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:3450702779 (3.2 GiB)  TX bytes:332189752 (316.8 MiB)

wlan0-1   Link encap:Ethernet  HWaddr 4E:54:99:DC:44:86  
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:3406025 errors:0 dropped:0 overruns:0 frame:0
          TX packets:5630900 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:264140897 (251.9 MiB)  TX bytes:3558616708 (3.3 GiB)

Output of &quot;route -n&quot; : 

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.0.1     0.0.0.0         UG    2      0        0 wlan0
192.168.0.0     0.0.0.0         255.255.255.0   U     2      0        0 wlan0
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 br-lan

Output of &quot;ip rule show&quot; : 

0:    from all lookup local 
1002:    from all iif wlan0 lookup main 
2002:    from all fwmark 0x200/0xff00 lookup 2 
2254:    from all fwmark 0xfe00/0xff00 unreachable
32766:    from all lookup main 
32767:    from all lookup default

Output of &quot;ip route list table 1-250&quot; : 

2
default via 192.168.0.1 dev wlan0

Firewall default output policy (must be ACCEPT) : 

ACCEPT

Output of &quot;iptables -L -t mangle -v -n&quot; : 

Chain PREROUTING (policy ACCEPT 7491K packets, 6508M bytes)
 pkts bytes target     prot opt in     out     source               destination         
9063K 7884M mwan3_hook  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
7491K 6508M fwmark     all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain INPUT (policy ACCEPT 32960 packets, 2310K bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 7457K packets, 6505M bytes)
 pkts bytes target     prot opt in     out     source               destination         
7457K 6505M mssfix     all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 32575 packets, 2780K bytes)
 pkts bytes target     prot opt in     out     source               destination         
39588 3265K mwan3_hook  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
39588 3265K mwan3_track_hook  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain POSTROUTING (policy ACCEPT 7490K packets, 6508M bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain fwmark (1 references)
 pkts bytes target     prot opt in     out     source               destination         

Chain mssfix (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 9602  491K TCPMSS     tcp  --  *      wlan0   0.0.0.0/0            0.0.0.0/0            tcp flags:0x06/0x02 /* wan2 (mtu_fix) */ TCPMSS clamp to PMTU

Chain mwan3_connected (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 9852  513K MARK       all  --  *      *       0.0.0.0/0            127.0.0.0/8          mark match 0x0/0xff00 MARK or 0xff00
  818  252K MARK       all  --  *      *       0.0.0.0/0            224.0.0.0/3          mark match 0x0/0xff00 MARK or 0xff00
 2383  155K MARK       all  --  *      *       0.0.0.0/0            192.168.0.0/24       mark match 0x0/0xff00 MARK or 0xff00
  820 58208 MARK       all  --  *      *       0.0.0.0/0            192.168.2.0/24       mark match 0x0/0xff00 MARK or 0xff00

Chain mwan3_hook (2 references)
 pkts bytes target     prot opt in     out     source               destination         
9102K 7887M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0            CONNMARK restore mask 0xff00
74425 6407K mwan3_ifaces  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
54566 4094K mwan3_connected  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
36762 2804K mwan3_rules  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00
9102K 7887M CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0            CONNMARK save mask 0xff00

Chain mwan3_iface_wan2 (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 1128  194K MARK       all  --  *      *       192.168.0.0/24       0.0.0.0/0            mark match 0x0/0xff00 /* wan2 */ MARK or 0xff00
16011 1692K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2 */ MARK xset 0x200/0xff00

Chain mwan3_ifaces (1 references)
 pkts bytes target     prot opt in     out     source               destination         
17139 1886K mwan3_iface_wan2  all  --  wlan0  *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00

Chain mwan3_policy_balanced (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2 2 2 */ MARK xset 0x200/0xff00

Chain mwan3_policy_wan2_only (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2 2 2 */ MARK xset 0x200/0xff00

Chain mwan3_policy_wan2_wan (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2 2 2 */ MARK xset 0x200/0xff00

Chain mwan3_policy_wan_only (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* unreachable */ MARK xset 0xfe00/0xff00

Chain mwan3_policy_wan_wan2 (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  487 25712 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff00 /* wan2 2 2 */ MARK xset 0x200/0xff00

Chain mwan3_rules (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  487 25712 mwan3_policy_wan_wan2  tcp  --  *      *       0.0.0.0/0.0.0.1      0.0.0.0/0            multiport sports 0:65535 multiport dports 443 mark match 0x0/0xff00 /* sticky_even */
    0     0 mwan3_policy_wan2_wan  tcp  --  *      *       0.0.0.1/0.0.0.1      0.0.0.0/0            multiport sports 0:65535 multiport dports 443 mark match 0x0/0xff00 /* sticky_odd */
    0     0 mwan3_policy_balanced  all  --  *      *       192.168.1.0/24       192.168.1.0/24       mark match 0x0/0xff00 /* default_rule */

Chain mwan3_track_hook (1 references)
 pkts bytes target     prot opt in     out     source               destination         
39588 3265K mwan3_track_wan2  all  --  *      *       0.0.0.0/0            0.0.0.0/0           

Chain mwan3_track_wan2 (1 references)
 pkts bytes target     prot opt in     out     source               destination         
 1535  129K MARK       icmp --  *      wlan0   0.0.0.0/0            208.67.220.220       icmptype 8 MARK or 0xff00
 1535  129K MARK       icmp --  *      wlan0   0.0.0.0/0            8.8.8.8              icmptype 8 MARK or 0xff00

Chain qos_Default (0 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0            CONNMARK restore mask 0xff
    0     0 qos_Default_ct  all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x1/0xff length 400:65535 MARK and 0xffffff00
    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x2/0xff length 800:65535 MARK and 0xffffff00
    0     0 MARK       udp  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff length 0:500 MARK xset 0x2/0xff
    0     0 MARK       icmp --  *      *       0.0.0.0/0            0.0.0.0/0            MARK xset 0x1/0xff
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff tcp spts:1024:65535 dpts:1024:65535 MARK xset 0x4/0xff
    0     0 MARK       udp  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff udp spts:1024:65535 dpts:1024:65535 MARK xset 0x4/0xff
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            length 0:128 mark match ! 0x4/0xff tcp flags:0x3F/0x02 MARK xset 0x1/0xff
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            length 0:128 mark match ! 0x4/0xff tcp flags:0x3F/0x10 MARK xset 0x1/0xff

Chain qos_Default_ct (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff tcp multiport ports 22,53 MARK xset 0x1/0xff
    0     0 MARK       udp  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff udp multiport ports 22,53 MARK xset 0x1/0xff
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff tcp multiport ports 20,21,25,80,110,443,993,995 MARK xset 0x3/0xff
    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff tcp multiport ports 5190 MARK xset 0x2/0xff
    0     0 MARK       udp  --  *      *       0.0.0.0/0            0.0.0.0/0            mark match 0x0/0xff udp multiport ports 5190 MARK xset 0x2/0xff
    0     0 CONNMARK   all  --  *      *       0.0.0.0/0            0.0.0.0/0            CONNMARK save mask 0xff</code></pre></div>											<p class="post-edited">(Last edited by <strong>JoiNNN</strong> on 4 Jul 2014, 18:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239326">
				<div class="post-metadata">
					<div class="post-num">Post #842</div>
					<div class="post-author">Adze</div>
					<div class="post-datetime">
						4 Jul 2014, 21:43					</div>
				</div>
				<div class="post-content content">
					<p>Hi JoiNNN</p><p><em>When you have set a password for root, you should be able to access the router through ssh. Telnet will not work after that.</em></p><p>Looking at your output i see only one default route. There should be two in your case.</p><p>Also looking at the wlan interfaces, i see interfaces wlan0 and wlan0-1. I would expect there would be a third. One bridge and two WAN interfaces. Only wlan0 has an ip address.</p><p>Did you check your WAN interfaces are indeed correctly working?</p>											<p class="post-edited">(Last edited by <strong>Adze</strong> on 4 Jul 2014, 21:44)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239339">
				<div class="post-metadata">
					<div class="post-num">Post #843</div>
					<div class="post-author">JoiNNN</div>
					<div class="post-datetime">
						4 Jul 2014, 23:01					</div>
				</div>
				<div class="post-content content">
					<p>Oh well, guess what <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> as suspected in the initial post, both WiFi connections MUST run on the same channel. After that I&#039;ve added another route as you suggested and everything just works.<br />Thank you for your assistance and keep up this great project.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239406">
				<div class="post-metadata">
					<div class="post-num">Post #844</div>
					<div class="post-author">ValdikSS</div>
					<div class="post-datetime">
						5 Jul 2014, 19:54					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Ah, i now know what you mean. Short answer is that mwan3 does not support that without some extra ip rules. Mwan3 has a policy that all packets incomming from wan interfaces are routed via the main routing table (ip rules 1001 to 1250). If you want a different routing policy for PC2 you wil have to add a custom ip rule before rule 1000.</p></blockquote></div><p>Thanks for the reply, but I&#039;m not sure why it doesn&#039;t work then. If input packet is going into main routing table, then it should route just fine to the default gateway, but it doesn&#039;t.<br />What rules should I add and where?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239407">
				<div class="post-metadata">
					<div class="post-num">Post #845</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						5 Jul 2014, 19:55					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>JoiNNN wrote:</cite><blockquote><p>Oh well, guess what <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> as suspected in the initial post, both WiFi connections MUST run on the same channel. After that I&#039;ve added another route as you suggested and everything just works.<br />Thank you for your assistance and keep up this great project.</p></blockquote></div><p>That is correct. AFAIK all physical radio interfaces can only use one channel at a time regardless of how many SSID are configured. You can always upgrade to a router with two radios and then use two different channels if necessary. WiFi would be better on a dual radio router as well.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p239626">
				<div class="post-metadata">
					<div class="post-num">Post #846</div>
					<div class="post-author">gh0st</div>
					<div class="post-datetime">
						8 Jul 2014, 12:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Adze wrote:</cite><blockquote><p>Hi Ghost,</p><br /><p>Please try and add this rule to your mwan3 config. Place it on top of all other rules:</p><div class="codebox"><pre><code>config rule &#039;ipsec&#039;
    option dest_ip &#039;{remote subnet}&#039;
    option use_policy &#039;default&#039;</code></pre></div><p>On a sdie note: I see that you use custom route table 220. This can be a problem as mwan3 might wipe this table when it&#039;s stopped. If you use a number higher then 255 you should be fine...</p></blockquote></div><p>Hi Adze,</p><p>sorry for late reply, just _needed_ to get some distance between me and all this kernel hacking stuff (not only related to mwan3)...</p><p>This was the right pointer!!<br />Additionally i added another rule for the ipsec tunnel itself:<br /></p><div class="codebox"><pre><code>config rule &#039;ipsec-gateway&#039;
    option dest_ip &#039;{remote gateway}&#039;
    option use_policy &#039;default&#039;</code></pre></div><p>as i had some connection problems when putting it through mwan3, no good idea why, need to test some more i think.<br />But so far it is working and thats a good thing <img src="https://forum.openwrt.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>As for the routing table 220, as mentioned, it is the default for strongswan, i am not sure if it can be changed by config, it can be on compilation.... But anyway, the chance that someone with 220 wan interfaces wants to use strongswan with wan3 is _extremely_ low <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p240536">
				<div class="post-metadata">
					<div class="post-num">Post #847</div>
					<div class="post-author">gh0st</div>
					<div class="post-datetime">
						17 Jul 2014, 10:21					</div>
				</div>
				<div class="post-content content">
					<p>Hi Adze,</p><p>i still have some strange behavior with strongswan, it seems to just noch respect the mwan3 rules.<br />For the remote subnet, it&#039;s all good, selecting policy to just MARK and let the strongswan rules properly handle the traffic.</p><p>But for the connection itself, strongswan seems to just go with the lowest metric interface. This is problematic when wan is via some other network by dhcp, if this has no connectivity, the route is still there but internet is not reacheable.</p><p>It could be possible to change the metrics dynamically on mwan ifdown events, but this would bypass the whole idea of the system a bit i think. </p><p>current config:<br /></p><div class="codebox"><pre><code>config rule &#039;ipsec_gate&#039;
    option use_policy &#039;balanced&#039;
    option dest_ip &#039;{remote gateway}&#039;
    option proto &#039;all&#039;

config rule &#039;ipsec&#039;
    option dest_ip &#039;{remote subnet}&#039;
    option use_policy &#039;default&#039;

config rule &#039;default_rule&#039;
    option dest_ip &#039;0.0.0.0/0&#039;
    option proto &#039;all&#039;
    option use_policy &#039;balanced&#039;</code></pre></div><p>The rule in question is the first one, set do &#039;default&#039; only the metric decides, set to &#039;balanced&#039; seems to be the same...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p240561">
				<div class="post-metadata">
					<div class="post-num">Post #848</div>
					<div class="post-author">kpv</div>
					<div class="post-datetime">
						17 Jul 2014, 18:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>gh0st wrote:</cite><blockquote><p>But for the connection itself, strongswan seems to just go with the lowest metric interface. This is problematic when wan is via some other network by dhcp, if this has no connectivity, the route is still there but internet is not reacheable.</p></blockquote></div><p>Is the remote IPsec VPN peer IP (the one specified in <em>option dest_ip &#039;{remote gateway}&#039;</em>) on a directly connected network (i.e. is it listed among the &quot;Known networks:&quot; subsection, when you run &quot;mwan3 status&quot;) ?</p><p>In that case, afaik mwan will indeed use the lowest metric interface to connect to it.</p>											<p class="post-edited">(Last edited by <strong>kpv</strong> on 17 Jul 2014, 19:09)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p240637">
				<div class="post-metadata">
					<div class="post-num">Post #849</div>
					<div class="post-author">arfett</div>
					<div class="post-datetime">
						18 Jul 2014, 03:16					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>gh0st wrote:</cite><blockquote><p>But for the connection itself, strongswan seems to just go with the lowest metric interface. This is problematic when wan is via some other network by dhcp, if this has no connectivity, the route is still there but internet is not reacheable.</p></blockquote></div><p>Strongswan was once a pain in the ass when multiple WAN interfaces existed on the same router. Since version 5.0.1 there are now configurable whitelists and blacklists for interfaces in the Strongswan configuration.</p><p>Use the charon.interfaces_ignore or charon.interfaces_use commands in /etc/strongswan.conf to tell Strongswan what interfaces it is allowed to use. Both take a comma-separated list of interface names to either ignore or use exclusively. Please note these are the device names (eth0, eth0.1, etc.)</p><p><a href="https://wiki.strongswan.org/issues/185">https://wiki.strongswan.org/issues/185</a></p>											<p class="post-edited">(Last edited by <strong>arfett</strong> on 18 Jul 2014, 18:52)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p240823">
				<div class="post-metadata">
					<div class="post-num">Post #850</div>
					<div class="post-author">glaze83</div>
					<div class="post-datetime">
						20 Jul 2014, 02:36					</div>
				</div>
				<div class="post-content content">
					<p>Adze,</p><p>Love your plugin -- it works great.</p><p>I just have one minor problem with setting the vpn gateway; rules in mwan3 do not seem to affect what interface the tunnel is brought up on.</p><p>I&#039;m looking to bring the tunnel up on wan2, and bring it up on wan if wan2 is down.</p>									</div>
			</article>

			
		
						<div class="notice">
				<p>Sorry, posts 851 to 850 are missing from our archive.</p>
			</div>
		
		
	
	<div class="pagination"><div class="pagination-number">Page 34 of 65</div><nav><ul><li><a href="viewtopic.php%3Fid=39052&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=32.html">32</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=33.html">33</a></li><li class="pagination-current"><span>34</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=35.html">35</a></li><li><a href="viewtopic.php%3Fid=39052&amp;p=36.html">36</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39052&amp;p=65.html">65</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>