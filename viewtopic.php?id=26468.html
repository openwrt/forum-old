<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Multiple IPs</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 19 Mar 2018 and 28 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=26468&amp;p=2.html">2</a></li></ul></nav></div>
			
		
		
			<article class="post" id="p116704">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">mikeyman</div>
					<div class="post-datetime">
						8 Sep 2010, 19:23					</div>
				</div>
				<div class="post-content content">
					<p>Hello.&nbsp; I paid the cable company for 2 extra ip addresses.&nbsp; The thing is that you have to get the extra ips via dhcp, they do not give out static ips with their residential service.</p><p>I want to setup openwrt to retrieve the 2 extra ips so that the router will have 3 different ips on the wan interface via dhcp, then I can use them for 1:1 nat.&nbsp; Is this possible with interface aliases?&nbsp; Will I have to set different mac addresses on each alias, or is that not possible?&nbsp; Thanks!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116715">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						8 Sep 2010, 20:59					</div>
				</div>
				<div class="post-content content">
					<p><a href="http://www.flexjunk.com/2010/01/06/utilizing-att-u-verse-static-ips-with-openwrt/">Utilizing AT&amp;T U-Verse Static IPs with OpenWRT |</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116735">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">mikeyman</div>
					<div class="post-datetime">
						9 Sep 2010, 01:53					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the link, it was very helpful.&nbsp; I had to load the 2.6 kernel version for my router tho, I think its wifi is still unreliable.&nbsp; I am testing it now.&nbsp; I am having a bit of trouble setting up the Static (1:1) Nat, how can I go about doing this?&nbsp; I have my main wan interface and wan1 and wan2 as the aliases.&nbsp; I want wan1 and wan2 to be used as static nat, while the main wan interface stay as the main dynamic nat interface.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116740">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						9 Sep 2010, 07:02					</div>
				</div>
				<div class="post-content content">
					<p>at the end of the document 1:1 static nat. True, but the aliases will be similar configuration.<br /><a href="http://rpc.one.pl/index.php/lista-artykulow/34-openwrt/89-snat-dnat-w-przykladach-openwrt">http://rpc.one.pl/index.php/lista-artyk … ch-openwrt</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116773">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">mikeyman</div>
					<div class="post-datetime">
						9 Sep 2010, 19:51					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for the URL!&nbsp; It is very helpful, just have another question.&nbsp; The thing is that I get my ips via dhcp, so I do not know what they are before hand.&nbsp; I know I can just look them up on the router and just change the iptables if needed, but is there a way to make it so if the ip ever changes on the aliases that it will update the iptables, or will I just have to do it manual when it happens?</p><p>Basically what I want to do is setup where if I have a lan pc with an ip of 192.168.1.30, all of its outgoing traffic to the internet will go out on the 2nd alias&#039;s public ip address, instead of the main ip address.&nbsp; Then I will setup the other lan pc with the ip of 192.168.1.35 so that all of its outgoing traffic goes out on the 3rd alias&#039;s public ip address.&nbsp; I think you can actually use MASQ for this as well since I don&#039;t truly want to do 1:1 NAT.&nbsp; I am basically only wanting to route 2 lan ips to 2 public ips on the router.&nbsp; Basically so they have their own dedicated public ip.</p>											<p class="post-edited">(Last edited by <strong>mikeyman</strong> on 9 Sep 2010, 20:47)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116774">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						9 Sep 2010, 20:29					</div>
				</div>
				<div class="post-content content">
					<p>If you use /etc/config/firewall the rules are updated automatically, if you use manual iptables you have to update the rules manually.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116784">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						9 Sep 2010, 22:05					</div>
				</div>
				<div class="post-content content">
					<p>@jow: And we can do 1:1 NAT using /etc/config/firewall?</p>											<p class="post-edited">(Last edited by <strong>rpc</strong> on 9 Sep 2010, 23:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116794">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						10 Sep 2010, 00:15					</div>
				</div>
				<div class="post-content content">
					<p>rpc, I introduced SNAT support recently, something like that should work:</p><div class="codebox"><pre><code>config redirect
  option src wan
  option src_dip 89.78.67.56   # wan ip
  option dest lan
  option dest_ip 192.168.1.56   # internal mapped ip
  option target DNAT   # this is the implicit default

config redirect
  option src lan
  option src_ip 192.168.1.56  # internal mapped ip
  option dest wan
  option dest_ip 89.78.67.56   # wan ip
  option target SNAT</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116795">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						10 Sep 2010, 00:38					</div>
				</div>
				<div class="post-content content">
					<p>this is trunk revision?<br />this are static ip adress and dynamic wan ip adress ?</p><p>Ps. ok trunk backfire - found</p>											<p class="post-edited">(Last edited by <strong>rpc</strong> on 10 Sep 2010, 00:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116796">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						10 Sep 2010, 00:45					</div>
				</div>
				<div class="post-content content">
					<p>The example above assumes static ips. However, you could put each macvlan iface into a dedicated zone, define masq=1 for - that will take care of the &quot;SNAT&quot; part. For input you can reuse the DNAT rule above with &quot;src_dip&quot; left out.<br />I can&#039;t think of a solution with a single zone and dynamic ips atm.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116798">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						10 Sep 2010, 02:03					</div>
				</div>
				<div class="post-content content">
					<p>Ok I understand</p><p>That is enough<br /></p><div class="codebox"><pre><code>cat /etc/rc.local
ip link add link eth1 name eth2 address 01:23:45:67:89:01 type macvlan
ip link add link eth1 name eth3 address 01:23:45:67:89:02 type macvlan
ip link add link eth1 name eth4 address 01:23:45:67:89:03 type macvlan
ifup -a</code></pre></div><div class="codebox"><pre><code>cat /etc/config/network
config &#039;interface&#039; &#039;wan&#039;
        option &#039;ifname&#039; &#039;eth1&#039;
        option &#039;proto&#039; &#039;dhcp&#039;

config &#039;interface&#039; &#039;wan1&#039;
        option &#039;ifname&#039; &#039;eth2&#039;
        option &#039;proto&#039; &#039;dhcp&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;gateway&#039; &#039;0.0.0.0&#039;

config &#039;interface&#039; &#039;wan2&#039;
        option &#039;ifname&#039; &#039;eth3&#039;
        option &#039;proto&#039; &#039;dhcp&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;gateway&#039; &#039;0.0.0.0&#039;

config &#039;interface&#039; &#039;wan3&#039;
        option &#039;ifname&#039; &#039;eth4&#039;
        option &#039;proto&#039; &#039;dhcp&#039;
        option &#039;defaultroute&#039; &#039;0&#039;
        option &#039;peerdns&#039; &#039;0&#039;
        option &#039;gateway&#039; &#039;0.0.0.0&#039;</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:/etc/config# cat firewall 

config &#039;defaults&#039;
    option &#039;syn_flood&#039; &#039;1&#039;
    option &#039;input&#039; &#039;ACCEPT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
    option &#039;name&#039; &#039;lan&#039;
    option &#039;input&#039; &#039;ACCEPT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
    option &#039;name&#039; &#039;wan&#039;
    option &#039;input&#039; &#039;REJECT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;
    option &#039;masq&#039; &#039;1&#039;
    option &#039;mtu_fix&#039; &#039;1&#039;

config &#039;zone&#039;
    option &#039;name&#039; &#039;wan1&#039;
    option &#039;input&#039; &#039;REJECT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;
    option &#039;masq&#039; &#039;1&#039;

config &#039;zone&#039;
    option &#039;name&#039; &#039;wan2&#039;
    option &#039;input&#039; &#039;REJECT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;
    option &#039;masq&#039; &#039;1&#039;

config &#039;zone&#039;
    option &#039;name&#039; &#039;wan3&#039;
    option &#039;input&#039; &#039;REJECT&#039;
    option &#039;output&#039; &#039;ACCEPT&#039;
    option &#039;forward&#039; &#039;REJECT&#039;
    option &#039;masq&#039; &#039;1&#039;


config &#039;forwarding&#039;
    option &#039;src&#039; &#039;lan&#039;
    option &#039;dest&#039; &#039;wan&#039;

config &#039;forwarding&#039;
    option &#039;src&#039; &#039;lan&#039;
    option &#039;dest&#039; &#039;wan1&#039;

config &#039;forwarding&#039;
    option &#039;src&#039; &#039;lan&#039;
    option &#039;dest&#039; &#039;wan2&#039;

config &#039;forwarding&#039;
    option &#039;src&#039; &#039;lan&#039;
    option &#039;dest&#039; &#039;wan3&#039;

config &#039;rule&#039;
    option &#039;src&#039; &#039;wan&#039;
    option &#039;proto&#039; &#039;udp&#039;
    option &#039;dest_port&#039; &#039;68&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
    option &#039;src&#039; &#039;wan1&#039;
    option &#039;proto&#039; &#039;udp&#039;
    option &#039;dest_port&#039; &#039;68&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
    option &#039;src&#039; &#039;wan2&#039;
    option &#039;proto&#039; &#039;udp&#039;
    option &#039;dest_port&#039; &#039;68&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
    option &#039;src&#039; &#039;wan3&#039;
    option &#039;proto&#039; &#039;udp&#039;
    option &#039;dest_port&#039; &#039;68&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;


config &#039;rule&#039;
    option &#039;src&#039; &#039;wan&#039;
    option &#039;proto&#039; &#039;icmp&#039;
    option &#039;icmp_type&#039; &#039;echo-request&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
    option &#039;src&#039; &#039;wan1&#039;
    option &#039;proto&#039; &#039;icmp&#039;
    option &#039;icmp_type&#039; &#039;echo-request&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
    option &#039;src&#039; &#039;wan2&#039;
    option &#039;proto&#039; &#039;icmp&#039;
    option &#039;icmp_type&#039; &#039;echo-request&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
    option &#039;src&#039; &#039;wan3&#039;
    option &#039;proto&#039; &#039;icmp&#039;
    option &#039;icmp_type&#039; &#039;echo-request&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;


config &#039;include&#039;
    option &#039;path&#039; &#039;/etc/firewall.user&#039;

config &#039;rule&#039;
    option &#039;proto&#039; &#039;tcp&#039;
    option &#039;dest_port&#039; &#039;22&#039;
    option &#039;target&#039; &#039;ACCEPT&#039;


config &#039;redirect&#039;
    &#039;option&#039; &#039;src&#039; &#039;wan1&#039;
    &#039;option&#039; &#039;dest&#039; &#039;lan&#039;
    &#039;option&#039; &#039;dest_ip&#039; &#039;192.168.1.101&#039;   
    &#039;option&#039; &#039;target&#039; &#039;DNAT&#039; 

config &#039;redirect&#039;
    &#039;option&#039; &#039;src&#039; &#039;wan2&#039;
    &#039;option&#039; &#039;dest&#039; &#039;lan&#039;
    &#039;option&#039; &#039;dest_ip&#039; &#039;192.168.1.102&#039;   
    &#039;option&#039; &#039;target&#039; &#039;DNAT&#039; 

config &#039;redirect&#039;
    &#039;option&#039; &#039;src&#039; &#039;wan3&#039;
    &#039;option&#039; &#039;dest&#039; &#039;lan&#039;
    &#039;option&#039; &#039;dest_ip&#039; &#039;192.168.1.103&#039;   
    &#039;option&#039; &#039;target&#039; &#039;DNAT&#039;</code></pre></div><p>Thanks. <br />Already expanded the my description of these options. <a href="http://rpc.one.pl/index.php/lista-artykulow/34-openwrt/89-snat-dnat-w-przykladach-openwrt">http://rpc.one.pl/index.php/lista-artyk … ch-openwrt</a></p>											<p class="post-edited">(Last edited by <strong>rpc</strong> on 11 Sep 2010, 12:51)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116805">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">mikeyman</div>
					<div class="post-datetime">
						10 Sep 2010, 06:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jow wrote:</cite><blockquote><p>The example above assumes static ips. However, you could put each macvlan iface into a dedicated zone, define masq=1 for - that will take care of the &quot;SNAT&quot; part. For input you can reuse the DNAT rule above with &quot;src_dip&quot; left out.<br />I can&#039;t think of a solution with a single zone and dynamic ips atm.</p></blockquote></div><p>I put the macvlan interfaces on their own zones (wan1 and wan2) and I did set masq on them.&nbsp; How could I set it up to where ip 192.168.1.30 would use only the wan1 zone and 192.168.1.35 would only use the wan2 zone?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116806">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						10 Sep 2010, 09:44					</div>
				</div>
				<div class="post-content content">
					<p>@jow:<br />I objected that SNAT will always work properly.<br />Take for example:<br /></p><div class="codebox"><pre><code>config &#039;redirect&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;src_ip&#039; &#039;192.168.1.104&#039;
        option &#039;dest&#039; &#039;wan&#039;
        option &#039;dest_ip&#039; &#039;178.36.7.175&#039;
        option &#039;target&#039; &#039;SNAT&#039;</code></pre></div><p>In this context, it looks like the following:<br /></p><div class="codebox"><pre><code>Chain zone_lan_nat (0 references)
target     prot opt source               destination
MASQUERADE  all  --  anywhere             anywhere
SNAT       tcp  --  192.168.1.104        anywhere            to:178.36.7.175
SNAT       udp  --  192.168.1.104        anywhere            to:178.36.7.175</code></pre></div><p>So SNAT chains are placed for MASQUERADE<br />So these two SNAT entries will never be executed.</p><p>Or take another example:<br />I want to do something like this:<br /></p><div class="codebox"><pre><code>iptables -t nat -I zone_lan_nat -p tcp --src 192.168.1.0/24 --dst 192.168.1.10 --dport 5555 -j SNAT --to 192.168.1.1</code></pre></div><p>If you do this:<br /></p><div class="codebox"><pre><code>config &#039;redirect&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;src_ip&#039; &#039;192.168.1.0/24&#039;
        option &#039;src_dport&#039; &#039;5555&#039;
        option &#039;src_dip&#039; &#039;192.168.1.1&#039;
        option &#039;dest&#039; &#039;lan&#039;
        option &#039;dest_ip&#039; &#039;192.168.1.10&#039;
        option &#039;target&#039; &#039;SNAT&#039;</code></pre></div><p>you get the following result:<br /></p><div class="codebox"><pre><code>Chain zone_lan_nat (0 references)
target     prot opt source               destination
MASQUERADE  all  --  anywhere             anywhere
SNAT       tcp  --  192.168.1.0/24       192.168.1.1         tcp dpt:5555 to:192.168.1.10
SNAT       udp  --  192.168.1.0/24       192.168.1.1         udp dpt:5555 to:192.168.1.10</code></pre></div><p>And again, the chains SNAT have been placed for MASQUERADE</p><br /><p>It is proposed to modify the file<br />/lib/firewall/uci_firewall.sh<br />on line MASQUERADE. Patch: <a href="http://rpc.one.pl/pliki/openwrt/backfire/10.03.x/firewall/uci_firewall.sh.diff">uci_firewall.sh.diff</a><br /></p><div class="codebox"><pre><code>Index: package/firewall/files/uci_firewall.sh
===================================================================
--- package/firewall/files/uci_firewall.sh    (wersja 22996)
+++ package/firewall/files/uci_firewall.sh    (kopia robocza)
@@ -101,7 +101,7 @@
         [ &quot;${msrc#!}&quot; != &quot;$msrc&quot; ] &amp;&amp; msrc=&quot;! -s ${msrc#!}&quot; || msrc=&quot;-s $msrc&quot;
         for mdst in ${masq_dest:-0.0.0.0/0}; do
             [ &quot;${mdst#!}&quot; != &quot;$mdst&quot; ] &amp;&amp; mdst=&quot;! -d ${mdst#!}&quot; || mdst=&quot;-d $mdst&quot;
-            $IPTABLES -I zone_${zone}_nat 1 -t nat -o &quot;$ifname&quot; $msrc $mdst -j MASQUERADE
+            $IPTABLES -A zone_${zone}_nat -t nat -o &quot;$ifname&quot; $msrc $mdst -j MASQUERADE
         done
     done</code></pre></div><p>After this change, everything looks correct<br /></p><div class="codebox"><pre><code>Chain zone_lan_nat (1 references)
target     prot opt source               destination
SNAT       tcp  --  192.168.1.0/24       192.168.1.1         tcp dpt:5555 to:192.168.1.10
SNAT       udp  --  192.168.1.0/24       192.168.1.1         udp dpt:5555 to:192.168.1.10
SNAT       tcp  --  192.168.1.104        anywhere            to:178.36.7.175
SNAT       udp  --  192.168.1.104        anywhere            to:178.36.7.175
MASQUERADE  all  --  anywhere             anywhere</code></pre></div><p>Yet the second question<br />What is unique string zone_lan_nat?<br />After all, this chain never fails unless we add<br /></p><div class="codebox"><pre><code>config &#039;zone&#039;
        option &#039;name&#039; &#039;lan&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;
        option &#039;masq&#039; &#039;1&#039;</code></pre></div><p>Then we obtain<br /></p><div class="codebox"><pre><code>Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
postrouting_rule  all  --  anywhere             anywhere
zone_lan_nat  all  --  anywhere             anywhere
zone_wan_nat  all  --  anywhere             anywhere</code></pre></div><p>but it is logical</p>											<p class="post-edited">(Last edited by <strong>rpc</strong> on 10 Sep 2010, 12:36)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116816">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						10 Sep 2010, 13:42					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ll look into it, thanks for testing. Yes the -I ... 1 is the culprit, I fixed it in trunk but not in backfire, will check that.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116819">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						10 Sep 2010, 14:24					</div>
				</div>
				<div class="post-content content">
					<p>This patch also fixes the same problem as someone wants to use /etc/firewall_user and doing manual entries.<br />So far MASQUERADE was in first place now is at the end. That is as it should be.</p><p>At the same time it is repaired the same problem for the chain zone_wan_nat in fact, all zone_??? _nat</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116823">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						10 Sep 2010, 14:56					</div>
				</div>
				<div class="post-content content">
					<p>@jow:<br />I have another question.<br />In their present configuration, if we use<br />SNAT target option<br />We will do it two strings. One for the second TCP for UDP.<br /></p><div class="codebox"><pre><code>Chain zone_lan_nat (0 references)
target     prot opt source               destination
MASQUERADE  all  --  anywhere             anywhere
SNAT       tcp  --  192.168.1.0/24       192.168.1.1         tcp dpt:5555 to:192.168.1.10
SNAT       udp  --  192.168.1.0/24       192.168.1.1         udp dpt:5555 to:192.168.1.10</code></pre></div><p>Is it possible to configure SNAT to make the protocol icmp, or other?</p><p>for example, the equivalent<br /></p><div class="codebox"><pre><code>iptables -t nat -I POSTROUTING -p icmp --src 192.168.50.0/24 --dst 192.168.1.1 -j SNAT --to 192.168.1.2
iptables -I zone_lan_forward -p icmp --dst 192.168.1.1 -j ACCEPT</code></pre></div><p>this is ?<br /></p><div class="codebox"><pre><code>config &#039;redirect&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;src_ip&#039; &#039;192.168.50.0/24&#039;
        option &#039;src_dip&#039; &#039;192.168.1.1&#039;
        option &#039;dest&#039; &#039;lan&#039;
        option &#039;proto&#039; &#039;icmp&#039;
        option &#039;dest_ip&#039; &#039;192.168.1.2&#039;
        option &#039;target&#039; &#039;SNAT&#039;</code></pre></div><p>Ps.<br />Ok working <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br /></p><div class="codebox"><pre><code>Chain zone_lan_nat (1 references)
target     prot opt source               destination
SNAT       icmp --  192.168.50.0/24       192.168.1.2         to:192.168.1.1
MASQUERADE  all  --  anywhere             anywhere</code></pre></div>											<p class="post-edited">(Last edited by <strong>rpc</strong> on 10 Sep 2010, 15:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116827">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						10 Sep 2010, 16:57					</div>
				</div>
				<div class="post-content content">
					<p>rpc, could you try the patch below? I have no backfire install around atm. It should always enable the zone_*_nat chain regardless of whether .masq has been set or not.</p><p><a href="http://luci.subsignal.org/~jow/bf-firewall-always-nat-and-rule-order.patch">http://luci.subsignal.org/~jow/bf-firew … rder.patch</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116837">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">mikeyman</div>
					<div class="post-datetime">
						10 Sep 2010, 19:24					</div>
				</div>
				<div class="post-content content">
					<p>I have everything setup up on my router, but I can not seem to get source ip 192.168.1.30 to go through the wan1 iface instead of wan.&nbsp; how can I fix this?</p><p>I have tried to set masq_src in the zone config, but thats not working.</p>											<p class="post-edited">(Last edited by <strong>mikeyman</strong> on 10 Sep 2010, 19:28)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116845">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						10 Sep 2010, 20:01					</div>
				</div>
				<div class="post-content content">
					<p>@jow:</p><p>Is NO OK.<br />Is problem<br />yet but I&#039;ll do some tests<br />lost access to the Internet.<br />That is, the router has a client but there is no internet.</p><p>cat /etc/config/firewall<br /></p><div class="codebox"><pre><code>config &#039;defaults&#039;
        option &#039;syn_flood&#039; &#039;1&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
        option &#039;name&#039; &#039;lan&#039;
        option &#039;input&#039; &#039;ACCEPT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;

config &#039;zone&#039;
        option &#039;name&#039; &#039;wan&#039;
        option &#039;input&#039; &#039;REJECT&#039;
        option &#039;output&#039; &#039;ACCEPT&#039;
        option &#039;forward&#039; &#039;REJECT&#039;
        option &#039;masq&#039; &#039;1&#039;
        option &#039;mtu_fix&#039; &#039;1&#039;

config &#039;forwarding&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;dest&#039; &#039;wan&#039;

config &#039;rule&#039;
        option &#039;src&#039; &#039;wan&#039;
        option &#039;proto&#039; &#039;udp&#039;
        option &#039;dest_port&#039; &#039;68&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
        option &#039;src&#039; &#039;wan&#039;
        option &#039;proto&#039; &#039;icmp&#039;
        option &#039;icmp_type&#039; &#039;echo-request&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;include&#039;
        option &#039;path&#039; &#039;/etc/firewall.user&#039;

config &#039;rule&#039;
        option &#039;proto&#039; &#039;41&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
        option &#039;dest_port&#039; &#039;3740&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;rule&#039;
        option &#039;proto&#039; &#039;tcp&#039;
        option &#039;dest_port&#039; &#039;22&#039;
        option &#039;target&#039; &#039;ACCEPT&#039;

config &#039;redirect&#039;
        option &#039;src&#039; &#039;wan&#039;
        option &#039;src_dport&#039; &#039;5500&#039;
        option &#039;dest&#039; &#039;lan&#039;
        option &#039;dest_ip&#039; &#039;192.168.1.126&#039;
        option &#039;dest_port&#039; &#039;5500&#039;
        option &#039;proto&#039; &#039;tcp&#039;

config &#039;redirect&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;src_ip&#039; &#039;192.168.1.0/24&#039;
        option &#039;dest&#039; &#039;wan&#039;
        option &#039;dest_ip&#039; &#039;178.36.178.76&#039;
        option &#039;target&#039; &#039;SNAT&#039;


config &#039;redirect&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;src_ip&#039; &#039;192.168.1.0/24&#039;
        option &#039;src_dport&#039; &#039;5555&#039;
        option &#039;src_dip&#039; &#039;192.168.1.1&#039;
        option &#039;dest&#039; &#039;lan&#039;
        option &#039;dest_ip&#039; &#039;192.168.1.10&#039;
        option &#039;target&#039; &#039;SNAT&#039;

config &#039;redirect&#039;
        option &#039;src&#039; &#039;lan&#039;
        option &#039;src_ip&#039; &#039;192.168.50.0/24&#039;
        option &#039;src_dip&#039; &#039;192.168.1.1&#039;
        option &#039;dest&#039; &#039;lan&#039;
        option &#039;proto&#039; &#039;icmp&#039;
        option &#039;dest_ip&#039; &#039;192.168.1.2&#039;
        option &#039;target&#039; &#039;SNAT&#039;</code></pre></div><p>/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</p><p>ipatbles -t nat -L<br /></p><div class="codebox"><pre><code>Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         
zone_wan_prerouting  all  --  anywhere             anywhere            
zone_lan_prerouting  all  --  anywhere             anywhere            
prerouting_rule  all  --  anywhere             anywhere            

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
zone_wan_nat  all  --  anywhere             anywhere            
zone_lan_nat  all  --  anywhere             anywhere            
postrouting_rule  all  --  anywhere             anywhere            

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         

Chain postrouting_rule (1 references)
target     prot opt source               destination         

Chain prerouting_lan (1 references)
target     prot opt source               destination         

Chain prerouting_rule (1 references)
target     prot opt source               destination         

Chain prerouting_wan (1 references)
target     prot opt source               destination         

Chain zone_lan_nat (1 references)
target     prot opt source               destination         
SNAT       tcp  --  192.168.1.0/24       anywhere            to:178.36.178.76 
SNAT       udp  --  192.168.1.0/24       anywhere            to:178.36.178.76 
SNAT       tcp  --  192.168.1.0/24       192.168.1.1         tcp dpt:5555 to:192.168.1.10 
SNAT       udp  --  192.168.1.0/24       192.168.1.1         udp dpt:5555 to:192.168.1.10 
SNAT       icmp --  192.168.50.0/24      192.168.1.1         to:192.168.1.2 

Chain zone_lan_prerouting (1 references)
target     prot opt source               destination         
prerouting_lan  all  --  anywhere             anywhere            

Chain zone_wan_nat (1 references)
target     prot opt source               destination         
MASQUERADE  all  --  anywhere             anywhere            

Chain zone_wan_prerouting (1 references)
target     prot opt source               destination         
prerouting_wan  all  --  anywhere             anywhere            
DNAT       tcp  --  anywhere             anywhere            tcp dpt:5500 to:192.168.1.126:5500 
DNAT       tcp  --  anywhere             anywhere            tcp dpt:8010 to:192.168.1.126:8010</code></pre></div><p>/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</p><p>iptables -L<br /></p><div class="codebox"><pre><code>Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            state RELATED,ESTABLISHED 
ACCEPT     all  --  anywhere             anywhere            
syn_flood  tcp  --  anywhere             anywhere            tcp flags:FIN,SYN,RST,ACK/SYN 
input_rule  all  --  anywhere             anywhere            
input      all  --  anywhere             anywhere            

Chain FORWARD (policy DROP)
target     prot opt source               destination         
zone_wan_MSSFIX  all  --  anywhere             anywhere            
ACCEPT     all  --  anywhere             anywhere            state RELATED,ESTABLISHED 
forwarding_rule  all  --  anywhere             anywhere            
forward    all  --  anywhere             anywhere            
reject     all  --  anywhere             anywhere            

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            state RELATED,ESTABLISHED 
ACCEPT     all  --  anywhere             anywhere            
output_rule  all  --  anywhere             anywhere            
output     all  --  anywhere             anywhere            

Chain forward (1 references)
target     prot opt source               destination         
zone_lan_forward  all  --  anywhere             anywhere            
zone_wan_forward  all  --  anywhere             anywhere            

Chain forwarding_lan (1 references)
target     prot opt source               destination         

Chain forwarding_rule (1 references)
target     prot opt source               destination         

Chain forwarding_wan (1 references)
target     prot opt source               destination         

Chain forwarding_wan (1 references)
target     prot opt source               destination         

Chain input (1 references)
target     prot opt source               destination         
ACCEPT     ipv6 --  anywhere             anywhere            
ACCEPT     udp  --  anywhere             anywhere            udp dpt:3740 
ACCEPT     tcp  --  anywhere             anywhere            tcp dpt:22 
ACCEPT     tcp  --  anywhere             anywhere            tcp dpt:3740 
zone_lan   all  --  anywhere             anywhere            
zone_wan   all  --  anywhere             anywhere            

Chain input_lan (1 references)
target     prot opt source               destination         

Chain input_rule (1 references)
target     prot opt source               destination         

Chain input_wan (1 references)
target     prot opt source               destination         

Chain output (1 references)
target     prot opt source               destination         
zone_lan_ACCEPT  all  --  anywhere             anywhere            
zone_wan_ACCEPT  all  --  anywhere             anywhere            

Chain output_rule (1 references)
target     prot opt source               destination         

Chain reject (5 references)
target     prot opt source               destination         
REJECT     tcp  --  anywhere             anywhere            reject-with tcp-reset 
REJECT     all  --  anywhere             anywhere            reject-with icmp-port-unreachable 

Chain syn_flood (1 references)
target     prot opt source               destination         
RETURN     tcp  --  anywhere             anywhere            tcp flags:FIN,SYN,RST,ACK/SYN limit: avg 25/sec burst 50 
DROP       all  --  anywhere             anywhere            

Chain zone_lan (1 references)
target     prot opt source               destination         
input_lan  all  --  anywhere             anywhere            
zone_lan_ACCEPT  all  --  anywhere             anywhere            

Chain zone_lan_ACCEPT (2 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     all  --  anywhere             anywhere            

Chain zone_lan_DROP (0 references)
target     prot opt source               destination         
DROP       all  --  anywhere             anywhere            
DROP       all  --  anywhere             anywhere            

Chain zone_lan_MSSFIX (0 references)
target     prot opt source               destination         
TCPMSS     tcp  --  anywhere             anywhere            tcp flags:SYN,RST/SYN TCPMSS clamp to PMTU 

Chain zone_lan_REJECT (1 references)
target     prot opt source               destination         
reject     all  --  anywhere             anywhere            
reject     all  --  anywhere             anywhere            

Chain zone_lan_forward (1 references)
target     prot opt source               destination         
ACCEPT     icmp --  192.168.50.0/24      192.168.1.1         
ACCEPT     udp  --  192.168.1.0/24       192.168.1.1         udp dpt:5555 
ACCEPT     tcp  --  192.168.1.0/24       192.168.1.1         tcp dpt:5555 
zone_wan_ACCEPT  all  --  anywhere             anywhere            
forwarding_lan  all  --  anywhere             anywhere            
zone_lan_REJECT  all  --  anywhere             anywhere  

Chain zone_wan (1 references)
target     prot opt source               destination         
ACCEPT     udp  --  anywhere             anywhere            udp dpt:68 
ACCEPT     icmp --  anywhere             anywhere            icmp echo-request 
input_wan  all  --  anywhere             anywhere            
zone_wan_REJECT  all  --  anywhere             anywhere            

Chain zone_wan_ACCEPT (2 references)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     all  --  anywhere             anywhere            

Chain zone_wan_DROP (0 references)
target     prot opt source               destination         
DROP       all  --  anywhere             anywhere            
DROP       all  --  anywhere             anywhere            

Chain zone_wan_MSSFIX (1 references)
target     prot opt source               destination         
TCPMSS     tcp  --  anywhere             anywhere            tcp flags:SYN,RST/SYN TCPMSS clamp to PMTU 

Chain zone_wan_REJECT (2 references)
target     prot opt source               destination         
reject     all  --  anywhere             anywhere            
reject     all  --  anywhere             anywhere            

Chain zone_wan_forward (1 references)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             ubuntu.lan          tcp dpt:8010 
ACCEPT     tcp  --  anywhere             ubuntu.lan          tcp dpt:5500 
forwarding_wan  all  --  anywhere             anywhere            
zone_wan_REJECT  all  --  anywhere             anywhere</code></pre></div>											<p class="post-edited">(Last edited by <strong>rpc</strong> on 10 Sep 2010, 20:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116851">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						10 Sep 2010, 21:23					</div>
				</div>
				<div class="post-content content">
					<p>@jow:</p><p>I found the difference<br />original string is as follows:<br /></p><div class="codebox"><pre><code>Chain POSTROUTING (policy ACCEPT 2 packets, 144 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    9   656 postrouting_rule  all  --  any    any     anywhere             anywhere            
    9   656 zone_lan_nat  all  --  any    any     anywhere             anywhere            
    9   656 zone_wan_nat  all  --  any    any     anywhere             anywhere</code></pre></div><p>and in your patch looks like this:<br /></p><div class="codebox"><pre><code>Chain POSTROUTING (policy ACCEPT 4 packets, 288 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   16   984 zone_wan_nat  all  --  any    pppoa-wan  anywhere             anywhere            
   14  2084 zone_lan_nat  all  --  any    br-lan  anywhere             anywhere            
    4   288 postrouting_rule  all  --  any    any     anywhere             anywhere</code></pre></div><p>admit I do not know what is not so<br />apart from the rest of this difference is identical<br />but after inserting the patch no internet</p><p>Pissed off and cleared all the chains.<br /></p><div class="codebox"><pre><code>Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   12  1624 ACCEPT     all  --  any    any     anywhere             anywhere            

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   11  1640 ACCEPT     all  --  any    any     anywhere             anywhere      

Chain PREROUTING (policy ACCEPT 5 packets, 298 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain POSTROUTING (policy ACCEPT 10 packets, 1271 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    9   593 MASQUERADE  all  --  any    pppoa-wan  anywhere             anywhere</code></pre></div><p>and what&#039;s interesting is not the internet on computers<br /> do not know what the patch changed the behavior but at least strange.</p><p>Original uci_firewall.sh restored with my patch.<br />Standard firewall restart<br />And the internet is.<br />miracles</p>											<p class="post-edited">(Last edited by <strong>rpc</strong> on 10 Sep 2010, 23:54)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116892">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">fyi</div>
					<div class="post-datetime">
						11 Sep 2010, 12:38					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rpc wrote:</cite><blockquote><div class="codebox"><pre><code>cat /etc/rc.local
ip link add link eth1 name eth2 address 01:23:45:67:89:01 type macvlan up
ip link add link eth1 name eth3 address 01:23:45:67:89:02 type macvlan up
ip link add link eth1 name eth4 address 01:23:45:67:89:03 type macvlan up</code></pre></div></blockquote></div><p>Should you seperate each &quot;ip link&quot; command into two lines?<br /></p><div class="codebox"><pre><code>ip link add link eth1 name eth2 address 01:23:45:67:89:01 type macvlan
ip link set eth2 up</code></pre></div><div class="codebox"><pre><code>root@OpenWrt:~# ip link add help
Usage: ip link add link DEV [ name ] NAME
        [ txqueuelen PACKETS ]
        [ address LLADDR ]
        [ broadcast LLADDR ]
        [ mtu MTU ]
        type TYPE [ ARGS ]
       ip link delete DEV type TYPE [ ARGS ]

       ip link set DEVICE [ { up | down } ]
        [ arp { on | off } ]
        [ dynamic { on | off } ]
        [ multicast { on | off } ]
        [ allmulticast { on | off } ]
        [ promisc { on | off } ]
        [ trailers { on | off } ]
        [ txqueuelen PACKETS ]
        [ name NEWNAME ]
        [ address LLADDR ]
        [ broadcast LLADDR ]
        [ mtu MTU ]
        [ netns PID ]
        [ alias NAME ]
       ip link show [ DEVICE ]

TYPE := { vlan | veth | dummy | ifb | macvlan }</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116893">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						11 Sep 2010, 12:47					</div>
				</div>
				<div class="post-content content">
					<p>thanks, I did not pay any attention been corrected.<br /></p><div class="codebox"><pre><code>ifup -a</code></pre></div><p>enough after all</p>											<p class="post-edited">(Last edited by <strong>rpc</strong> on 11 Sep 2010, 12:52)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116910">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">mikeyman</div>
					<div class="post-datetime">
						11 Sep 2010, 16:37					</div>
				</div>
				<div class="post-content content">
					<p>What firewall rule do I need to use in order to forward ip 192.168.1.30 to wan1 and 192.168.1.35 to wan2 so they can use the corresponding wan interfaces?&nbsp; That is all that I have left to setup?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116919">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">mikeyman</div>
					<div class="post-datetime">
						11 Sep 2010, 19:46					</div>
				</div>
				<div class="post-content content">
					<p>Would this work?&nbsp; Or will I have to have a forward rule?</p><div class="codebox"><pre><code>config rule
     option src lan
     option dest wan1
     option src_ip 192.168.1.30
     option target ACCEPT

config rule
     option src lan
     option dest wan2
     option src_ip 192.168.1.35
     option target ACCEPT</code></pre></div>											<p class="post-edited">(Last edited by <strong>mikeyman</strong> on 11 Sep 2010, 19:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p116956">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">rpc</div>
					<div class="post-datetime">
						12 Sep 2010, 11:09					</div>
				</div>
				<div class="post-content content">
					<p>@jow:<br />The change in r23025 uci_firewall.sh works perfectly.<br /><a href="https://dev.openwrt.org/changeset/23025">https://dev.openwrt.org/changeset/23025</a></p><br /><p>Tell me what has previously resulted in the lack of transfer?<br />I made a rule manually, and still there was no traffic packages. It looked as if FORWARD has been blocked, or lack of MASQUERADE.</p><p>@mikeyman:<br />it should work. See below is all about<br /></p><div class="codebox"><pre><code>Chain zone_lan_forward (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 zone_wan2_ACCEPT  udp  --  any    any     192.168.1.35         anywhere            
    0     0 zone_wan2_ACCEPT  tcp  --  any    any     192.168.1.35         anywhere</code></pre></div><p>Even so, it all depends on what you have given previously chains</p><br /><br /><p>Ps.<br />I&#039;ve updated my wiki about SNAT and DNAT: <a href="http://rpc.one.pl/index.php/lista-artykulow/34-openwrt/89-snat-dnat-w-przykladach-openwrt">http://rpc.one.pl/index.php/lista-artyk … ch-openwrt</a></p>											<p class="post-edited">(Last edited by <strong>rpc</strong> on 12 Sep 2010, 14:36)</p>
									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 1 of 2</div><nav><ul><li class="pagination-current"><span>1</span></li><li><a href="viewtopic.php%3Fid=26468&amp;p=2.html">2</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>