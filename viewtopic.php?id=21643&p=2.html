<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Prosody, server for Jabber/XMPP</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 30 Mar 2018 and 30 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 2</div><nav><ul><li><a href="viewtopic.php%3Fid=21643&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p148733">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">perazim</div>
					<div class="post-datetime">
						16 Nov 2011, 12:09					</div>
				</div>
				<div class="post-content content">
					<p>Prosody 0.8.2 is newest version.</p><p>I have been running Prosody 0.8.2 on a Fedora 14 system for some time now and would like to get this running on OpenWRT.</p><p>Would it be possible for the person who packaged the earlier versions of Prosody for OpenWRT (0.6.2) to package this update for me (and others)?</p><p>Thanks,</p><p>Perazim</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p149748">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						28 Nov 2011, 15:44					</div>
				</div>
				<div class="post-content content">
					<p>There is no prosody package for ar71xx, neither for orion @r29330. Something bad happen @<a href="https://dev.openwrt.org/changeset/28901">r28901</a>?<br />Is not in menuconfig. How can I get it back?<br /><strong>Edit:</strong><br />Someone open ticket [s]<a href="https://dev.openwrt.org/ticket/10513">#10513</a>[/s] solved in <a href="https://dev.openwrt.org/changeset/29356">r29356</a><br />Thanks!</p>											<p class="post-edited">(Last edited by <strong>Nilfred</strong> on 30 Nov 2011, 06:43)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p157781">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">spoofy</div>
					<div class="post-datetime">
						17 Feb 2012, 21:13					</div>
				</div>
				<div class="post-content content">
					<p>Hi there,</p><p>I managed to install and run prosody on my OpenWrt Backfire 10.03.1.<br />Clients connect and most things work, but ...</p><p>Whenever a external XMPP-server is involved I get the following error:</p><div class="codebox"><pre><code>Feb 17 18:30:11 socket    debug    server.lua: accepted new client connection from 74.125.64.95:52243 to 5269
Feb 17 18:30:11 s2sin4a41c0    info    Incoming s2s connection
Feb 17 18:30:11 s2sin4a41c0    debug    incoming s2s received &lt;stream:stream&gt;
Feb 17 18:30:11 s2sin4a41c0    debug    sending: &lt;?xml version=&#039;1.0&#039;?&gt;
Feb 17 18:30:11 s2sin4a41c0    debug    sending: &lt;stream:stream xmlns:stream=&#039;http://etherx.jabber.org/streams&#039; id=&#039;7d3cae57-5bcd-4965-b17e-095633c3d18f&#039; xmlns:db=&#039;jabber:server:dialback&#039; xmlns=&#039;jabber:server&#039;&gt;
Feb 17 18:30:11 s2sin4a41c0    debug    Received[s2sin_unauthed]: &lt;result xmlns=&#039;jabber:server:dialback&#039; to=&#039;example.com&#039; from=&#039;gmail.com&#039;&gt;
Feb 17 18:30:11 modulemanager    debug    Passing stanza to mod_dialback
Feb 17 18:30:11 s2sin4a41c0    debug    asking gmail.com if key CAESBxCJxvbi2CYaEI22ne5uTrMvKiMwV0VS6Tk= belongs to them
Feb 17 18:30:11 s2smanager    debug    opening a new outgoing connection for this stanza
Feb 17 18:30:11 s2smanager    debug    First attempt to connect to gmail.com, starting with SRV lookup...
Feb 17 18:30:11 adns    debug    Records for _xmpp-server._tcp.gmail.com. not in cache, sending query (thread: 0x72b360)...
Feb 17 18:30:11 xmppserver_listener    error    Traceback[s2s]: /usr/lib/prosody/net/adns.lua:34: /usr/lib/prosody/net/dns.lua:186: bad argument #1 to &#039;randomseed&#039; (integer expected, got number): stack traceback:
    /usr/lib/prosody/net/xmppserver_listener.lua:33: in function &lt;/usr/lib/prosody/net/xmppserver_listener.lua:33&gt;
    [C]: ?
    /usr/lib/prosody/net/adns.lua:34: in function &#039;lookup&#039;
    /usr/lib/prosody/core/s2smanager.lua:204: in function &#039;attempt_connection&#039;
    /usr/lib/prosody/core/s2smanager.lua:169: in function &#039;new_outgoing&#039;
    /usr/lib/prosody/core/s2smanager.lua:117: in function &#039;send_s2s&#039;
    mod_dialback.lua:70: in function &#039;?&#039;
    /usr/lib/prosody/core/modulemanager.lua:270: in function &#039;modules_handle_stanza&#039;
    /usr/lib/prosody/core/stanza_router.lua:117: in function &#039;core_process_stanza&#039;
    /usr/lib/prosody/net/xmppserver_listener.lua:38: in function &lt;/usr/lib/prosody/net/xmppserver_listener.lua:38&gt;
    [C]: in function &#039;xpcall&#039;
    /usr/lib/prosody/net/xmppserver_listener.lua:38: in function &#039;cb_handlestanza&#039;
    /usr/lib/prosody/core/xmlhandlers.lua:131: in function &lt;/usr/lib/prosody/core/xmlhandlers.lua:106&gt;
    [C]: in function &#039;parse&#039;
    /usr/lib/prosody/net/xmppserver_listener.lua:65: in function &#039;data&#039;
    /usr/lib/prosody/net/xmppserver_listener.lua:139: in function &lt;/usr/lib/prosody/net/xmppserver_listener.lua:117&gt;
    (tail call): ?
    /usr/lib/prosody/net/server.lua:817: in function &lt;/usr/lib/prosody/net/server.lua:802&gt;
    [C]: in function &#039;xpcall&#039;
    /usr/bin/prosody:351: in function &#039;loop&#039;
    /usr/bin/prosody:411: in main chunk
    [C]: ?
Feb 17 18:30:28 c2s5ade88    debug    Received[c2s]: &lt;iq id=&#039;821375837909&#039; type=&#039;get&#039; to=&#039;test@conference.example.com&#039;&gt;
Feb 17 18:30:28 componentmanager    debug    iq stanza being handled by component: conference.example.com
Feb 17 18:30:30 socket    debug    server.lua: client 74.125.64.95:52243 read error: closed
Feb 17 18:30:30 s2sin4a41c0    info    s2s disconnected: gmail.com-&gt;example.com (closed)
Feb 17 18:30:30 s2sin4a41c0    info    Destroying incoming session gmail.com-&gt;example.com
Feb 17 18:30:30 socket    debug    server.lua: closed client handler and removed socket from list</code></pre></div><p>I checked, deinstalled, reinstalled. I searched for these errors at the project sites, but found nothing. <br />Anyone has a clue?</p>											<p class="post-edited">(Last edited by <strong>spoofy</strong> on 17 Feb 2012, 22:57)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161059">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">n000g</div>
					<div class="post-datetime">
						16 Mar 2012, 12:29					</div>
				</div>
				<div class="post-content content">
					<p>I get similar stuff when trying S2S (server to server) connections.<br />I noted that OpenWrt ships 0.6.2-1 while 0.8.2 seems to be the latest release on prosody.im.<br />So before put too much work in this, I&#039;d rather like to see the package updated. However, I have like no experience at all in compiling/building packages. Maybe the original author of the OpenWrt package can update it?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p161235">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						18 Mar 2012, 05:58					</div>
				</div>
				<div class="post-content content">
					<p>No need to compile, most are .lua code and remaining few binaries are of the same version of current.<br />Is straight forward overwrite and run. See <a href="https://forum.openwrt.org/viewtopic.php?pid=125230#p125230">#25</a></p><p>I solved some permissions issues, as prosody runs as prosody:prosody and /etc/ is read-only in newer trunks. I don&#039;t use S2S, but maybe is the same thing: Trying to write on a read only path.<br />Older prosody used to write in /var/lib</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p185339">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						5 Dec 2012, 23:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>spoofy wrote:</cite><blockquote><p>Hi there,</p><p>I managed to install and run prosody on my OpenWrt Backfire 10.03.1.<br />Clients connect and most things work, but ...</p><p>Whenever a external XMPP-server is involved I get the following error:</p><div class="codebox"><pre><code>Feb 17 18:30:11 xmppserver_listener    error    Traceback[s2s]: /usr/lib/prosody/net/adns.lua:34: /usr/lib/prosody/net/dns.lua:186: bad argument #1 to &#039;randomseed&#039; (integer expected, got number)</code></pre></div><p>I checked, deinstalled, reinstalled. I searched for these errors at the project sites, but found nothing. <br />Anyone has a clue?</p></blockquote></div><p>Got it:<br /><a href="http://code.google.com/p/lxmppd/issues/detail?id=320">bad argument #1 to &#039;randomseed&#039; (integer expected, got number)</a><br />And <a href="https://dev.openwrt.org/ticket/12178#comment:6">https://dev.openwrt.org/ticket/12178#comment:6</a><br />If you feel uncomfortable with sed You can edit it with:<br /></p><div class="codebox"><pre><code>vi /usr/lib/prosody/net/dns.lua</code></pre></div><p>Only once after install and problem gone.<br /></p><div class="codebox"><pre><code>sed -i -e &#039;186 s/)))/)) % 0x80000000)/&#039; /usr/lib/prosody/net/dns.lua</code></pre></div><p>Lua 5.1 does not have bitwise operator if you ask why not mask 0x7FFFFFFF (maximum 32 bit positive integer) instead.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p196460">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">Donkey Hotay</div>
					<div class="post-datetime">
						27 Mar 2013, 21:32					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Nilfred wrote:</cite><blockquote><p>No need to compile, most are .lua code and remaining few binaries are of the same version of current.<br />Is straight forward overwrite and run. See <a href="https://forum.openwrt.org/viewtopic.php?pid=125230#p125230">#25</a></p></blockquote></div><p>I must have taken this too literally; I downloaded Prosody 0.8.2 and replaced the /net/, /core/, /modules/, and /util/ luas with the 0.8.2 versions one at a time, checking to see if Prosody would start every time.&nbsp; Afterwards, I ended up with a half-page list of luas that threw errors anyways.&nbsp; I cleared out the Prosody installation and started over.</p><p>I corrected permissions and ownership:</p><div class="codebox"><pre><code>chmod +r /etc/prosody/prosody.cfg.lua

chown -R prosody:prosody /etc/prosody/data</code></pre></div><p>Manually patched dns.lua:</p><div class="codebox"><pre><code>math.randomseed(math.floor(10000*socket.gettime()) % 0x80000000);</code></pre></div><p>Added users:</p><div class="codebox"><pre><code>prosodyctl adduser n00b@n00bserver.nub</code></pre></div><p>After that, my server seems to work fine.&nbsp; My users added each other normally, which failed to happen my first time through these instructions (which is why I tried ghetto-updating to 0.8.2), so perhaps manually deleting the Prosody leftovers after uninstalling and then cleanly reinstalling 0.6.2-2 from the repository helped.</p><p>Thanks, Nilfred, for getting this to work.&nbsp; I now have secure comms again without having Google, MS, or IT social engineering me.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p196471">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						28 Mar 2013, 00:05					</div>
				</div>
				<div class="post-content content">
					<p>You&#039;re welcome!</p><p>It&#039;s still not clear if you are running 0.6.2 or 0.8.2 <img src="https://forum.openwrt.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p><p>Latest updates are in <a href="http://wiki.openwrt.org/doc/howto/xmpp.server#upgrade.to.prosody.0.8.2">Wiki</a> and <a href="https://dev.openwrt.org/ticket/12178">Ticket 12178</a> (solved <a href="http://code.google.com/p/lxmppd/issues/detail?id=320">upstream</a>)</p><p>A problem still remain without a clue of witch cause 100% CPU usage.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p196493">
				<div class="post-metadata">
					<div class="post-num">Post #34</div>
					<div class="post-author">Donkey Hotay</div>
					<div class="post-datetime">
						28 Mar 2013, 06:34					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Nilfred wrote:</cite><blockquote><p>It&#039;s still not clear if you are running 0.6.2 or 0.8.2 <img src="https://forum.openwrt.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p></blockquote></div><p>0.6.2-2.</p><p>I don&#039;t have the skill to build a 0.8.2 package.&nbsp; I read your updates to the wiki, though.</p><div class="quotebox"><blockquote><p>A problem still remain without a clue of witch cause 100% CPU usage.</p></blockquote></div><p><a href="https://dev.openwrt.org/ticket/12178#comment:18">https://dev.openwrt.org/ticket/12178#comment:18</a></p><p>Anon said to change the default 5222 port to something else to avoid bot spam.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p217446">
				<div class="post-metadata">
					<div class="post-num">Post #35</div>
					<div class="post-author">starix</div>
					<div class="post-datetime">
						13 Nov 2013, 15:41					</div>
				</div>
				<div class="post-content content">
					<p>What about updated version 0.9.1?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p217510">
				<div class="post-metadata">
					<div class="post-num">Post #36</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						14 Nov 2013, 13:10					</div>
				</div>
				<div class="post-content content">
					<p>0.9.1 depends on a custom IPV6 library. Doesn&#039;t worth the effort and [put your excuse for not doing it yourself here]</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231879">
				<div class="post-metadata">
					<div class="post-num">Post #37</div>
					<div class="post-author">ramponis</div>
					<div class="post-datetime">
						30 Apr 2014, 17:19					</div>
				</div>
				<div class="post-content content">
					<p>Hi Nilfred,</p><p>Thank you for your work.<br />I have applied your patch to build prosidy 0.8.2<br />The compilation works fine.<br />I have installed all the required packages:</p><p>libidn_1.18-1<br />liblua_5.1.5-1<br />luaexpat_1.2.0-1<br />luafilesystem_1.6.2-1<br />luasec_0.4-1<br />luasocket_3.0-rc1-20130909-2<br />lua_5.1.5-1<br />prosody_0.8.2-1</p><p>When i try to start it i receive this error:</p><div class="codebox"><pre><code>**************************
Prosody was unable to find LuaSec
This package can be obtained in the following ways:

        Source:           http://www.inf.puc-rio.br/~brunoos/luasec/
        Debian/Ubuntu:    http://prosody.im/download/start#debian_and_ubuntu
        luarocks:         luarocks install luasec

SSL/TLS support will not be available
More help can be found on our website, at http://prosody.im/doc/depends
**************************


lua: symbol &#039;strverscmp&#039;: can&#039;t resolve symbol in lib &#039;/usr/lib/libidn.so.11&#039;.
***********************************
util/encodings couldn&#039;t be loaded. Check that you have a recent version of libidn

The full error was:
error loading module &#039;util.encodings&#039; from file &#039;/usr/lib/prosody/util/encodings.so&#039;:
        (null)
***********************************

**************************
Prosody was unable to find util.hashes
This package can be obtained in the following ways:

        Windows:      Make sure you have hashes.dll from the Prosody distribution in util/
        GNU/Linux:    Run &#039;./configure&#039; and &#039;make&#039; in the Prosody source directory to build util/hashes.so

util.hashes is required for Prosody to run, so we will now exit.
More help can be found on our website, at http://prosody.im/doc/depends
**************************</code></pre></div><p>Can you give me an help?</p><p>Thank you</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p231968">
				<div class="post-metadata">
					<div class="post-num">Post #38</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						1 May 2014, 17:17					</div>
				</div>
				<div class="post-content content">
					<p>I didn&#039;t test it in other platforms other than mine.<br />Maybe I didn&#039;t patch properly the makefile that make those binaries, or the patch doesn&#039;t go well at all.<br />Do You have room for OpenSSL?<br />Try to satisfy those binaries, they should have been compiled but not packaged properly, so copy &amp; paste.<br />I think those are required when OpenSSL is not installed.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p234402">
				<div class="post-metadata">
					<div class="post-num">Post #39</div>
					<div class="post-author">ramponis</div>
					<div class="post-datetime">
						23 May 2014, 18:16					</div>
				</div>
				<div class="post-content content">
					<p>Can you tell me the version of uclib that you use to compile the packages?</p><p>Thank you</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p235871">
				<div class="post-metadata">
					<div class="post-num">Post #40</div>
					<div class="post-author">ramponis</div>
					<div class="post-datetime">
						6 Jun 2014, 18:46					</div>
				</div>
				<div class="post-content content">
					<p>I have compiled it in AA and it works.<br />In backfire doesn&#039;t work.<br />So it is related to the uclib version.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p267897">
				<div class="post-metadata">
					<div class="post-num">Post #41</div>
					<div class="post-author">polsta</div>
					<div class="post-datetime">
						6 Mar 2015, 17:01					</div>
				</div>
				<div class="post-content content">
					<p>Hello.</p><p>I use Prosody 0.9.7<br />Offline messages enable.&nbsp; When you send offline messages prosody crashed.</p><p>ls -la /etc/prosody/data/domain/offline<br />drwsrwsrwt&nbsp; &nbsp; 2 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp;4096 Mar&nbsp; 6 16:40 .<br />drwsrwsrwt&nbsp; &nbsp; 7 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp;4096 Mar&nbsp; 6 14:50 ..<br />-rw-r-----&nbsp; &nbsp; 1 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 Mar&nbsp; 6 16:40 user.list</p><p>user.list = 0 byte!!!!!!</p><p>When I offline messages desabled, prosody ok.</p><p>How to make it work&nbsp; offline messages???</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p267904">
				<div class="post-metadata">
					<div class="post-num">Post #42</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						6 Mar 2015, 18:19					</div>
				</div>
				<div class="post-content content">
					<p>Disk full? Please post the output of<br /></p><div class="quotebox"><blockquote><p>df</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p268943">
				<div class="post-metadata">
					<div class="post-num">Post #43</div>
					<div class="post-author">the2masters</div>
					<div class="post-datetime">
						16 Mar 2015, 22:26					</div>
				</div>
				<div class="post-content content">
					<p>Hi,</p><p>same problem here. </p><div class="codebox"><pre><code># df -h
Filesystem                Size      Used Available Use% Mounted on
rootfs                    2.9M    616.0K      2.3M  20% /
/dev/root                 3.8M      3.8M         0 100% /rom
tmpfs                    61.6M    288.0K     61.3M   0% /tmp
/dev/mtdblock3            2.9M    616.0K      2.3M  20% /overlay
overlayfs:/overlay        2.9M    616.0K      2.3M  20% /
tmpfs                   512.0K         0    512.0K   0% /dev</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p268959">
				<div class="post-metadata">
					<div class="post-num">Post #44</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						17 Mar 2015, 01:16					</div>
				</div>
				<div class="post-content content">
					<p>Permissions? Please post the output of<br /></p><div class="quotebox"><cite>ls -dl /etc /etc/prosody /etc/prosody/data/ /etc/prosody/data /your\%2edomain\%2ename/ /etc/prosody/data/your\%2edomain\%2ename/offline/ wrote:</cite><blockquote><p>drwxr-xr-x&nbsp; &nbsp; 1 root&nbsp; &nbsp; &nbsp;root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 Nov 17&nbsp; 2012 /etc<br />drwxr-xr-x&nbsp; &nbsp; 4 root&nbsp; &nbsp; &nbsp;root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 Dec&nbsp; 5&nbsp; 2012 /etc/prosody<br />drwxr-xr-x&nbsp; &nbsp; 4 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 Dec&nbsp; 5&nbsp; 2012 /etc/prosody/data/<br />drwxr-x---&nbsp; &nbsp; 6 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 Dec 14&nbsp; 2012 /etc/prosody/data/your\%2edomain\%2ename/<br />drwxr-x---&nbsp; &nbsp; 2 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 Mar 16 19:39 /etc/prosody/data/your\%2edomain\%2ename/offline/</p></blockquote></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p268979">
				<div class="post-metadata">
					<div class="post-num">Post #45</div>
					<div class="post-author">the2masters</div>
					<div class="post-datetime">
						17 Mar 2015, 08:59					</div>
				</div>
				<div class="post-content content">
					<p>I checked the permissions, even created the user.list files in offline dir. I tested it now again with your permission set, just to be sure.<br /></p><div class="codebox"><pre><code># ls -ld /etc/prosody/ /etc/prosody/data/ /etc/prosody/data/the2masters\%2ede/ /etc/prosody/data/the2masters\%2ede/offline/
drwxr-xr-x    1 root     root             0 Jan  1  1970 /etc/prosody/
drwxr-xr-x    1 prosody  prosody          0 Jan  1  1970 /etc/prosody/data/
drwxr-x---    5 prosody  prosody          0 Jan  1  1970 /etc/prosody/data/the2masters%2ede/
drwxr-x---    2 prosody  prosody          0 Mar 17 07:48 /etc/prosody/data/the2masters%2ede/offline/</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p268999">
				<div class="post-metadata">
					<div class="post-num">Post #46</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						17 Mar 2015, 14:26					</div>
				</div>
				<div class="post-content content">
					<p>There are no files, unless there are unread offline messages for those users:<br /></p><div class="quotebox"><cite>ls -l /etc/prosody/data/whatever/offline/ wrote:</cite><blockquote><p>-rw-r-----&nbsp; &nbsp; 1 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp;3066 Sep 18&nbsp; 2013 andrea.list<br />-rw-r-----&nbsp; &nbsp; 1 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp; 710 Sep 10&nbsp; 2013 claudia.list<br />-rw-r-----&nbsp; &nbsp; 1 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp; 639 Sep&nbsp; 2&nbsp; 2013 irene.list</p></blockquote></div><p>What is the permission set for /etc/? Older versions used to be in /tmp/, flash friendly.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p269005">
				<div class="post-metadata">
					<div class="post-num">Post #47</div>
					<div class="post-author">the2masters</div>
					<div class="post-datetime">
						17 Mar 2015, 15:15					</div>
				</div>
				<div class="post-content content">
					<div class="codebox"><pre><code># ls -ld /etc/
drwxr-xr-x    1 root     root             0 Mar  2 22:29 /etc/</code></pre></div><p>this empty file got created on last test:<br /></p><div class="codebox"><pre><code># ls -l /etc/prosody/data/the2masters\%2ede/offline/
-rw-r-----    1 prosody  prosody          0 Jan 11 10:41 zabbix.list</code></pre></div><p>file size is 0 byte, looks like creating the file works, but not writing to it.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p280958">
				<div class="post-metadata">
					<div class="post-num">Post #48</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						22 Jun 2015, 04:30					</div>
				</div>
				<div class="post-content content">
					<p>I have a problem with latest trunk (musl): <br /></p><div class="codebox"><pre><code>mips-openwrt-linux-musl-ld -L~/build/openwrt/trunk/staging_dir/target-mips_34kc_musl-1.1.10/usr/lib -L~/build/openwrt/trunk/staging_dir/target-mips_34kc_musl-1.1.10/lib -L~/build/openwrt/trunk/staging_dir/toolchain-mips_34kc_gcc-4.8-linaro_musl-1.1.10/usr/lib -L~/build/openwrt/trunk/staging_dir/toolchain-mips_34kc_gcc-4.8-linaro_musl-1.1.10/lib -fstack-protector -Wl,-z,now -Wl,-z,relro   -O -fPIC -shared -L~/build/openwrt/trunk/staging_dir/target-mips_34kc_musl-1.1.10/usr/lib -L~/build/openwrt/trunk/staging_dir/target-mips_34kc_musl-1.1.10/lib -L~/build/openwrt/trunk/staging_dir/toolchain-mips_34kc_gcc-4.8-linaro_musl-1.1.10/usr/lib -L~/build/openwrt/trunk/staging_dir/toolchain-mips_34kc_gcc-4.8-linaro_musl-1.1.10/lib -fstack-protector -Wl,-z,now -Wl,-z,relro -L./luasocket -o ssl.so x509.o context.o ssl.o -lssl -lcrypto -lluasocket
mips-openwrt-linux-musl-ld: unrecognized option &#039;-Wl,-z,now&#039;
mips-openwrt-linux-musl-ld: use the --help option for usage information
make[6]: *** [ssl.so] Error 1
make[6]: Leaving directory `~/build/openwrt/trunk/build_dir/target-mips_34kc_musl-1.1.10/luasec-luasec-0.5/src&#039;
make[5]: *** [linux] Error 2
make[5]: Leaving directory `~/build/openwrt/trunk/build_dir/target-mips_34kc_musl-1.1.10/luasec-luasec-0.5/src&#039;
make[4]: *** [linux] Error 2
make[4]: Leaving directory `~/build/openwrt/trunk/build_dir/target-mips_34kc_musl-1.1.10/luasec-luasec-0.5&#039;
make[3]: *** [~/build/openwrt/trunk/build_dir/target-mips_34kc_musl-1.1.10/luasec-luasec-0.5/.built] Error 2
make[3]: Leaving directory `~/build/openwrt/trunk/feeds/packages/lang/luasec&#039;
make[2]: *** [package/feeds/packages/luasec/compile] Error 2
make[2]: Leaving directory `~/build/openwrt/trunk&#039;
make[1]: *** [~/build/openwrt/trunk/staging_dir/target-mips_34kc_musl-1.1.10/stamp/.package_compile] Error 2
make[1]: Leaving directory `~/build/openwrt/trunk&#039;
make: *** [world] Error 2</code></pre></div><p>How to workaround that?</p><p>EDIT: Automagically fixed in r46090 <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>Nilfred</strong> on 23 Jun 2015, 22:24)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p324815">
				<div class="post-metadata">
					<div class="post-num">Post #49</div>
					<div class="post-author">kukulo</div>
					<div class="post-datetime">
						19 May 2016, 19:19					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>polsta wrote:</cite><blockquote><p>Hello.</p><p>I use Prosody 0.9.7<br />Offline messages enable.&nbsp; When you send offline messages prosody crashed.</p><p>ls -la /etc/prosody/data/domain/offline<br />drwsrwsrwt&nbsp; &nbsp; 2 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp;4096 Mar&nbsp; 6 16:40 .<br />drwsrwsrwt&nbsp; &nbsp; 7 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp;4096 Mar&nbsp; 6 14:50 ..<br />-rw-r-----&nbsp; &nbsp; 1 prosody&nbsp; prosody&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 Mar&nbsp; 6 16:40 user.list</p><p>user.list = 0 byte!!!!!!</p><p>When I offline messages desabled, prosody ok.</p><p>How to make it work&nbsp; offline messages???</p></blockquote></div><p>Prosody was unable to append data to files with &#039;offline&#039; module, but not on perms level, but on Lua/kernel/ext3 innards level. I get from Prosody community that this error along with using ext3 filesystem &quot;likely means it [Prosody] can&#039;t reserve space for appending to a file, which is only used for offline messages&quot;. The reason I get was &quot;fallocate() not supported in ext3&quot;.</p><p>The solution is to change in /usr/lib/prosody/util/datamanager.lua the line 43 from</p><p>fallocate = pposix.fallocate or fallocate;</p><p>to</p><p>fallocate = fallocate;</p><p>After this change restart with prosodyctl restart.</p><p>Source: <a href="http://www.snbforums.com/threads/prosody-0-9-10-from-entware-ng-offline-messages-storage-not-implemented.32245/">http://www.snbforums.com/threads/prosod â€¦ ted.32245/</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p330638">
				<div class="post-metadata">
					<div class="post-num">Post #50</div>
					<div class="post-author">Nilfred</div>
					<div class="post-datetime">
						6 Jul 2016, 17:06					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>kukulo wrote:</cite><blockquote><p>The solution is to change in /usr/lib/prosody/util/datamanager.lua the line 43 from</p><p>fallocate = pposix.fallocate or fallocate;</p><p>to</p><p>fallocate = fallocate;</p></blockquote></div><div class="codebox"><pre><code>sed -i -e &#039;s/pposix.fallocate or //&#039; /usr/lib/prosody/util/datamanager.lua</code></pre></div><p>Also /usr/lib/prosody/util/uuid.lua has to be edited in order to let prosody 0.9.9-2 start:<br /></p><div class="codebox"><pre><code>local urandom, urandom_err = io.open(&quot;/dev/urandom&quot;, &quot;r+&quot;);</code></pre></div><p>To:<br /></p><div class="codebox"><pre><code>local urandom, urandom_err = io.open(&quot;/dev/urandom&quot;, &quot;r&quot;);</code></pre></div><p>And<br /></p><div class="codebox"><pre><code>function seed(x)
    urandom:write(x);
    urandom:flush();
end</code></pre></div><p>To noop:<br /></p><div class="codebox"><pre><code>function seed(x)
end</code></pre></div>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 2 of 2</div><nav><ul><li><a href="viewtopic.php%3Fid=21643&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0.001 -->

</body>
</html>