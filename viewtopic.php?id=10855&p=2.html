<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Di-624</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 29 Mar 2018 and 22 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 2 of 2</div><nav><ul><li><a href="viewtopic.php%3Fid=10855&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p98806">
				<div class="post-metadata">
					<div class="post-num">Post #26</div>
					<div class="post-author">loadi624</div>
					<div class="post-datetime">
						15 Dec 2009, 18:38					</div>
				</div>
				<div class="post-content content">
					<p>unicorn, can you explain more about redboot. I found redboot_cobra. Make redboot by command:<br />make ENET_PHY=marvell ap51<br />and recieve few files:<br />redboot.elf<br />redboot.img<br />redboot.rom<br />redboot.srec</p><p>I need to run your perl script with redboot.rom?</p>											<p class="post-edited">(Last edited by <strong>loadi624</strong> on 15 Dec 2009, 19:00)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p98824">
				<div class="post-metadata">
					<div class="post-num">Post #27</div>
					<div class="post-author">loadi624</div>
					<div class="post-datetime">
						15 Dec 2009, 23:15					</div>
				</div>
				<div class="post-content content">
					<p>Ok i make very bad working redboot firmware. Router suddenly reboots after few seconds. I only see command prompt of redboot and then router halts <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> I apply your patch by hands to my version of redboot. I think i made something wrong. I have romram redboot version in my router now.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p99040">
				<div class="post-metadata">
					<div class="post-num">Post #28</div>
					<div class="post-author">loadi624</div>
					<div class="post-datetime">
						20 Dec 2009, 08:34					</div>
				</div>
				<div class="post-content content">
					<p>Ok, i compiled redboot as rom startup version, but it reboots in a few seconds, what is it? bad version of redboot? enabled watchdog? can you help me with it please, unicorn?</p>											<p class="post-edited">(Last edited by <strong>loadi624</strong> on 20 Dec 2009, 08:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p99451">
				<div class="post-metadata">
					<div class="post-num">Post #29</div>
					<div class="post-author">unicorn</div>
					<div class="post-datetime">
						28 Dec 2009, 20:09					</div>
				</div>
				<div class="post-content content">
					<p>loadi624, is it actually working? i mean, do you see the prompt on the serial console, etc?<br />If it works, it looks like watchdog is enabled.<br />It seem to be disabled in startup code of redboot, but i&#039;m not sure now. It was way too long ago.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p99552">
				<div class="post-metadata">
					<div class="post-num">Post #30</div>
					<div class="post-author">loadi624</div>
					<div class="post-datetime">
						30 Dec 2009, 14:11					</div>
				</div>
				<div class="post-content content">
					<p>yes i see prompt of redboot, if i work quickly i can execute some commands. Like version <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />And bad thing that i see code, wich is used for disabling watchdog. Can you tell me what version of redboot you use in your case? Maybe you can provide some sources or ready redboot rom? It will be very cool <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>											<p class="post-edited">(Last edited by <strong>loadi624</strong> on 30 Dec 2009, 14:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p104105">
				<div class="post-metadata">
					<div class="post-num">Post #31</div>
					<div class="post-author">geekgirl</div>
					<div class="post-datetime">
						2 Mar 2010, 16:47					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>unicorn wrote:</cite><blockquote><p>Theli, </p><p>a) make sure backup loader works on your hardware: power up router holding reset button. <br />(board should use 192.168.0.1 as LAN address and running single html page proposing to upload new firmware)</p><p>b) use IDA or some other tool to disassemble the original firmware...</p><p>c) to experiment you should learn how to compose firmware images - it&#039;s quite easy:<br /> * pack up NML.MEM to NML.ARJ<br /> * pad it with zeroes to be exactly 0xe0000 (917504) bytes len<br /> * add signature as in original firmware (string like &quot;AP52-AR2316-RT&nbsp; &nbsp; &nbsp; &nbsp;-00&quot; - you should take it from original image) at the same offset at the end of the file.<br /> * add checksum (32bit XOR all over the file with constant 0xabbbba) at the last 32bit word</p><p>You can use something like this to make fw image from NML.ARJ file:<br /></p><div class="codebox"><pre><code>#!/usr/bin/perl 

undef $/; 

$board=&quot;AP52-AR2316-RT       -00&quot;;
$buf=&lt;&gt;;
$buf=pack &quot;a&quot; . (0xe0000-0x20) . &quot;a&quot; . (0x20-4), $buf, $board;

$s=0xaabbbbaa; 
$s ^= $_ foreach unpack &quot;N*&quot;, $buf; 

print $buf, pack &quot;N&quot;, $s;</code></pre></div><p>..well.. not much helping, I know. sorry. at least i&#039;m tring not to speak with riddles</p></blockquote></div><p>Very useful. Actually I realized many D-Link&#039;s use that same checksum (same on my old DI-604 guinea-pig), and i found a page/guide on DWL-900AP+ that showed the same, with C code that does pretty much the same thing as your example perl script <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>For reference, here&#039;s the page: <a href="http://www.acinonyx.tk/index.php/tag/dwl-900ap/lang-pref/en/">DWL-900AP+/800AP+/810+ firmware checksum calculator</a></p><div class="quotebox"><blockquote><p>Firmware Modification Instructions</p><p>&nbsp; &nbsp; * Unarj some_firmware.bin (is actually an arj archive)<br />&nbsp; &nbsp; * Modify NML.MEM image<br />&nbsp; &nbsp; * Arj NML.MEM back to some_firmware.bin<br />&nbsp; &nbsp; * Pad zeros to end of some_firmware.bin until it reaches size 0xe0000<br />&nbsp; &nbsp; * Copy hardware version string starting at address 0xdffe0<br />&nbsp; &nbsp; * Compile dwl_checksum.c:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o gcc -o dwl_checksum dwl_checksum.c<br />&nbsp; &nbsp; * Calculate 32bit checksum:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; o dwl_checksum &lt; some_firmware.bin<br />&nbsp; &nbsp; * Copy 32bit checksum (lsbyte to msbyte) at address 0xdfffc</p></blockquote></div><p><a href="http://www.acinonyx.tk/wp-content/uploads/2008/10/dwl_checksum.c">dwl_checksum.c</a><br /></p><div class="codebox"><pre><code>#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;

#define SIZE  0xe0000
#define MAGIC 0xaabbbbaa

int
main (void)
{
  int data;
  uint32_t checksum = 0;
  uint32_t cnt = 0;

  while ((data = fgetc (stdin)) != EOF)
    {
      checksum ^= ((uint32_t) data) &lt;&lt; ((cnt % sizeof checksum) * 8);
      cnt++;
    }

  checksum ^= MAGIC;

  if (cnt != SIZE)
    fprintf (stderr,
         &quot;WARNING: Firmware size incorrect! Should be exactly %d bytes.\n&quot;,
         SIZE);
  else
    fprintf (stdout, &quot;Checksum: 0x%x\nFile Size: %d bytes\n&quot;, checksum, cnt);

  return 0;
}</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155622">
				<div class="post-metadata">
					<div class="post-num">Post #32</div>
					<div class="post-author">Rainbow</div>
					<div class="post-datetime">
						28 Jan 2012, 14:13					</div>
				</div>
				<div class="post-content content">
					<p>I got a D-Link DI-624 rev. D2 (on label, D1 on board) with erased firmware - completely dead, only POWER, WAN and all LAN LEDs were on. Removed the SPI flash (MX25L1605) and connected to a SPI &quot;programmer&quot; (in fact, 4 resistors and parallel port - <a href="http://rayer.ic.cz/elektro/spipgm.htm">http://rayer.ic.cz/elektro/spipgm.htm</a> ). Dumped the flash and it was all FFs only.</p><p>So I downloaded a 1MB firmware that includes boot loader ( <a href="ftp://ftp.dlink.com/Gateway/di624_revD/Firmware/di624revD_firmware_404.bin">ftp://ftp.dlink.com/Gateway/di624_revD/ … re_404.bin</a> ) and flashed (to address 0 of the 2MB flash). This was not correct but allowed the boot loader to start and restore the firmware using web interface.</p><p>The router now booted but MAC addresses were 00:11:22:33:44:55 and 00:11:22:33:44:56. Found that the first MAC address is stored in the boot loader at offset 0x40 - so edited the firmware and reflashed again (using the programmer, the web interface will not change it). Now MAC addresses are OK.</p><p>But last problem remains: wifi does not work. The WLAN led is off and clicking on the wireless button in web interface does nothing. Found something that might be serial console at JP1 (lower pins from left: 3.3V, RX, NC, NC, TX, GND) but there&#039;s no output (probably disabled in firmware?). At least tftp can be used to get some files: dbgout.txt, ar5maco.dat and ar5eepo.dat.</p><p>dbgout.txt shows that there&#039;s a problem with WLAN EEPROM:<br /></p><div class="codebox"><pre><code>Created Inet main task.
Created clock tick task.
Created PING application task.
channel = 6, 2437
cipher: ENCRYPTION_TKIP
pWLAN-&gt;wirelessMode = 0
pWLAN-&gt;turbo = 0
wmm disabled
Wireless Mode = 0x08, Data Rate = best
wlan0 : abolt = 0
wlan0 : autoChan:0, preamble = 1
wlan0 : apCfgCipherGet() = 5
wlan0 : apCfgAuthTypeGet() = 6
wlan0 : apCfgEncryptionGet() = 1
usrEndLibInit: enet not found.
ar5212Attach: Could not allocate space to cache the EEPROM
Error initializing wireless software state.
apInit: no wlan device
AP initilization failed!
Initializing 802.11g(A) Interface...Failure !
mux_0 applied.
pkt_send_0 applied.
WAN port speed = 10M
WAN port duplex = Half
WAN port flow control = On
CPU port flow control = On
Created Bridge Aging task.
eth_brdg/eth_dev_add: add the 0th device eth-0, type = ethernet device
mctest init called
Created httpd task.
Created smtp task.
Created ntp task.
Created upnp task.
Created dhcps_main task.
Created rad_client task.
System ready ...

Created upnp_http task.
Created ssdp task.</code></pre></div><p>ar5maco.dat looks like WLAN MAC address that&#039;s empty <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /><br /></p><div class="codebox"><pre><code>00000000   30 78 20 20 20 30 20 2D 20 30 30 3A 30 30 3A 30   0x   0 - 00:00:0
00000010   30 3A 30 30 3A 30 30 3A 30 30 00 00 00 00 00 00   0:00:00:00......</code></pre></div><p>WLAN EEPROM (ar5eepo.dat) is empty too - 2048 bytes of FFs</p><p>The TFTP server ignores PUT so these must be flashed using the SPI programmer. But where can I get the EEPROM dump? Anyone has complete flash dump of DI-624 rev. D?</p>											<p class="post-edited">(Last edited by <strong>Rainbow</strong> on 28 Jan 2012, 16:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p156016">
				<div class="post-metadata">
					<div class="post-num">Post #33</div>
					<div class="post-author">Rainbow</div>
					<div class="post-datetime">
						1 Feb 2012, 21:47					</div>
				</div>
				<div class="post-content content">
					<p>Bought the same router in working order and dumped the flash. Changed MAC (at offset 0x40 - this should be set to the MAC from label minus 1) and flashed to the non-working one. Here&#039;s the file (changed MAC to 00:11:22:33:44:55, configuration deleted): <a href="http://www.rainbow-software.org/linux_files/d-link_di-624_rev_d/di-624_rev_d_full_dump.zip">http://www.rainbow-software.org/linux_f … l_dump.zip</a><br />It&#039;s some old firmware, update it to 4.04b47 after reviving the router.</p><p>MAC address from 0x40 is used for both LAN and WLAN. WAN address is the same, only incremented by 1 (should match the label). The ar5maco.dat file from TFTP is bogus, it shows completely different MAC.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 2 of 2</div><nav><ul><li><a href="viewtopic.php%3Fid=10855&amp;p=1.html">1</a></li><li class="pagination-current"><span>2</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>