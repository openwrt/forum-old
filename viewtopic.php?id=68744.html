<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> help required to configure bandwidth limit by using TC command</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 22 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p345200">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">nbuser</div>
					<div class="post-datetime">
						29 Nov 2016, 14:45					</div>
				</div>
				<div class="post-content content">
					<p>Hello All,</p><p>I am trying to configure bandwidth limit for a specific IP. My environment is below:</p><p>WAN port=eth1<br />LAN port=eth0, br-lan, wlan0<br />IP=192.1681.8<br />ISP Upload limit=512 kb<br />ISP Download limit=1 MB</p><p>I want to limit the upload and download limit to 128 and 256 respectively. Can anyone please help here.</p><p>Thanks in advance</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345260">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">va2thc</div>
					<div class="post-datetime">
						30 Nov 2016, 01:36					</div>
				</div>
				<div class="post-content content">
					<p>I did a little googling on the subject and this: <a href="https://www.iplocation.net/traffic-control">https://www.iplocation.net/traffic-control</a> should help you alot, seems todo exactly what you&#039;re trying to do.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345269">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">nbuser</div>
					<div class="post-datetime">
						30 Nov 2016, 05:44					</div>
				</div>
				<div class="post-content content">
					<p>Thanks for your efforts but I am looking for solution specific to OpenWrt. Above link is for Linux systems</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345279">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						30 Nov 2016, 09:02					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>nbuser wrote:</cite><blockquote><p>Thanks for your efforts but I am looking for solution specific to OpenWrt. Above link is for Linux systems</p></blockquote></div><p>You do realize that OpenWrt is Linux, right?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345280">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						30 Nov 2016, 09:49					</div>
				</div>
				<div class="post-content content">
					<p>opkg update<br />opkg install wshaper<br />Study /usr/sbin/wshaper.htb<br />Its almost what you want. But you will have to add additional htb classes for your needs<br />Htb tutorial : <a href="http://luxik.cdi.cz/~devik/qos/htb/manual/userg.htm">http://luxik.cdi.cz/~devik/qos/htb/manual/userg.htm</a></p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 30 Nov 2016, 09:51)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345284">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">nbuser</div>
					<div class="post-datetime">
						30 Nov 2016, 10:45					</div>
				</div>
				<div class="post-content content">
					<p>@stangri....that&#039;s a great point but well I do realize that..:)</p><p>the link shared requires ipset commands which are not available in OpenWrt which is why I pointed out that its for Linux systems.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345288">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">va2thc</div>
					<div class="post-datetime">
						30 Nov 2016, 11:41					</div>
				</div>
				<div class="post-content content">
					<p>where in the link i provided do you see an &#039;ipset&#039; command?</p><p>and why do you say there is no ipset in OpenWRT?<br />root@OpenWRT:~# opkg find ipset<br />ipset - 6.24-1 - IPset administration utility</p><p><img src="https://forum.openwrt.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /> gl</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345291">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">nbuser</div>
					<div class="post-datetime">
						30 Nov 2016, 11:53					</div>
				</div>
				<div class="post-content content">
					<p>my bad..i was referring to a link shared by another user.. but now I have a different issue. I am not able to install packages anymore and they fail with cannot allocate memory. Looks like I need to create a swap space now and then try this. Will update when done and thanks all for your help and pointers.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345463">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">va2thc</div>
					<div class="post-datetime">
						2 Dec 2016, 09:17					</div>
				</div>
				<div class="post-content content">
					<p>I did it just for the hell of it, was bored...</p><p>You&#039;ll need to run:<br />opkg update<br />opkg install kmod-sched</p><p>(code source <a href="https://www.iplocation.net/traffic-control">https://www.iplocation.net/traffic-control</a> lightly modded to fit OpenWRT and CIDR)</p><p>Single ip Control:<br /></p><div class="codebox"><pre><code>#!/bin/ash
#
#  tc uses the following units when passed as a parameter.
#  kbps: Kilobytes per second
#  mbps: Megabytes per second
#  kbit: Kilobits per second
#  mbit: Megabits per second
#  bps: Bytes per second
#       Amounts of data can be specified in:
#       kb or k: Kilobytes
#       mb or m: Megabytes
#       mbit: Megabits
#       kbit: Kilobits
#  To get the byte figure from bits, divide the number by 8 bit
#

#
# Name of the traffic control command.
TC=/usr/sbin/tc

# The network interface we&#039;re planning on limiting bandwidth.
IF=br-lan

# Download limit
DNLD=50kbps

# Upload limit
UPLD=25kbps

# IP address of the machine we are controlling
IP=192.168.1.128

# Filter options for limiting the intended interface.
U32=&quot;$TC filter add dev $IF protocol ip parent 1:0 prio 1 u32&quot;

start() {

# We&#039;ll use Hierarchical Token Bucket (HTB) to shape bandwidth.
# For detailed configuration options, please consult Linux man
# page.

    $TC qdisc add dev $IF root handle 1: htb default 30
    $TC class add dev $IF parent 1: classid 1:1 htb rate $DNLD
    $TC class add dev $IF parent 1: classid 1:2 htb rate $UPLD
    $U32 match ip dst $IP/32 flowid 1:1
    $U32 match ip src $IP/32 flowid 1:2

# The first line creates the root qdisc, and the next two lines
# create two child qdisc that are to be used to shape download
# and upload bandwidth.
#
# The 4th and 5th line creates the filter to match the interface.
# The &#039;dst&#039; IP address is used to limit download speed, and the
# &#039;src&#039; IP address is used to limit upload speed.

}

stop() {

# Stop the bandwidth shaping.
    $TC qdisc del dev $IF root

}

restart() {

# Self-explanatory.
    stop
    sleep 1
    start

}

show() {

# Display status of traffic control status.
    $TC -s qdisc ls dev $IF

}

case &quot;$1&quot; in

  start)

    echo -n &quot;Starting bandwidth shaping: &quot;
    start
    echo &quot;done&quot;
    ;;

  stop)

    echo -n &quot;Stopping bandwidth shaping: &quot;
    stop
    echo &quot;done&quot;
    ;;

  restart)

    echo -n &quot;Restarting bandwidth shaping: &quot;
    restart
    echo &quot;done&quot;
    ;;

  show)

    echo &quot;Bandwidth shaping status for $IF:&quot;
    show
    echo &quot;&quot;
    ;;

  *)

    echo &quot;Usage: $0 {start|stop|restart|show}&quot;
    ;;

esac

exit 0</code></pre></div><br /><p>IP Range Control:<br />This will limit 192.168.1.128 to 192.168.1.254 (255 is broadcast)<br />Set your br-lan interface dhcp server to serve from Start: 128 Limit: 127<br />Give static IP&#039;s to MACs that you want unlimited in the 192.168.1.2 to 192.168.1.127 range<br />To RTFM on 192.168.1.128/25 google &#039;CIDR Notation&#039;</p><div class="codebox"><pre><code>#!/bin/ash
#
#  tc uses the following units when passed as a parameter.
#  kbps: Kilobytes per second
#  mbps: Megabytes per second
#  kbit: Kilobits per second
#  mbit: Megabits per second
#  bps: Bytes per second
#       Amounts of data can be specified in:
#       kb or k: Kilobytes
#       mb or m: Megabytes
#       mbit: Megabits
#       kbit: Kilobits
#  To get the byte figure from bits, divide the number by 8 bit
#

#
# Name of the traffic control command.
TC=/usr/sbin/tc

# The network interface we&#039;re planning on limiting bandwidth.
IF=br-lan

# Download limit
DNLD=50kbps

# Upload limit
UPLD=25kbps

# IP address of the machine we are controlling
IP=192.168.1.128/25

# Filter options for limiting the intended interface.
U32=&quot;$TC filter add dev $IF protocol ip parent 1:0 prio 1 u32&quot;

start() {

# We&#039;ll use Hierarchical Token Bucket (HTB) to shape bandwidth.
# For detailed configuration options, please consult Linux man
# page.

    $TC qdisc add dev $IF root handle 1: htb default 30
    $TC class add dev $IF parent 1: classid 1:1 htb rate $DNLD
    $TC class add dev $IF parent 1: classid 1:2 htb rate $UPLD
    $U32 match ip dst $IP flowid 1:1
    $U32 match ip src $IP flowid 1:2

# The first line creates the root qdisc, and the next two lines
# create two child qdisc that are to be used to shape download
# and upload bandwidth.
#
# The 4th and 5th line creates the filter to match the interface.
# The &#039;dst&#039; IP address is used to limit download speed, and the
# &#039;src&#039; IP address is used to limit upload speed.

}

stop() {

# Stop the bandwidth shaping.
    $TC qdisc del dev $IF root

}

restart() {

# Self-explanatory.
    stop
    sleep 1
    start

}

show() {

# Display status of traffic control status.
    $TC -s qdisc ls dev $IF

}

case &quot;$1&quot; in

  start)

    echo -n &quot;Starting bandwidth shaping: &quot;
    start
    echo &quot;done&quot;
    ;;

  stop)

    echo -n &quot;Stopping bandwidth shaping: &quot;
    stop
    echo &quot;done&quot;
    ;;

  restart)

    echo -n &quot;Restarting bandwidth shaping: &quot;
    restart
    echo &quot;done&quot;
    ;;

  show)

    echo &quot;Bandwidth shaping status for $IF:&quot;
    show
    echo &quot;&quot;
    ;;

  *)

    echo &quot;Usage: $0 {start|stop|restart|show}&quot;
    ;;

esac

exit 0</code></pre></div>											<p class="post-edited">(Last edited by <strong>va2thc</strong> on 2 Dec 2016, 09:34)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345481">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">bolvan</div>
					<div class="post-datetime">
						2 Dec 2016, 11:46					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>va2thc wrote:</cite><blockquote><div class="codebox"><pre><code>    $TC qdisc add dev $IF root handle 1: htb default 30
    $TC class add dev $IF parent 1: classid 1:1 htb rate $DNLD
    $TC class add dev $IF parent 1: classid 1:2 htb rate $UPLD
    $U32 match ip dst $IP/32 flowid 1:1
    $U32 match ip src $IP/32 flowid 1:2

# The first line creates the root qdisc, and the next two lines
# create two child qdisc that are to be used to shape download
# and upload bandwidth.</code></pre></div></blockquote></div><p>You misunderstand concept of traffic shaping.<br />HTB qdisc manages only outgoing traffic. It cant limit download speed.<br />For limiting download speed ingress qdisc with IFB device must be used.</p><p>For concept read :<br /><a href="https://wiki.archlinux.org/index.php/Advanced_traffic_control#Example_of_ingress_traffic_shaping_with_SNAT">https://wiki.archlinux.org/index.php/Ad â€¦ _with_SNAT</a></p><p>As I stated before study how wondershaper script works. Its real working example for openwrt.</p>											<p class="post-edited">(Last edited by <strong>bolvan</strong> on 2 Dec 2016, 11:48)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p345501">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">richbhanover</div>
					<div class="post-datetime">
						2 Dec 2016, 15:09					</div>
				</div>
				<div class="post-content content">
					<p>A couple responses:</p><p>1) Don&#039;t look to Wondershaper. It was marvelous technology 14 years ago. But it is the wrong answer for today&#039;s networks and kernels. See <a href="https://www.bufferbloat.net/projects/cerowrt/wiki/Wondershaper_Must_Die/">Wondershaper Must Die</a> for more details.</p><p>2) I realize that you may need to configure specific limits on a particular IP. But SQM provides a very powerful bandwidth sharing and low latency/lag solution with trivial setup. It might solve your problem with 5 minutes of installation and configuration. Check out the SQM howto at: <a href="https://wiki.openwrt.org/doc/howto/sqm">https://wiki.openwrt.org/doc/howto/sqm</a></p><p>[Note: the SQM code is a direct response to the failings of Wondershaper. It outperforms it in every measurable way.]</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>