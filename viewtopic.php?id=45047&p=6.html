<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Lantiq XWAY WAVE300</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 30 Mar 2018 and 30 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 6 of 6</div><nav><ul><li><a href="viewtopic.php%3Fid=45047&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=45047&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=45047&amp;p=5.html">5</a></li><li class="pagination-current"><span>6</span></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p367856">
				<div class="post-metadata">
					<div class="post-num">Post #126</div>
					<div class="post-author">DocMAX</div>
					<div class="post-datetime">
						5 Nov 2017, 11:26					</div>
				</div>
				<div class="post-content content">
					<p>I don&#039;t understand. Is WAVE300 supported on LEDE or OpenWRT meanwhile? I have a TP W8980 router.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p368344">
				<div class="post-metadata">
					<div class="post-num">Post #127</div>
					<div class="post-author">NiQ</div>
					<div class="post-datetime">
						17 Nov 2017, 11:55					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>DocMAX wrote:</cite><blockquote><p>I don&#039;t understand. Is WAVE300 supported on LEDE or OpenWRT meanwhile? I have a TP W8980 router.</p></blockquote></div><p>Currently no. The good news is that this &quot;no&quot; may be a &quot;not yet&quot; - Seems that there is enough knowledge and/or source code to eventually support it, <em>however</em> it is still very far away from actually being mainline. Devs are close to a PoC (i.e. working with a really old OpenWRT release and with a custom-patched hostapd) but even when they get there there&#039;s a long way from PoC to production.<br />Do remember that these are just volunteers. Working in RnD myself, I can tell you that after 5 days of this I usually can&#039;t bring myself to looking at source code on weekends as well, no matter how interesting it is. If you were to pay them their monthly salaries and have them do nothing but this for a while it could probably be done within a few weeks or so but I doubt that you&#039;re willing to pay thousands of $$$$ just to have 5GHz on your LEDE router. Just let them take their time and see how this unrolls.</p><p>With that being said - Mandrake, lpm11, blackladder1000 - I can&#039;t seem to understand which kernel version you&#039;re currently working on. Could you please summarize so I can also take a look?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p368463">
				<div class="post-metadata">
					<div class="post-num">Post #128</div>
					<div class="post-author">Mandrake</div>
					<div class="post-datetime">
						19 Nov 2017, 23:07					</div>
				</div>
				<div class="post-content content">
					<p>Hello NiQ,</p><p>You have perfectly summarized my feelings with this porting.</p><p>My LEDE is 4.4.38 (info that is in my signature).</p><p>In my platform, the chipset is using PCIe and the IRQ&#039;s in the form of MSI are not properly assigned.</p><p>Nothing to do with the WAVE300 driver itself but a truly roadblock.</p><p>I believe the info from the rest of the team will be more useful.</p><p>Regards</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p368525">
				<div class="post-metadata">
					<div class="post-num">Post #129</div>
					<div class="post-author">lpm11</div>
					<div class="post-datetime">
						20 Nov 2017, 22:25					</div>
				</div>
				<div class="post-content content">
					<p>I can add that this driver will never be integrated into official LEDE/OpenWRT - because source license does not allow to do it. I doubt if anyone agrees to port such old driver for these small numbers of devices.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p368565">
				<div class="post-metadata">
					<div class="post-num">Post #130</div>
					<div class="post-author">blackadder1000</div>
					<div class="post-datetime">
						21 Nov 2017, 15:21					</div>
				</div>
				<div class="post-content content">
					<p>@NiQ<br />I&#039;m running OpenWRT with kernel version 4.4.14.<br />It&#039;s Designated Driver 50108 which relates to git-17.227.62661-3d338ee<br />When I built my build environment I pulled the latest git for OpenWRT</p><p>As detailed throughout this thread, I can get WAVE300 sources to compile and instatiate successfully.<br />lpm11 helpfully provided a script to port /etc/config/wireless settings to the WAVE300 hardware.<br />As a result, I can successfully bring an access point up and can connect to it from another device (my phone - with a static IP).</p><p>However, the final part that I haven&#039;t solved is passing traffic through the interface.</p><p>lmp11&#039;s script calls mtlk-ap, which is a modified version of hostapd. In a previous post I modified a current version of hostapd to support mtlk hardware. Alternatively, the WAVE300 sources include hostapd 0.8 with the neccessary modifications. Unfortunately, at present, neither my version nor the driver version allow me to pass traffic.</p><p>Most recently, lpm11 and Mandrake helpfully suggested hostapd/mtlk-ap settings. Unfortunately I still haven&#039;t managed to get traffic to pass - even with their recommendations. I&#039;ve also recently started a new job so have had little time to continue debugging. I will return to it.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p368593">
				<div class="post-metadata">
					<div class="post-num">Post #131</div>
					<div class="post-author">audiocrush</div>
					<div class="post-datetime">
						22 Nov 2017, 00:58					</div>
				</div>
				<div class="post-content content">
					<p>Hello you guys,</p><p>I think you are doing a great job and it is very much appreciated.<br />@Ipm11<br />Au contraire<br />There are literally bootloads of these devices out there, because they are cheap and perform well.<br />There are hundreds on ebay of the TP-Link 8980 alone and there are 3 other variations of this model all with the wave300 chipset.<br />These things work so well even without the additional 5GHz band that I got another 2 of them for about 20€ each to expand my wifi coverage on my property.<br />I mean it is just Wi-Fi N, but 300Mbps on a mobile device?<br />Certainly can&#039;t complain about that for 20/30 bucks.<br />Also these devices are only sold with aDSL vDSL modems @50Mbps max, but with another vDSL firmware I got mine to support vectoring&nbsp; at 150Mbps.<br />These are such a great deal.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p369882">
				<div class="post-metadata">
					<div class="post-num">Post #132</div>
					<div class="post-author">vittorio88</div>
					<div class="post-datetime">
						21 Dec 2017, 18:01					</div>
				</div>
				<div class="post-content content">
					<p>Hello all,</p><p>I have been unable to follow up with this issue too much, but I have been reflecting on it.<br />I found 2 bugs within the up-porting of nlmsgs.c which led to certain cases of the netlink layer not being properly initialized, hence the panic I&#039;ve been getting on mtlk_nl_send_brd_msg() possibly because nl_sock was undefined.</p><p>This also explains why it worked for blackadder1000 on kernel 4.4 ( the ifdef passed for kernel under 4.5). I switched it for greater than kernel 3.2, so I believe it should work for kernels greater than 4.5 as well now. I am using the latest lede-trunk.</p><p>I have pushed this modification to my repo <a href="https://github.com/vittorio88/WAVE300/tree/Dual-license-BSD_GPL.">https://github.com/vittorio88/WAVE300/t … e-BSD_GPL.</a> I am now up to the point where blackadder1000 was a while back where the wifi will connect, but there is no IP connectivity. Above all, the router doesn&#039;t crash!</p><p>I hope this can help bring us all to the same page.</p><p>These are the commands I am using to set up the connection:<br /></p><div class="codebox"><pre><code>insmod mtlkroot.ko cdebug=2
insmod mtlk.ko ap=1 debug=2

iwpriv wlan0 sCountry IT
iwconfig wlan0 essid test-vitto
iwconfig wlan0 channel 1
ifconfig wlan0 up</code></pre></div><br /><p>I am now getting this log periodically while connected:<br /></p><div class="codebox"><pre><code>mtlk2(handle_rx_ind:7214): SOURCE of RX packet not found!</code></pre></div><p>I guess it&#039;s time to for me to checkout the progress on hostapd.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p369888">
				<div class="post-metadata">
					<div class="post-num">Post #133</div>
					<div class="post-author">vittorio88</div>
					<div class="post-datetime">
						21 Dec 2017, 21:24					</div>
				</div>
				<div class="post-content content">
					<p>Hello again,</p><p>I compiled hostapd as per lpm11&#039;s instruction, however upon running it with mtlk.ko and mtlkroot.ko inserted, I got the following kernel panic.<br /></p><div class="codebox"><pre><code>[ 9147.107675] [0008847016] mtlk1(mtlk_core_set_net_state:681): Going from NET_STATE_IDLE to NET_STATE_READY

root@vitto-rtr1:~/benjamin# ls
hostapd      hostapd_cli
root@vitto-rtr1:~/benjamin# ./hostapd /etc/hostapd/hostapd.conf
Configuration fil[ 9161.264082] [0008861172] mtlk2(_mtlk_df_ui_execute_cfg_handler:6301): IWPRIV #0x0022 being processed
[ 9161.272837] Assertion failed [SLID:0:34:1:2196]
[ 9161.277364] Kernel bug detected[#1]:
[ 9161.280846] CPU: 0 PID: 3176 Comm: hostapd Tainted: P                4.9.51 #0
[ 9161.288060] task: 8723e1c0 task.stack: 864c8000
[ 9161.292577] $ 0   : 00000000 00000001 00000023 00000000
[ 9161.297796] $ 4   : 8110c2dc 8110c2dc 8110ef00 80550000
[ 9161.303021] $ 8   : 80550000 00010000 33343a31 3a323139
[ 9161.308241] $12   : 205b534c 0000002b 00000000 49443a30
[ 9161.313464] $16   : 86ed7ca0 864c9e30 00000000 00000022
[ 9161.318688] $20   : 80550000 864c9e30 ffffffe7 864c9ddc
[ 9161.323908] $24   : 00000002 7779e4f8
[ 9161.329131] $28   : 864c8000 864c9c98 86547c84 86ee7854
[ 9161.334359] Hi    : 00000000
[ 9161.337224] Lo    : 00000000
[ 9161.340141] epc   : 86ee7854 __mtlk_assert+0x34/0x14c [mtlkroot]
[ 9161.346131] ra    : 86ee7854 __mtlk_assert+0x34/0x14c [mtlkroot]
[ 9161.352113] Status: 1100ff03 KERNEL EXL IE
[ 9161.356292] Cause : 10800024 (ExcCode 09)
[ 9161.360298] PrId  : 00019556 (MIPS 34Kc)
[ 9161.364208] Modules linked in: mtlk(P) mtlkroot(P) pppoe nf_conntrack_ipv6 iptable_nat ipt_REJECT ipt_MASQUERADE xt_time xt_tcpudp xt_state xt_nat xt_multiport xt_mark xt_mac xt_limit xt_conntrack xt_comment xt_TCPMSS xt_REDIRECT xt_LOG pppox ppp_async nf_reject_ipv4 nf_nat_redirect nf_nat_masquerade_ipv4 nf_conntrack_ipv4 nf_nat_ipv4 nf_nat nf_log_ipv4 nf_defrag_ipv6 nf_defrag_ipv4 nf_conntrack_rtcache nf_conntrack ltq_deu_vr9 lib80211_crypt_wep lib80211_crypt_tkip lib80211_crypt_ccmp lib80211 iptable_mangle iptable_filter ip_tables crc_ccitt compat drv_dsl_cpe_api ledtrig_usbport drv_mei_cpe ip6t_REJECT nf_reject_ipv6 nf_log_ipv6 nf_log_common ip6table_mangle ip6table_filter ip6_tables x_tables pppoatm ppp_generic slhc br2684 atm drv_ifxos dwc2 gpio_button_hotplug
[ 9161.432199] Process hostapd (pid: 3176, threadinfo=864c8000, task=8723e1c0, tls=777ffd48)
[ 9161.440369] Stack : 00000000 00000000 00000022 00000001 00000894 865a9218 0000189d 8653839c
[ 9161.448722]         00000002 864c9cf8 ffffffe7 00000022 00000001 0000189d 86ed7ca0 865a9218
[ 9161.457078]         00000001 864c9ddc 86547c84 86582844 81082560 00000000 8054d0a0 00010000
[ 9161.465434]         00000022 00040933 00000001 ffffffe7 865c0a60 865b0000 00000022 86ed7ca0
[ 9161.473790]         864c9e30 ffffffe7 864c9ddc 86533a98 874625f0 800ae458 864ce480 801b1ae0
[ 9161.482145]         ...
[ 9161.484586] Call Trace:
[ 9161.487050] [&lt;86ee7854&gt;] __mtlk_assert+0x34/0x14c [mtlkroot]
[ 9161.492933] [&lt;8653839c&gt;] _mtlk_df_ui_reset_stats_proc+0x4194/0xea60 [mtlk]
[ 9161.499760] Code: afbf001c  0c02b48f  2484deb8 &lt;000c000d&gt; 00000000  00000000  27bdffe8  afb00010  afbf0014
[ 9161.509303]
[ 9161.510934] ---[ end trace 36ecc0b034118365 ]---
e: /etc/hostapd/h[ 9161.522125] Kernel panic - not syncing: Fatal exception
[ 9161.532238] Rebooting in 3 seconds..</code></pre></div><br /><p>Any ideas on what to try next?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p369907">
				<div class="post-metadata">
					<div class="post-num">Post #134</div>
					<div class="post-author">blackadder1000</div>
					<div class="post-datetime">
						22 Dec 2017, 13:01					</div>
				</div>
				<div class="post-content content">
					<p>@vittorio88 Congratulations on your progress! Some serious debugging work you put in there.</p><p>I was looking at your error &quot;IWPRIV #0x0022 being processed&quot;. Are you using lpm11&#039;s script for patching between /etc/config/wireless and the driver? I wonder if there are some commands in that script which need running before hostapd will work correctly. <br />e.g. are you running &quot;iwpriv wlan0 sCountry IT&quot; before you run hosapd? It sounds like you are but thought it was worth checking.</p><p>lpm11&#039;s script also runs &quot;iwpriv wlan0 sMAC $macaddr&quot; - are you running something like this?</p><p>Also, what does your hostapd.conf look like?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p370252">
				<div class="post-metadata">
					<div class="post-num">Post #135</div>
					<div class="post-author">vittorio88</div>
					<div class="post-datetime">
						30 Dec 2017, 23:36					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>blackadder1000 wrote:</cite><blockquote><p>@vittorio88 Congratulations on your progress! Some serious debugging work you put in there.</p></blockquote></div><p>Thanks!</p><br /><br /><div class="quotebox"><cite>blackadder1000 wrote:</cite><blockquote><p>I was looking at your error &quot;IWPRIV #0x0022 being processed&quot;.</p></blockquote></div><p>I got past this error somehow...</p><br /><br /><div class="quotebox"><cite>blackadder1000 wrote:</cite><blockquote><p>Are you using lpm11&#039;s script for patching between /etc/config/wireless and the driver? I wonder if there are some commands in that script which need running before hostapd will work correctly.</p></blockquote></div><p>I downloaded mtlk.sh, however it hangs on the first step.<br /></p><div class="codebox"><pre><code>root@vitto-rtr2:/# /lib/wifi/mtlk.sh
/lib/wifi/mtlk.sh: line 1: append: not found</code></pre></div><p>Who is supposed to call /lib/wifi/mtlk.sh???</p><br /><br /><div class="quotebox"><cite>blackadder1000 wrote:</cite><blockquote><p>e.g. are you running &quot;iwpriv wlan0 sCountry IT&quot; before you run hosapd? It sounds like you are but thought it was worth checking.</p></blockquote></div><p>Yes. I was setting the country, if I don&#039;t hostapd refuses to go forward.</p><br /><br /><div class="quotebox"><cite>blackadder1000 wrote:</cite><blockquote><p>lpm11&#039;s script also runs &quot;iwpriv wlan0 sMAC $macaddr&quot; - are you running something like this?</p></blockquote></div><p>I tried, no difference. It seems to set a MAC automatically upon insmod mtlk ap=1.<br /></p><div class="codebox"><pre><code>mtlk1(mtlk_pdb_set_mac:401): &lt;&lt; set MAC param: id(2) MAC(00:09:86:00:00:00)
mtlk1(_mtlk_core_set_mac_addr:3557): CID-0000: New MAC: 00:09:86:00:00:00</code></pre></div><br /><br /><br /><div class="quotebox"><cite>blackadder1000 wrote:</cite><blockquote><p>Also, what does your hostapd.conf look like?</p></blockquote></div><br /><div class="codebox"><pre><code>root@vitto-rtr2:~# cat /etc/hostapd/hostapd.conf
driver=mtlk
interface=wlan0
channel=11
bridge=br-lan
ssid=testing2g
hw_mode=g</code></pre></div><br /><p>I am now able to run hostapd without crashing. It creates an SSID according to the settings in hostapd.conf. I can connect, and I still get the &quot;SOURCE of RX packet not found!&quot; error. Network traffic doesn&#039;t pass through to bridge. rmmod mtlk causes kernel panic.</p><br /><p>Also getting following failures:<br /></p><div class="codebox"><pre><code>mtlk2(access_mib_value:192): UM_MAN_SET_MIB_REQ failed, u16ObjectID = 0x0081, status = 0x0010</code></pre></div><p>and</p><div class="codebox"><pre><code>mtlk2(complete_or_continue:451): Scan completed
mtlk2(aocs_select_sm_randomly:1877): Cannot select randomly SM channel
mtlk2(aocs_select_non_sm_best:1905): Selected best non-SM channel 5</code></pre></div><br /><br /><p>Thanks for the help, and Happy New Years to everybody reading!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p370678">
				<div class="post-metadata">
					<div class="post-num">Post #136</div>
					<div class="post-author">Aeronaut84</div>
					<div class="post-datetime">
						9 Jan 2018, 15:08					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>I have an VR200v with USBTTY attached and would like to get the WIFI working... <br /><a href="https://pastebin.com/AQhFH6mZ">lspci -vv here</a></p><p>If you have something to test, I will do it...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p370683">
				<div class="post-metadata">
					<div class="post-num">Post #137</div>
					<div class="post-author">vittorio88</div>
					<div class="post-datetime">
						9 Jan 2018, 16:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Aeronaut84 wrote:</cite><blockquote><p>Hello,</p><p>I have an VR200v with USBTTY attached and would like to get the WIFI working... <br /><a href="https://pastebin.com/AQhFH6mZ">lspci -vv here</a></p><p>If you have something to test, I will do it...</p></blockquote></div><p>1st step is compiling the kernel module. I recommend you work of my Git repo, because Mandrake&#039;s does not yet include the fix for kernels greater than 4.5, such as that present in LEDE trunk.</p><p>2nd step is compiling hostapd from blackadder1000&#039;s git.</p><p>3rd step is using the mtlk.sh script provided by lpm11 for initializing hostapd and creating the network bridge using OpenWRT config files. -&gt; I am blocked here.</p><p>Amongst the first commands in mtlk.sh is append(). I do not know where I am supposed to get the append command, or with what command interpreter I am supposed to call /lib/wifi/mtlk.sh, so that the append command is understood. I simply get append: command not found, upon executing this script.</p><p>I believe we are very close to getting working wifi...</p><p>P.S. Since you have a VR200/VR200v, you need to manually compile lede trunk in order to see the WAVE300 chip with lspci because the latest official release 17.01.4 does not yet include the patch I submitted to enable the WAVE300 chip.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p370684">
				<div class="post-metadata">
					<div class="post-num">Post #138</div>
					<div class="post-author">blackadder1000</div>
					<div class="post-datetime">
						9 Jan 2018, 16:36					</div>
				</div>
				<div class="post-content content">
					<p>@vittorio88</p><p>The settings in /etc/config/wireless are applied to the WAVE300 hardware through the mtlk.sh script. I just have to define the driver in /etc/config/wireless as &quot;mtlk&quot; and OpenWRT magically takes care of the rest. I don&#039;t know enough about OpenWRT to work out what actually does that. (see below)</p><p>Sounds like you&#039;re up to a similar point to myself. You can connect to the SSID but with no traffic. I&#039;m guessing even DHCP doesn&#039;t work for you.</p><p>As well as hostapd have you set up an ethernet bridge?<br />e.g. brctl addif br-lan wlan0<br />I&#039;m not sure if the line &quot;bridge=br-lan&quot; in hostapd does this for you.</p><p>(here)<br />There should be /lib/functions.sh which reads the /etc/network config files and includes the definition of append:</p><p><a href="https://dev.openwrt.org/browser/trunk/package/base-files/files/lib/functions.sh">https://dev.openwrt.org/browser/trunk/p … nctions.sh</a><br /><a href="https://github.com/lede-project/source/blob/master/package/base-files/files/lib/functions.sh">https://github.com/lede-project/source/ … nctions.sh</a></p><p>This old documentation helped:<br /><a href="http://archive.openwrt.org/kamikaze/8.09.2/docs/openwrt.html">http://archive.openwrt.org/kamikaze/8.0 … enwrt.html</a></p><p>But what calls function.sh ...</p>											<p class="post-edited">(Last edited by <strong>blackadder1000</strong> on 9 Jan 2018, 19:42)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p375942">
				<div class="post-metadata">
					<div class="post-num">Post #139</div>
					<div class="post-author">vittorio88</div>
					<div class="post-datetime">
						19 Apr 2018, 01:26					</div>
				</div>
				<div class="post-content content">
					<p>Hello,</p><p>Sorry blackadder1000, but I have been busy, and had a few gaps in my knowledge with regards on how to proceed.<br />Your information was very helpful.</p><p>I am not too sure, but I believe that using hostapd, wpa_supplicant, /lib/functions.sh, /etc/network/config may be jumping the gun a little bit. I think that until we can ping through wireless connection without those utilities, we should focus on possible driver issues. </p><p>I would be grateful if anybody could correct me, but I believe that the minimum required to ping through a wireless link on linux are:<br /></p><div class="codebox"><pre><code>iwpriv wlan0 sCountry IT
iwconfig wlan0 essid test-24ghz
iwconfig wlan0 channel 1
ifconfig wlan0 up
ifconfig wlan0 192.168.80.1

# connect from remote computer
# set static ip 192.168.80.2 on remote computer
ping 192.168.80.1</code></pre></div><p>With this configuration, ping should be possible without hostapd on an open network to the best of my knowledge.</p><p>This brings me back to the driver. I have worked on it to render it more easy to build. The latest version is available at:<br /><a href="https://github.com/vittorio88/WAVE300">https://github.com/vittorio88/WAVE300</a> with step-by-step build instructions starting from scratch.</p><p>From the output of ifconfig, it seems no packets are getting to the linux IP stack, they get dropped on TX and nothing comes on RX:<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# ifconfig
wlan0     Link encap:Ethernet  HWaddr 00:09:86:00:00:00
          inet addr:192.168.80.1  Bcast:192.168.80.255  Mask:255.255.255.0
          inet6 addr: fe80::209:86ff:fe00:0/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:965 overruns:0 carrier:0
          collisions:172 txqueuelen:1000
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

root@OpenWrt:~# iwconfig
wlan0     802.11bgn  ESSID:&quot;test-24ghz&quot;
          Mode:Master  Frequency=2.412 GHz  Access Point: 00:09:86:00:00:00
          Tx-Power=20 dBm
          RTS thr=1600 B
          Encryption key:off
          Link Quality:0  Signal level:0  Noise level:0
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:9452  Invalid misc:4366   Missed beacon:0</code></pre></div><br /><p>To me this means that something between the driver and the IP packet stack of linux is broken. The channel for configuration, however does work adequately, as iwconfig works perfectly. To communicate between iwconfig and the MTLK driver, it seems that IOCTLs are used for pretty much everything for configuration of the HW.</p><p>A lot of the work in making the driver run on newer kernels had to do with up-porting netlink and procfs, so I wouldn&#039;t be surprised if the problem was there.</p><p>It is probably not a procfs issue because the procfs files /proc/net/wireless and /proc/net/dev seem to be fine.<br />(There are issues deinitializing the procfs which lead to backtrace upon on rmmod of mtlk.ko), but it seems to cause no harm.</p><p>This leads me to think the netlink porting is the culprit of the non-functioning driver.<br />Reading the code, I find the following snippet:<br /></p><div class="codebox"><pre><code>int mtlk_nl_init(void)
{
  /* netlink groups that are expected:
   * 1 - is joined by hostapd, wpa_supplicant and drvhlpr
   * 2 - is joined by wsccmd (Simple Config)
   * 3 - is joined by IRB media
   * so, total number of 3 groups must be told to kernel
   * when creating socket
   */</code></pre></div><p>So from what I understand, in addition to using iwconfig and IOCTLs;&nbsp; hostapd, wpa_supplicant and drvhlpr also can configure the MTLK driver through netlink groups. <br />Unfortunately I do not know what groups 2 and 3 are (wsccmd and IRB media). If anybody knows the answer there I would be very grateful!<br />If those netlink groups (2 and 3) could be the ones used to send packets through the kernel from driver to IP stack, then it is very likely that this is where the driver is broken.</p><p>Netlink being broken would also explain hostapd not working.</p><p>Anyway, I hope someone here knows the answer, because I would very much like to get this WiFi working before the whole router is completely obsolete <img src="https://forum.openwrt.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>- Vittorio</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 6 of 6</div><nav><ul><li><a href="viewtopic.php%3Fid=45047&amp;p=1.html">1</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=45047&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=45047&amp;p=5.html">5</a></li><li class="pagination-current"><span>6</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>