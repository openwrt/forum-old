<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> ar9331&#039;s usb stability issue - [SOLVED]</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							between 23 Mar 2017 and 6 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 3 of 13</div><nav><ul><li><a href="viewtopic.php%3Fid=39956&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=2.html">2</a></li><li class="pagination-current"><span>3</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=5.html">5</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=13.html">13</a></li></ul></nav></div>
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			
		
		
			<article class="post" id="p182529">
				<div class="post-metadata">
					<div class="post-num">Post #51</div>
					<div class="post-author">TheRaster</div>
					<div class="post-datetime">
						6 Nov 2012, 14:51					</div>
				</div>
				<div class="post-content content">
					<p>I thought it was that the router did not have enough amps to power usb and wifi.<br/>So I added a 42amp psu to the router. Same problem. So then I added usb 1.0 belkin hub with a 4amp psu. Still same prob.<br/>Then I added a belkin usb 2.0 hub with a 5amp psu. Still the problem of hanging persists.</p><p>So im at a loss with this one but there is no need for the router to be drawing power from the usb when its got powered usb hubs in it.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182540">
				<div class="post-metadata">
					<div class="post-num">Post #52</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						6 Nov 2012, 16:27					</div>
				</div>
				<div class="post-content content">
					<p>If I am using the same &quot;Octopus&quot; hub as in this topic (<a href="https://forum.openwrt.org/viewtopic.php?pid=155706#p155706">https://forum.openwrt.org/viewtopic.php … 06#p155706</a>), I don&#039;t have the problem, I can even connect 2 Arduino boards at the same time and they work perfectly for over a day.</p><p>So it is not a power supply wattage problem, but more like the power supply dipping or a low-level conflict when the Wifi radio does something, thus hanging the USB.</p><p>Adding larger decoupling capacitors did not solve things.</p><p>The &quot;Octopus&quot; hub above is based on the GL850G USB hub chip and is a passive hub.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182543">
				<div class="post-metadata">
					<div class="post-num">Post #53</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						6 Nov 2012, 16:40					</div>
				</div>
				<div class="post-content content">
					<p>My feeling is the same as @squonk... there is some power instability issues introduced by the wifi which are smoothed out when using a passive (non-powered) USB hub... I have never seen any issues with my USB devices when using a passive hub.&nbsp; I am using a FE1.1 based (by Terminus) 2.0 4 Port Hub controller.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182594">
				<div class="post-metadata">
					<div class="post-num">Post #54</div>
					<div class="post-author">rickysland</div>
					<div class="post-datetime">
						7 Nov 2012, 03:58					</div>
				</div>
				<div class="post-content content">
					<p>My point is: TP-link could make it perfect work with the same hardware. This can prove that it&#039;s no problem with the&nbsp; power or electrolytic.It must can solve this with sofeware.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182606">
				<div class="post-metadata">
					<div class="post-num">Post #55</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						7 Nov 2012, 09:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>rickysland wrote:</cite><blockquote><p>My point is: TP-link could make it perfect work with the same hardware. This can prove that it&#039;s no problem with the&nbsp; power or electrolytic.It must can solve this with sofeware.</p></blockquote></div><p>No, we cannot say that TP-Link can make it perfectly work with the same hardware, as we are not sure that the problem doesn&#039;t occur with TP-Link&#039;s firmware too, as we have no way to stress it with the exact same tests.</p><p>And the fact that the problem also occurs on the Alfa AP121U and other devices suggests that it is not something related to TP-Link only.</p><p>Maybe using the original firmware (TP-Link and others) to continuously send data through a 3G USB modem might produce something that comes close to our test, but there may quite well be some reconnection mechanism built inside the firmware too, so this is something to verify, too.</p><p>Streaming sound is not a good test, as it looks like the problem does not show (or it was unnoticed) when using USB isochronous data.</p><p>However, from the sources that TP-Link delivered under GPL (and that are older than the latest firmwares: 12/12/2011), there is apparently no special provision for correcting such a problem.</p>											<p class="post-edited">(Last edited by <strong>Squonk</strong> on 7 Nov 2012, 09:22)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182631">
				<div class="post-metadata">
					<div class="post-num">Post #56</div>
					<div class="post-author">mips</div>
					<div class="post-datetime">
						7 Nov 2012, 14:15					</div>
				</div>
				<div class="post-content content">
					<p>Try to watch the register 0xb8116c84 and 0xb8116c88,check the value before and after wlan reset,and restore the value back when do wlan reset to workaround this &quot;wlan vs usb&quot; bug.There are many hang check in ath9k driver,and also current the ath9k driver is not stable enough for use,it&#039;s wlan reset very often,though nbd fix some deeply bug in the recently svn change,we still need dig the ath9k source code,the ath9k is not stable enough to do the AA formal release...<br/>I get some info from atheros SDK,but i&#039;m not test it and don&#039;t make sure it&#039;s work for this topic.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182638">
				<div class="post-metadata">
					<div class="post-num">Post #57</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						7 Nov 2012, 15:16					</div>
				</div>
				<div class="post-content content">
					<p>Hello @mips.&nbsp; </p><p>You seem to be quite knowledgeable about mips and the ar9k processors.&nbsp; Your input is much appreciated.&nbsp; I am trying to understand your post.&nbsp; &nbsp;It looks like there is some information here that might help us address the problems with the USB on most (all?) comercial routers based on the AR9331 processor.&nbsp; </p><p>The registers you refer to here (0xb8116c84 and 0xb8116c88) are these for the wlan or for the USB interface?&nbsp; What are these registers? do they contain status information?&nbsp; </p><p>it seems that the ath9k kernel code does a lot of checking and resetting the state of the wlan registers.&nbsp; &nbsp; Your suggestion is to go through the code looking for every wlan reset and before doing the reset check the status of registers 0xb8116c84 and 0xb8116c88 and before the reset, record the values, and then restore them after the wlan reset.&nbsp; Is this correct?</p><p>You also state that the linux ath9k drivers are deeply flawed and that its not sable enough for sable enough for stable release.&nbsp; &nbsp;I am curious to hear more about this.&nbsp; Are you specifically referring to the wlan operation or are there other deeper and unrelated issues?</p><p>could you give an example of the reset code you are referring to?&nbsp; Could you also give an example of what you mean by testing and setting the registers?</p><p>I am trying to get a clear understanding of you suggestions so that we can try to implement them.&nbsp; I am happy to go through the code making the changes to test.&nbsp; We have a number of routers here (about 15 from different manufacturers) that all exhibit the issue.&nbsp; I am happy to experiment with any code changes you suggest.</p><p>Thank you for your input..</p><p>--luis</p>											<p class="post-edited">(Last edited by <strong>lsoltero</strong> on 7 Nov 2012, 15:18)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182639">
				<div class="post-metadata">
					<div class="post-num">Post #58</div>
					<div class="post-author">TheRaster</div>
					<div class="post-datetime">
						7 Nov 2012, 15:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Squonk wrote:</cite><blockquote><p>Maybe using the original firmware (TP-Link and others) to continuously send data through a 3G USB modem might produce something that comes close to our test, but there may quite well be some reconnection mechanism built inside the firmware too, so this is something to verify, too.</p></blockquote></div><p>I have been using TP-link routers now for 4 months + with 3G (DC-HSDPA+) as my main internet TP-Links FW are verry buggy for 3g wan. With lots of problems. This is why I moved over to WRT over the last 4 weeks of playing with the routers I have the same problem on both routers. But the USB only drops when uploading on speedtest.net It is fine on any other upload.<br/>It drops on any flash app the uploads...?</p><p>Even over wifi on mobiles iOS and android speedtest apps make the router drop the usb port. BUT ONLY when up load starts.</p><p>I download files from news groups fine, And download from torrents fine on it. I have speeds of up to 16mbit at the min (making new antenna over the next fue days) The GF is allways streaming from the net. On average I use around 20-70gig a month.</p><p>Im going to put a usb HDD on it later this week and see how acting as a FTP server works with it.</p><p>What ever this is I do hope we can find a fix.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182640">
				<div class="post-metadata">
					<div class="post-num">Post #59</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						7 Nov 2012, 15:30					</div>
				</div>
				<div class="post-content content">
					<p>Hi @mips</p><p>On my router, I don&#039;t have WLAN problems, only the USB will hang, but only when WLAN is activated. And in this case, WLAN continues to work perfectly, and I don&#039;t have any problem with it.</p><p>It is only the problem that the USB is stuck until you disconnect/reconnect the device, or you use a passive USB hub in the middle to solve the issue.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182642">
				<div class="post-metadata">
					<div class="post-num">Post #60</div>
					<div class="post-author">robthebrew</div>
					<div class="post-datetime">
						7 Nov 2012, 15:50					</div>
				</div>
				<div class="post-content content">
					<p>hope you don&#039;t mind me throwing a totally uneducated thought in:<br/>on unpowered hubs, is there some sort of data cache for &quot;brown outs&quot; in the supply? Just a wildly uninformed thought.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182645">
				<div class="post-metadata">
					<div class="post-num">Post #61</div>
					<div class="post-author">mips</div>
					<div class="post-datetime">
						7 Nov 2012, 16:46					</div>
				</div>
				<div class="post-content content">
					<p>Hi @Squonk:<br/>The ath9k driver is not stable in some case,just like the long run and the high throughput or complex wifi environment...Though you feel the WLAN continues to work perfectly,but the wlan part of the ar9331 may reset many times,you can add a &quot;printk&quot; in the &quot;ar933x_wmac_reset&quot; function,check if you can see some log when the usb hang.<br/>About the ar933x_wmac_reset function,refer here:<br/><a href="https://github.com/mirrors/openwrt/blob/master/target/linux/ar71xx/patches-3.3/650-MIPS-ath79-fix-ar933x-reset.patch">https://github.com/mirrors/openwrt/blob … eset.patch</a><br/>About the ath9k stable issue,refer here:<br/><a href="https://dev.openwrt.org/ticket/9654">https://dev.openwrt.org/ticket/9654</a></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182646">
				<div class="post-metadata">
					<div class="post-num">Post #62</div>
					<div class="post-author">mips</div>
					<div class="post-datetime">
						7 Nov 2012, 17:14					</div>
				</div>
				<div class="post-content content">
					<p>Hi @lsoltero:</p><p>Because the NDA,I can not do some thing...so sorry!<br/>So please dump the register 0xb8116c84 and 0xb8116c88 before usb hang,and dump them after usb hang and show here.If there are some different,maybe the tips get from the atheros SDK can have a try on this bug.<br/>If this is a chip level bug,so only the atheros know how to fix it.So maybe atheros SDK based firmware don&#039;t have this bug,if every atheros SDK based firmware also have this bug,maybe we have no hope to fix it...<br/>About the ath9k driver,many people report the stable issue,it&#039;s can run and use,but should fix more to be a product.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182648">
				<div class="post-metadata">
					<div class="post-num">Post #63</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						7 Nov 2012, 17:38					</div>
				</div>
				<div class="post-content content">
					<p>@mips: I use the latest SVN from the AA Beta 2 branch, so I already have this patch applied.</p><p>As you asked, I added a <br/></p><div class="codebox"><pre><code>    pr_err(&quot;ar933x: WMAC reset called&quot;);</code></pre></div><p>... just upon entering the ar9331x_wmac_reset() function and will perform the same test again. I will let you know.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182650">
				<div class="post-metadata">
					<div class="post-num">Post #64</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						7 Nov 2012, 18:07					</div>
				</div>
				<div class="post-content content">
					<p>while you are at it could you add a</p><p>pr_err(&quot;ar933x reg dump: 0x%x, 0x%x&quot;, __raw_readl(0xb8116c84), __raw_readl(0xb8116c88));</p><p>so that we can see the values of the registers @mips is referring to in his post before and after a USB hang.</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182659">
				<div class="post-metadata">
					<div class="post-num">Post #65</div>
					<div class="post-author">TheRaster</div>
					<div class="post-datetime">
						7 Nov 2012, 20:22					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>robthebrew wrote:</cite><blockquote><p>hope you don&#039;t mind me throwing a totally uneducated thought in:<br/>on unpowered hubs, is there some sort of data cache for &quot;brown outs&quot; in the supply? Just a wildly uninformed thought.</p></blockquote></div><p>Been over this befor....</p><div class="quotebox"><cite>TheRaster wrote:</cite><blockquote><p>I thought it was that the router did not have enough amps to power usb and wifi.<br/>So I added a 42amp psu to the router. Same problem. So then I added usb 1.0 belkin hub with a 4amp psu. Still same prob.<br/>Then I added a belkin usb 2.0 hub with a 5amp psu. Still the problem of hanging persists.</p><p>So im at a loss with this one but there is no need for the router to be drawing power from the usb when its got powered usb hubs in it.</p></blockquote></div><br/><p>Wish to point out the router was runing on a 42 Amp 12v PSU made to run 10 meter band radio amplifier. so 100% no chance its a underpowered problem.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182668">
				<div class="post-metadata">
					<div class="post-num">Post #66</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						7 Nov 2012, 23:14					</div>
				</div>
				<div class="post-content content">
					<p>@mips:</p><p>The USB problem happened after almost 1 hour running OK.</p><p>I have no way to directly print the registers before/after the crash, so I inserted the following lines at the beginning of the&nbsp; ar933x_wmac_reset() function:</p><div class="codebox"><pre><code>  pr_err(&quot;ar933x: WMAC reset called&quot;);
  pr_err(&quot;ar933x reg dump: 0x%x, 0x%x&quot;, __raw_readl((const volatile void *) 0xb8116c84), __raw_readl((const volatile void *) 0xb8116c88));]</code></pre></div><p>I then toggled the radio off/on using the LuCI web interface:</p><div class="codebox"><pre><code>[  937.490000] ath: phy0: Could not stop RX, we could be confusing the DMA engine when we start RX up
[  937.510000] ath: phy0: Failed to stop TX DMA, queues=0x001!
[  937.510000] ar933x: WMAC reset called
[  937.520000] ar933x reg dump: 0xdeadbeef, 0xdeadbeef
[  938.130000] wlan0: authenticate with 00:24:d4:d0:be:08
[  938.140000] wlan0: send auth to 00:24:d4:d0:be:08 (try 1/3)
[  938.150000] wlan0: authenticated
[  938.150000] ath9k ar933x_wmac: wlan0: disabling HT/VHT due to WEP/TKIP use
[  938.170000] wlan0: associate with 00:24:d4:d0:be:08 (try 1/3)
[  938.170000] wlan0: RX AssocResp from 00:24:d4:d0:be:08 (capab=0x411 status=0 aid=2)
[  938.180000] wlan0: associated</code></pre></div><p><a href="http://imageshack.us/photo/my-images/208/capture1ed.png/"><span class="postimg"><img src="http://img208.imageshack.us/img208/8165/capture1ed.png" alt="http://img208.imageshack.us/img208/8165/capture1ed.png"/></span></a></p><p>I then inserted the Arduino Leonardo board that sends a counter every second while flashing its&quot;D13&quot; LED:</p><div class="codebox"><pre><code>[  944.250000] usb 1-1: new full-speed USB device number 4 using ehci-platform
[  944.400000] cdc_acm 1-1:1.0: ttyACM0: USB ACM device
[  952.000000] usb 1-1: USB disconnect, device number 4
[  952.290000] usb 1-1: new full-speed USB device number 5 using ehci-platform
[  952.450000] cdc_acm 1-1:1.0: This device cannot do calls on its own. It is not a modem.
[  952.450000] cdc_acm 1-1:1.0: ttyACM0: USB ACM device</code></pre></div><p>The problem occurred after 3512 seconds, but there is no call to ar933x_wmac_reset() when this happens, and the network graph looks good:</p><p><a href="http://imageshack.us/photo/my-images/545/capture2zp.png/"><span class="postimg"><img src="http://img545.imageshack.us/img545/5919/capture2zp.png" alt="http://img545.imageshack.us/img545/5919/capture2zp.png"/></span></a></p><p>Then, to get a register dump, I stopped/restarted the radio again:</p><div class="codebox"><pre><code>[ 4525.190000] wlan0: deauthenticating from 00:24:d4:d0:be:08 by local choice (reason=3)
[ 4533.750000] ath: phy0: Failed to stop TX DMA, queues=0x001!
[ 4533.760000] ar933x: WMAC reset called
[ 4533.760000] ar933x reg dump: 0xdeadbeef, 0xdeadbeef
[ 4534.370000] wlan0: authenticate with 00:24:d4:d0:be:08
[ 4534.380000] wlan0: send auth to 00:24:d4:d0:be:08 (try 1/3)
[ 4534.390000] wlan0: authenticated
[ 4534.390000] ath9k ar933x_wmac: wlan0: disabling HT/VHT due to WEP/TKIP use
[ 4534.410000] wlan0: associate with 00:24:d4:d0:be:08 (try 1/3)
[ 4534.410000] wlan0: RX AssocResp from 00:24:d4:d0:be:08 (capab=0x411 status=0 aid=2)
[ 4534.420000] wlan0: associated</code></pre></div><br/><p><a href="http://imageshack.us/photo/my-images/717/capture3cr.png/"><span class="postimg"><img src="http://img717.imageshack.us/img717/200/capture3cr.png" alt="http://img717.imageshack.us/img717/200/capture3cr.png"/></span></a></p><p>The WLAN was still working correctly, and it looks like there is no reset during this hour of testing.</p><p>Let me know if I can do some other tests, but I have no easy way to trigger something automatically when this happens.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182728">
				<div class="post-metadata">
					<div class="post-num">Post #67</div>
					<div class="post-author">mips</div>
					<div class="post-datetime">
						8 Nov 2012, 17:30					</div>
				</div>
				<div class="post-content content">
					<p>@Squonk:<br/>I don&#039;t know why the 0xb8116c84 and 0xb8116c88,from the ds it&#039;s don&#039;t have any info about these address.<br/>Can you add a &quot;while and sleep&quot; kernel thread to dump the 0xbb000184 and 0xbb000188,check the value before and after usb hang.Or you can add a kernel timer when the ath9k driver init,dump the 0xbb000184 and 0xbb000188 value and update the timer to do the next dump.<br/>the 0xbb000184 is the &quot;Port/Status Control&quot; register,but ds don&#039;t say anything about the 0xbb000188 register.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182731">
				<div class="post-metadata">
					<div class="post-num">Post #68</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						8 Nov 2012, 17:48					</div>
				</div>
				<div class="post-content content">
					<p>hello @mips,</p><p>i am trying to understand your postings.&nbsp; </p><p>You state that you dont have any information on 0xb8116c84 and 0xb8116c88. However in a previous post<br/><a href="https://forum.openwrt.org/viewtopic.php?pid=182631#p182631">https://forum.openwrt.org/viewtopic.php … 31#p182631</a><br/>you stated that these were the addresses that should be monitored.</p><p>can you confirm that the correct addresses to monitor are 0xbb000184 and 0xbb000188?&nbsp; These make more sense than the previous since they are in line with the AR9331 base register.</p><p>Where did the code for this posting<br/><a href="https://forum.openwrt.org/viewtopic.php?pid=182727#p182727">https://forum.openwrt.org/viewtopic.php … 27#p182727</a><br/>come from?&nbsp; &nbsp;have looked through the source tree for WAR_USB_DISABLE... and not found any entries for this.</p><p>it would be good to know that sources you are looking at and where this WAR_USB_DISABLE_PLL_LOCK_DETECT is called.</p><p>this looks important.</p><p>thanks,</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182738">
				<div class="post-metadata">
					<div class="post-num">Post #69</div>
					<div class="post-author">Squonk</div>
					<div class="post-datetime">
						8 Nov 2012, 20:40					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>mips wrote:</cite><blockquote><p>@Squonk:<br/>I don&#039;t know why the 0xb8116c84 and 0xb8116c88,from the ds it&#039;s don&#039;t have any info about these address.<br/>Can you add a &quot;while and sleep&quot; kernel thread to dump the 0xbb000184 and 0xbb000188,check the value before and after usb hang.Or you can add a kernel timer when the ath9k driver init,dump the 0xbb000184 and 0xbb000188 value and update the timer to do the next dump.<br/>the 0xbb000184 is the &quot;Port/Status Control&quot; register,but ds don&#039;t say anything about the 0xbb000188 register.</p></blockquote></div><p>@mips:</p><p>Yes, I will add a kernel thread to monitor these registers.</p><p>However, I will not be able to do that before next week, so if someone else can perform the test, the hardware and software setup required to reproduce the crash is pretty simple, anyway.</p><p>Please, don&#039;t take any risk with what you say, we know it is very difficult to have information and not be able to say anything <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile"/></p>											<p class="post-edited">(Last edited by <strong>Squonk</strong> on 8 Nov 2012, 20:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182770">
				<div class="post-metadata">
					<div class="post-num">Post #70</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						9 Nov 2012, 06:23					</div>
				</div>
				<div class="post-content content">
					<p>sorry folks... i have been out of the office all day... i will add the kernel thread to dump the register settings every second and then reproduce the error and report back.. probably sometime tomorrow.</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182799">
				<div class="post-metadata">
					<div class="post-num">Post #71</div>
					<div class="post-author">mips</div>
					<div class="post-datetime">
						9 Nov 2012, 14:09					</div>
				</div>
				<div class="post-content content">
					<p>@Squonk:<br/>Thanks for your reminding,I edit it and only keep the core part ...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182804">
				<div class="post-metadata">
					<div class="post-num">Post #72</div>
					<div class="post-author">mips</div>
					<div class="post-datetime">
						9 Nov 2012, 14:23					</div>
				</div>
				<div class="post-content content">
					<p>@lsoltero:<br/>Sorry for making you confuse...the 0xb8116c84 and 0xb8116c88 are get from the code.but it&#039;s not a valid access from the datasheet.So reference the code and datasheet,I guess we can try the 0xbb000184 and 0xbb000188,but just guess ...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182856">
				<div class="post-metadata">
					<div class="post-num">Post #73</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						10 Nov 2012, 01:49					</div>
				</div>
				<div class="post-content content">
					<p>@mips:</p><p>OK. thank you for that... I had intended to get to this today but was unable to... I will try tomorrow capturing the status of all the registers you mention and post my results here.&nbsp; </p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182915">
				<div class="post-metadata">
					<div class="post-num">Post #74</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						10 Nov 2012, 22:19					</div>
				</div>
				<div class="post-content content">
					<p>so i modified the code to dump the following registers...</p><br/><p>&nbsp; &nbsp; &nbsp; &nbsp;pr_err(&quot;ar933x reg dump: 0x%x, 0x%x, 0x%x, 0x%x&quot;, __raw_readl((const volatile void *) 0xbb000184), __raw_readl((const volatile void *) 0xbb000188),<br/>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __raw_readl((const volatile void *) 0xb8116c84), __raw_readl((const volatile void *) 0xb8116c88));</p><br/><p>[&nbsp; &nbsp;38.570000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;39.580000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;40.590000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;41.600000] ar933x reg dump: 0x10001801, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;41.820000] usb 1-1: new full-speed USB device number 2 using ehci-platform<br/>[&nbsp; &nbsp;41.980000] cdc_acm 1-1:1.0: ttyACM0: USB ACM device</p><p>the registers changed when the USB device was plugged in...</p><p>PPPD was then started.<br/>[&nbsp; &nbsp;42.610000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;43.620000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;44.650000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;45.670000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;46.720000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;47.740000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; &nbsp;48.750000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c</p><p>but there was no change in the values of the registers when the interface hung...</p><p>the USB was then removed... the registers changed.</p><br/><p>root@Optimizer:/# <br/>[&nbsp; 302.290000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 303.300000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 303.600000] usb 1-1: USB disconnect, device number 2<br/>[&nbsp; 303.610000] cdc_acm 1-1:1.0: acm_ctrl_irq - usb_submit_urb failed: -19<br/>[&nbsp; 304.310000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 305.320000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c</p><p>the USB was then plugged back in...</p><br/><p>[&nbsp; 382.080000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 383.090000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 384.100000] ar933x reg dump: 0x10001801, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 384.330000] usb 1-1: new full-speed USB device number 3 using ehci-platform<br/>[&nbsp; 384.490000] cdc_acm 1-1:1.0: ttyACM0: USB ACM device<br/>[&nbsp; 385.110000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 386.120000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 387.130000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c</p><br/><p>and the dialing repeated </p><br/><p>[&nbsp; 643.670000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 644.680000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 645.690000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 646.700000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 647.710000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 648.720000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c</p><br/><br/><p>i do notice that when the usb is being used (and its working the registers do change often)</p><br/><p> 598.220000] ar933x reg dump: 0x10001405, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 599.230000] ar933x reg dump: 0x10001405, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 600.240000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 601.250000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 602.260000] ar933x reg dump: 0x10001405, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 603.270000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 604.280000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 605.290000] ar933x reg dump: 0x10001405, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 606.300000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 607.310000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 608.320000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 609.330000] ar933x reg dump: 0x10001405, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 610.340000] ar933x reg dump: 0x10001405, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 611.350000] ar933x reg dump: 0x10001405, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 612.360000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 613.370000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 614.380000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c</p><br/><br/><p>i did get this when i unplugged the hung device this time...</p><p>&nbsp; 760.830000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 761.840000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 762.850000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 763.380000] usb 1-1: USB disconnect, device number 3<br/>[&nbsp; 763.380000] cdc_acm 1-1:1.0: acm_ctrl_irq - usb_submit_urb failed: -19<br/>[&nbsp; 763.860000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 763.960000] ------------[ cut here ]------------<br/>[&nbsp; 763.960000] WARNING: at drivers/tty/tty_io.c:1357 0x801849e4()<br/>[&nbsp; 763.970000] Modules linked in: pl2303 ftdi_sio usbserial snd_usb_audio snd_usbmidi_lib cdc_acm ath79_wdt ohci_hcd ledtrig_usbdev ledtrig_netdev nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp ipt_MASQUERADE iptable_nat nf_nat xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack ehci_hcd ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables tty0tty(O) snd_pcm_oss snd_mixer_oss snd_pcm snd_timer snd_rawmidi snd_seq_device snd_hwdep snd_page_alloc snd soundcore ppp_async ppp_generic slhc ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) mac80211(O) usbcore usb_common nls_base crc_ccitt cfg80211(O) compat(O) input_core arc4 aes_generic crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)<br/>[&nbsp; 764.040000] Call Trace:[&lt;802618ac&gt;] 0x802618ac<br/>[&nbsp; 764.040000] [&lt;802618ac&gt;] 0x802618ac<br/>[&nbsp; 764.050000] [&lt;800719fc&gt;] 0x800719fc<br/>[&nbsp; 764.050000] [&lt;801849e4&gt;] 0x801849e4<br/>[&nbsp; 764.050000] [&lt;80071a40&gt;] 0x80071a40<br/>[&nbsp; 764.060000] [&lt;80182c9c&gt;] 0x80182c9c<br/>[&nbsp; 764.060000] [&lt;801849e4&gt;] 0x801849e4<br/>[&nbsp; 764.060000] [&lt;800e0b4c&gt;] 0x800e0b4c<br/>[&nbsp; 764.070000] [&lt;800aa288&gt;] 0x800aa288<br/>[&nbsp; 764.070000] [&lt;800db20c&gt;] 0x800db20c<br/>[&nbsp; 764.080000] [&lt;800e0d8c&gt;] 0x800e0d8c<br/>[&nbsp; 764.080000] [&lt;800db0f8&gt;] 0x800db0f8<br/>[&nbsp; 764.080000] [&lt;800d5838&gt;] 0x800d5838<br/>[&nbsp; 764.090000] [&lt;800e43ec&gt;] 0x800e43ec<br/>[&nbsp; 764.090000] [&lt;800e462c&gt;] 0x800e462c<br/>[&nbsp; 764.090000] [&lt;8009e828&gt;] 0x8009e828<br/>[&nbsp; 764.100000] [&lt;800e4a10&gt;] 0x800e4a10<br/>[&nbsp; 764.100000] [&lt;800eedd4&gt;] 0x800eedd4<br/>[&nbsp; 764.100000] [&lt;800e1478&gt;] 0x800e1478<br/>[&nbsp; 764.110000] [&lt;800d68a0&gt;] 0x800d68a0<br/>[&nbsp; 764.110000] [&lt;80264f54&gt;] 0x80264f54<br/>[&nbsp; 764.110000] [&lt;8006a204&gt;] 0x8006a204<br/>[&nbsp; 764.120000] <br/>[&nbsp; 764.120000] ---[ end trace 069ae56fe57b7b73 ]---<br/>[&nbsp; 764.870000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 765.880000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 766.890000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 767.900000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 768.910000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 769.920000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 770.930000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 771.940000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 772.950000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c<br/>[&nbsp; 773.960000] ar933x reg dump: 0x1c001000, 0x0, 0x84100095, 0xf01b6c</p><br/><br/><p>here is an example of where the registers did not change between working and not working...</p><p>ep&nbsp; 8 16:00:22 Optimizer local2.info chat[3558]: ^M<br/>Sep&nbsp; 8 16:00:22 Optimizer local2.info chat[3558]: OK<br/>Sep&nbsp; 8 16:00:22 Optimizer local2.info chat[3558]:&nbsp; -- got it<br/>Sep&nbsp; 8 16:00:22 Optimizer local2.info chat[3558]: send (AT E0 V1 &amp;D2 &amp;C1 W2 S95=47 S0=0 +cbst=71,0,1^M)<br/>Sep&nbsp; 8 16:00:22 Optimizer kern.err kernel: [ 1000.200000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:23 Optimizer local2.info chat[3558]: timeout set to 60 seconds<br/>Sep&nbsp; 8 16:00:23 Optimizer local2.info chat[3558]: expect (OK)<br/>Sep&nbsp; 8 16:00:23 Optimizer local2.info chat[3558]: ^M<br/>Sep&nbsp; 8 16:00:23 Optimizer local2.info chat[3558]: AT E0 V1 &amp;D2 &amp;C1 W2 S95=47 S0=0 +cbst=71,0,1^M^M<br/>Sep&nbsp; 8 16:00:23 Optimizer local2.info chat[3558]: OK<br/>Sep&nbsp; 8 16:00:23 Optimizer local2.info chat[3558]:&nbsp; -- got it<br/>Sep&nbsp; 8 16:00:23 Optimizer local2.info chat[3558]: send (ATDT008816000025^M)<br/>Sep&nbsp; 8 16:00:23 Optimizer local2.info chat[3558]: expect (CONNECT)<br/>Sep&nbsp; 8 16:00:23 Optimizer local2.info chat[3558]: ^M<br/>Sep&nbsp; 8 16:00:24 Optimizer kern.err kernel: [ 1001.210000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:25 Optimizer kern.err kernel: [ 1002.220000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:26 Optimizer kern.err kernel: [ 1003.230000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:27 Optimizer kern.err kernel: [ 1004.240000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:28 Optimizer kern.err kernel: [ 1005.250000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:29 Optimizer kern.err kernel: [ 1006.260000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:30 Optimizer kern.err kernel: [ 1007.270000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:31 Optimizer kern.err kernel: [ 1008.280000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:32 Optimizer kern.err kernel: [ 1009.290000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:33 Optimizer kern.err kernel: [ 1010.300000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c<br/>Sep&nbsp; 8 16:00:34 Optimizer kern.err kernel: [ 1011.310000] ar933x reg dump: 0x10001805, 0x0, 0x84100095, 0xf01b6c</p><br/><p>so... not sure at this time if there is a correlation between the register values and working/non working USB devices.</p><p>anyone have any ideas?</p><p>--luis</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p182916">
				<div class="post-metadata">
					<div class="post-num">Post #75</div>
					<div class="post-author">lsoltero</div>
					<div class="post-datetime">
						10 Nov 2012, 22:27					</div>
				</div>
				<div class="post-content content">
					<p>I will also mention that like @Squonk I am not seeing ar933x_wmac_reset(void) called once on boot up and when the WLAN is reset.&nbsp; Otherwise this function is not being called.</p><p>--luis</p>									</div>
			</article>

			
		
			
		
	
	<div class="pagination"><div class="pagination-number">Page 3 of 13</div><nav><ul><li><a href="viewtopic.php%3Fid=39956&amp;p=1.html">1</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=2.html">2</a></li><li class="pagination-current"><span>3</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=4.html">4</a></li><li><a href="viewtopic.php%3Fid=39956&amp;p=5.html">5</a></li><li class="pagination-ellipsis"><span>...</span></li><li><a href="viewtopic.php%3Fid=39956&amp;p=13.html">13</a></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>