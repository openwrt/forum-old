<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> USB2.0 host on TPL-WR841ND v7.2 (one of the solutions)</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p138952">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">AndrewKo</div>
					<div class="post-datetime">
						12 Jul 2011, 01:10					</div>
				</div>
				<div class="post-content content">
					<p>Hello, Everybody!</p><p>I provide the solution for how to make an a USB host on 7.2 hardware.</p><br /><p>Short description:</p><p>1. materials and tools:<br />&nbsp; &nbsp; 1.1 USB type A connector. I use USB connector from PS2&lt;-&gt;USB (from old mouse) adapter;<br />&nbsp; &nbsp; 1.2 about 120mm of copper wire with teflon insulation and 250mm of 0.35mm2 copper wire with PVC insulation;<br />&nbsp; &nbsp; 1.3 +5V power supply. I use MC33063 based step-down converter from old scanner;<br />&nbsp; &nbsp; 1.4 soldering iron, flux and solder wire;<br />&nbsp; &nbsp; 1.5 wire cutter;<br />&nbsp; &nbsp; 1.6 knife with sharp blade.</p><p>2. stages:<br />&nbsp; &nbsp; 2.1 cut 2 wire about 60mm length each;<br />&nbsp; &nbsp; 2.2 strip the insulation and tin the ends;<br />&nbsp; &nbsp; 2.3 twist the wire;<br />&nbsp; &nbsp; 2.4 glue a small piece of insulator on top of SW1 (reset) button;<br />&nbsp; &nbsp; 2.5 solder the USB connector on top of buttons bracket:</p><p><span class="postimg"><img src="http://smartexec.homedns.org/tpl-wr841nd/USB_connector_on_top_of_buttons.jpg" alt="http://smartexec.homedns.org/tpl-wr841nd/USB_connector_on_top_of_buttons.jpg" /></span></p><p>&nbsp; &nbsp; 2.6 solder the twisted wire from PCB:</p><p><span class="postimg"><img src="http://smartexec.homedns.org/tpl-wr841nd/USB_solder_point.jpg" alt="http://smartexec.homedns.org/tpl-wr841nd/USB_solder_point.jpg" /></span></p><p> to USB connector:</p><p><span class="postimg"><img src="http://smartexec.homedns.org/tpl-wr841nd/USB_wiring.jpg" alt="http://smartexec.homedns.org/tpl-wr841nd/USB_wiring.jpg" /></span></p><p>Pull down 15K resistors already provided (R601, R602);</p><p>&nbsp; &nbsp; 2.7 connect GND pin of USB connector to buttons bracket and make solder bridge on bottom side of PCB: </p><p><span class="postimg"><img src="http://smartexec.homedns.org/tpl-wr841nd/solder_bridge_on_GND.jpg" alt="http://smartexec.homedns.org/tpl-wr841nd/solder_bridge_on_GND.jpg" /></span></p><p>This is not optimal in terms of EMI but it works!</p><p>&nbsp; &nbsp; 2.8 connect +5V pin of USB connector to the +5V power supply. Connect input of +5V converter to the FB1 near main power switch (SW7) and to GND pad of D5 (in my router D5 is not populated);<br />&nbsp; &nbsp; 2.9 make a hole for USB connector on a rear side of housing;<br />&nbsp; &nbsp; 2.10 enable EHCI in kernel configuration and make changes in source code as described on wiki page (<a href="http://wiki.openwrt.org/toh/tp-link/tl-wr841nd#usb.1.1.port">http://wiki.openwrt.org/toh/tp-link/tl- … b.1.1.port</a>).<br />&nbsp; &nbsp; 2.11 rebuild OpenWrt and enjoy!<br />&nbsp; &nbsp;</p><p>kernel log from my router:</p><br /><p>ehci_hcd: USB 2.0 &#039;Enhanced&#039; Host Controller (EHCI) Driver<br />ar71xx-ehci ar71xx-ehci: Atheros AR91xx built-in EHCI controller<br />ar71xx-ehci ar71xx-ehci: new USB bus registered, assigned bus number 1<br />ar71xx-ehci ar71xx-ehci: irq 3, io mem 0x1b000000<br />ar71xx-ehci ar71xx-ehci: USB 2.0 started, EHCI 1.00</p><p>...</p><p>usb 1-1: new high speed USB device number 2 using ar71xx-ehci<br />usb 1-1: New USB device found, idVendor=0bda, idProduct=8187<br />usb 1-1: New USB device strings: Mfr=1, Product=2, SerialNumber=3<br />usb 1-1: Product: RTL8187_Wireless<br />usb 1-1: Manufacturer: Manufacturer_Realtek_RTL8187_</p><p>...</p><p>rtl8187: Customer ID is 0x00<br />rtl8187: wireless switch is on<br />usbcore: registered new interface driver rtl8187</p><br /><p>I need an a USB host on router for secondary radio (RTL8187). I use secondary radio in client mode on WAN interface for connect to the my ISP.</p><p>I&#039;m sorry for my English</p><p>Best regards, Andrew Kornev</p><p>P.S. Whatever you do you do at your own risk. I&#039;m not any responsibility including for damage of equipment.<br />P.P.S. If you want to have worked WiFi LED in HW v7.2 make the following changes in mach-tl-wr741nd.c:</p><p><span style="color: red">-&nbsp; &nbsp; &nbsp; ap91_pci_setup_wmac_led_pin(1);</span><br /><span style="color: green">+&nbsp; &nbsp; &nbsp; &nbsp; ap91_pci_setup_wmac_led_pin(0);</span></p>											<p class="post-edited">(Last edited by <strong>AndrewKo</strong> on 12 Jul 2011, 01:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p150657">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">gregrice</div>
					<div class="post-datetime">
						8 Dec 2011, 17:05					</div>
				</div>
				<div class="post-content content">
					<p>Hi all! </p><p>First is want to say thank you for providing us this cool mod!<br />But i have a little issue with it, altough i followed the process to the letter. </p><p>You can see on the attached pictures my device, which is a WR841N v7.2</p><p><span class="postimg"><img src="http://i43.tinypic.com/idwtgm.jpg" alt="http://i43.tinypic.com/idwtgm.jpg" /></span> <span class="postimg"><img src="http://i44.tinypic.com/aysim9.jpg" alt="http://i44.tinypic.com/aysim9.jpg" /></span> <span class="postimg"><img src="http://i42.tinypic.com/34fle2g.jpg" alt="http://i42.tinypic.com/34fle2g.jpg" /></span></p><p>I think i have soldered good the data+/-, and haven&#039;t cut or short anything around the resistors (made under magnifying glass). </p><p>Measured the voltage of the regulator made with L7805, 470uF condensator and a 100uF condensator, and it seems a fix 5.02V. </p><p>But when i connect any USB device to it (tried already with a 16Gb Kingston pendrive, 60GB External 2,5&quot; HDD, 500Gb External 3,5&quot; HDD (with external power supply, external USB 4port HUB) i get this dmesg output, <br />no matter which firmware using: <br /></p><div class="codebox"><pre><code>usb 1-1: new high speed USB device using ar71xx-ehci and address 2 
usb 1-1: device descriptor read/64, error -71 
usb 1-1: device descriptor read/64, error -71 
usb 1-1: new high speed USB device using ar71xx-ehci and address 3 
usb 1-1: device descriptor read/64, error -71 
usb 1-1: device descriptor read/64, error -71 
usb 1-1: new high speed USB device using ar71xx-ehci and address 4 
usb 1-1: device not accepting address 4, error -71 
usb 1-1: new high speed USB device using ar71xx-ehci and address 5 
usb 1-1: device not accepting address 5, error -71 
hub 1-0:1.0: unable to enumerate USB device on port 1</code></pre></div><p><a href="http://pastebay.com/146444">Full dmesg output</a></p><p>If you take a look at the full dmesg output you could that - i think - the usb port is properly recognised, but somehow because this error i cannot mount or use anything&nbsp; </p><p>Already tried with the firmware what posted <a href="http://www.dd-wrt.com/phpBB2/viewtopic.php?t=86556&amp;postdays=0&amp;postorder=asc&amp;start=15">by Simon on dd-wrt forum</a>, <br />and <a href="https://forum.openwrt.org/viewtopic.php?pid=149155#p149155">ANOTHER</a> from the openwrt forum, which is <br />compiled for directly to the v7 series of wr841n. </p><p>Have you met with this problem? </p><p>There must be some solution out there, because without the usb i cannot use the features of the openwrt with a few Kbytes of free space :&#039;(</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p150764">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">sinvalwrt</div>
					<div class="post-datetime">
						9 Dec 2011, 17:22					</div>
				</div>
				<div class="post-content content">
					<p>Please, can someone pass me the ART.BIN 64K TP-LINK WR841ND v7.2, thanks, a hug Brazil!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153274">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						6 Jan 2012, 01:23					</div>
				</div>
				<div class="post-content content">
					<p>I discovered pretty much the same problem as gregrice on my 1043 lately. When using a usb flash drive connected straight to the usb port, I get the following errors on unmounts or sometimes reads or writes:<br /></p><div class="codebox"><pre><code>EXT2-fs warning: mounting unchecked fs, running e2fsck is recommended
usb 1-1: reset high speed USB device using ar71xx-ehci and address 5
usb 1-1: device descriptor read/all, error -71
usb 1-1: reset high speed USB device using ar71xx-ehci and address 5
usb 1-1: USB disconnect, address 5
usb 1-1: new full speed USB device using ar71xx-ehci and address 6
usb 1-1: device descriptor read/64, error -71
usb 1-1: device descriptor read/64, error -71
usb 1-1: new full speed USB device using ar71xx-ehci and address 7
usb 1-1: device descriptor read/64, error -71
usb 1-1: device descriptor read/64, error -71
usb 1-1: new full speed USB device using ar71xx-ehci and address 8
usb 1-1: device not accepting address 8, error -71
usb 1-1: new full speed USB device using ar71xx-ehci and address 9
usb 1-1: device not accepting address 9, error -71
hub 1-0:1.0: unable to enumerate USB device on port 1
usb 1-1: new high speed USB device using ar71xx-ehci and address 10
usb 1-1: configuration #1 chosen from 1 choice
usb 1-1: USB disconnect, address 10
usb 1-1: new high speed USB device using ar71xx-ehci and address 11
usb 1-1: device descriptor read/64, error -71
usb 1-1: device descriptor read/64, error -71
usb 1-1: new full speed USB device using ar71xx-ehci and address 12
usb 1-1: new full speed USB device using ar71xx-ehci and address 13
usb 1-1: not running at top speed; connect to a high speed hub
usb 1-1: configuration #1 chosen from 1 choice
scsi1 : SCSI emulation for USB Mass Storage devices</code></pre></div><p>(in 10.03/r20728)<br />In r29637 with kernel 3.1.6 it looks like this:<br /></p><div class="codebox"><pre><code>[  155.760000] usb 1-1: reset high speed USB device number 2 using ar71xx-ehci
[  155.920000] usb 1-1: device descriptor read/all, error -71
[  156.040000] usb 1-1: reset high speed USB device number 2 using ar71xx-ehci
[  156.200000] usb 1-1: device descriptor read/all, error -71
[  156.320000] usb 1-1: reset high speed USB device number 2 using ar71xx-ehci
[  156.360000] usb 1-1: device descriptor read/8, error -71
[  156.500000] usb 1-1: device descriptor read/8, error -71
[  156.730000] usb 1-1: reset high speed USB device number 2 using ar71xx-ehci
[  156.770000] usb 1-1: device descriptor read/8, error -71
[  156.910000] usb 1-1: device descriptor read/8, error -71
[  157.020000] usb 1-1: USB disconnect, device number 2
[  157.050000] sd 0:0:0:0: [sda] Unhandled error code
[  157.050000] sd 0:0:0:0: [sda]  Result: hostbyte=0x01 driverbyte=0x00
[  157.060000] sd 0:0:0:0: [sda] CDB: cdb[0]=0x2a: 2a 00 00 30 08 10 00 00 08 00
[  157.060000] end_request: I/O error, dev sda, sector 3147792
[  157.070000] Buffer I/O error on device sda2, logical block 360450
[  157.080000] lost page write due to I/O error on sda2
[  157.080000] sd 0:0:0:0: [sda] Unhandled error code
[  157.090000] sd 0:0:0:0: [sda]  Result: hostbyte=0x01 driverbyte=0x00
[  157.090000] sd 0:0:0:0: [sda] CDB: cdb[0]=0x2a: 2a 00 00 04 08 00 00 00 08 00
[  157.100000] end_request: I/O error, dev sda, sector 264192
[  157.100000] Buffer I/O error on device sda2, logical block 0
[  157.110000] lost page write due to I/O error on sda2</code></pre></div><p>The weird thing about this is, that with a passive 4-port usb hub connected in between it works totally fine. Maybe there is some problem with the internal hub in the tp-links. If anyone can share some experience on that?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153398">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">gregrice</div>
					<div class="post-datetime">
						6 Jan 2012, 21:45					</div>
				</div>
				<div class="post-content content">
					<p>Since then i&#039;ve solved my problem, it was a fried resistor next to the usb cable on board.<br />So i think your issue must be something like that, because since i&#039;ve fixed it everything is okay now.<br />Maybe you can try it with external powered usb hub.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p153421">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">MBS</div>
					<div class="post-datetime">
						7 Jan 2012, 00:35					</div>
				</div>
				<div class="post-content content">
					<p>Well, what I was trying to point out is that the problem disappears when I put a passive (= not external powered) hub between router and flash drive. I thought about a bug in the ar71xx usb hub driver, but I didn&#039;t have the time to really look at it, yet.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155884">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">poolsak</div>
					<div class="post-datetime">
						31 Jan 2012, 09:24					</div>
				</div>
				<div class="post-content content">
					<p>Hi all,<br />I have some question about you method that modify TPlink in order to used USB host.<br />My question is USB host that you have modify can used with USB to VGA device?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p155895">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">poolsak</div>
					<div class="post-datetime">
						31 Jan 2012, 12:53					</div>
				</div>
				<div class="post-content content">
					<p>hi</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p158631">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">cybernoid</div>
					<div class="post-datetime">
						25 Feb 2012, 08:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>MBS wrote:</cite><blockquote><p>Well, what I was trying to point out is that the problem disappears when I put a passive (= not external powered) hub between router and flash drive. I thought about a bug in the ar71xx usb hub driver, but I didn&#039;t have the time to really look at it, yet.</p></blockquote></div><p>It&#039;s good, that you soldered capacitors to the 7805, but with long wires this IC might need ceramic capacitors about 0.1uF on input&nbsp; and output.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p190843">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">Takenover83</div>
					<div class="post-datetime">
						4 Feb 2013, 00:55					</div>
				</div>
				<div class="post-content content">
					<p>My Rosewill RNX-N300RT (rebadged WR841N(D) V7) points seem to be a tad different then the pics shown here. Sorry, this is the best pic I could get with my SGSII. Anyone know what two points would be for the usb mod?</p><p><a href="http://postimage.org/image/xp8ebcvh5/full/"><span class="postimg"><img src="http://s4.postimage.org/i3r2rejj1/IMG_20130203_163327.jpg" alt="http://s4.postimage.org/i3r2rejj1/IMG_20130203_163327.jpg" /></span></a></p><p>I was thinking of the two points here (<span style="color: red">red boxed</span>), but I was not getting any data (or my soldering skills suck).</p><p><a href="http://postimage.org/image/uaul59lfp/full/"><span class="postimg"><img src="http://s18.postimage.org/4s28s91vt/edited.jpg" alt="http://s18.postimage.org/4s28s91vt/edited.jpg" /></span></a></p><p>Compared to this pic, you can see some of the differences.<br /><span class="postimg"><img src="http://smartexec.homedns.org/tpl-wr841nd/USB_solder_point.jpg" alt="http://smartexec.homedns.org/tpl-wr841nd/USB_solder_point.jpg" /></span></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p212940">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">pulse</div>
					<div class="post-datetime">
						22 Sep 2013, 03:47					</div>
				</div>
				<div class="post-content content">
					<p>Takenover83 did you ever get USB working on your RNX-N300RT? From the photos you posted it looks to me like the connection points would be somewhere on the four components shown one row down in your photo. Perhaps the same points as in the row of four components on the TPL-WR841ND, but I would not want to guess that without further investigation. I just got a RNX-N300RT myself. Not sure I will need USB, but if don&#039;t have this working yet I can open it up and give you my best guess.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p216705">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">zloyadmin</div>
					<div class="post-datetime">
						4 Nov 2013, 16:06					</div>
				</div>
				<div class="post-content content">
					<p>Hi everyone!</p><p>I will appreciate if someone shares the firmware which supports usb. <a href="mailto:just.box2011@yandex.ua">just.box2011@yandex.ua</a></p><p>Thanks in advance!</p>											<p class="post-edited">(Last edited by <strong>zloyadmin</strong> on 4 Nov 2013, 16:09)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p220836">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">treexel</div>
					<div class="post-datetime">
						25 Dec 2013, 11:53					</div>
				</div>
				<div class="post-content content">
					<p>how about version 8.2? I do not have the same pinout...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p247914">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">bookkc</div>
					<div class="post-datetime">
						24 Sep 2014, 12:41					</div>
				</div>
				<div class="post-content content">
					<p>Hi, I want to connect USB, flashed firmware <a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/openwrt-ar71xx-generic-tl-wr841nd-v7-squashfs-factory.bin">http://downloads.openwrt.org/snapshots/ … actory.bin</a> This firmware is USB mod? that is, if I soldered everything in a manual, then I will work USB? or firmware to collect under USB modes ???</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p333976">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">cjrs</div>
					<div class="post-datetime">
						10 Aug 2016, 22:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>bookkc wrote:</cite><blockquote><p>Hi, I want to connect USB, flashed firmware <a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/openwrt-ar71xx-generic-tl-wr841nd-v7-squashfs-factory.bin">http://downloads.openwrt.org/snapshots/ … actory.bin</a> This firmware is USB mod? that is, if I soldered everything in a manual, then I will work USB? or firmware to collect under USB modes ???</p></blockquote></div><p>Yes, TP-Link TL-WR841N v7 has similar hardware that TL-WR840N v1 and with USB would be similar to TP-Link TL-MR3420 v1 and TL-WR842ND v1.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>