<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> Need correct firewall configurations to block access</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 5 May 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p363850">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						17 Aug 2017, 07:26					</div>
				</div>
				<div class="post-content content">
					<p>Hi</p><p>I need help with this. I have been trying to solve it for&nbsp; hours now.<br />I have created 2 wifi SSIDs &quot;guest&quot; (wlan0-1) which is for guests which interface is PUBLIC and the other is &quot;mynetwork&quot; (wlan0) for admin purpose which interface is LAN. I then created zones PUBLIC and LAN for firewall policies. The gateway for this network is on separate physical device with IP address 192.168.1.10.</p><p>My goal is to prevent hosts on zone PUBLIC accessing zon LAN except if it really is necessary.</p><p>Here are the interfaces:</p><p>config interface &#039;lan&#039;<br />&nbsp; &nbsp; option force_link &#039;1&#039;<br />&nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; option ipaddr &#039;192.168.1.1&#039;<br />&nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option ip6assign &#039;60&#039;<br />&nbsp; &nbsp; option _orig_ifname &#039;eth0.1 wlan0 wlan1&#039;<br />&nbsp; &nbsp; option _orig_bridge &#039;true&#039;<br />&nbsp; &nbsp; option gateway &#039;192.168.1.10&#039;<br />&nbsp; &nbsp; option dns &#039;208.67.222.222 208.67.220.220&#039;<br />&nbsp; &nbsp; option ifname &#039;eth0.1&#039;</p><p>config interface &#039;public&#039;<br />&nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; option ipaddr &#039;10.0.0.1&#039;<br />&nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option _orig_ifname &#039;wlan0-1&#039;<br />&nbsp; &nbsp; option _orig_bridge &#039;true&#039;<br />&nbsp; &nbsp; option dns &#039;208.67.222.222 208.67.222.220&#039;</p><p>Please excuse my lack of understanding of how networking works, but I see that I need to enable forwarding between zone PUBLIC and LAN to enable hosts connected to wifi &quot;guest&quot; to access the Internet so I have enabled 2 way forwarding between zone LAN and PUBLIC. I then created a rule to block all access from zone PUBLIC to LAN. However, after applying the rule I can still ping from hosts on Wifi guest to wired hosts on zone LAN. Why is that? What is the correct way of achieving this? Here are the firewall policies:</p><p>config defaults<br />&nbsp; &nbsp; option syn_flood &#039;1&#039;<br />&nbsp; &nbsp; option input &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option forward &#039;REJECT&#039;</p><p>config include<br />&nbsp; &nbsp; option path &#039;/etc/firewall.user&#039;</p><p>config zone<br />&nbsp; &nbsp; option name &#039;lan&#039;<br />&nbsp; &nbsp; option network &#039;lan&#039;<br />&nbsp; &nbsp; option input &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option forward &#039;ACCEPT&#039;</p><p>config zone<br />&nbsp; &nbsp; option name &#039;public&#039;<br />&nbsp; &nbsp; option network &#039;public&#039;<br />&nbsp; &nbsp; option output &#039;ACCEPT&#039;<br />&nbsp; &nbsp; option forward &#039;REJECT&#039;<br />&nbsp; &nbsp; option input &#039;REJECT&#039;</p><p>config rule<br />&nbsp; &nbsp; option src &#039;public&#039;<br />&nbsp; &nbsp; option target &#039;DROP&#039;<br />&nbsp; &nbsp; option name &#039;Disallow PUBLIC to LAN&#039;<br />&nbsp; &nbsp; option dest &#039;lan&#039;</p><p>config forwarding<br />&nbsp; &nbsp; option dest &#039;lan&#039;<br />&nbsp; &nbsp; option src &#039;public&#039;</p><p>config forwarding<br />&nbsp; &nbsp; option dest &#039;public&#039;<br />&nbsp; &nbsp; option src &#039;lan&#039;</p><p>Please help.</p><p>Thank you.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p363885">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						17 Aug 2017, 21:27					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>zorrox wrote:</cite><blockquote><p>Please excuse my lack of understanding of how networking works, but I see that I need to enable forwarding between zone PUBLIC and LAN to enable hosts connected to wifi &quot;guest&quot; to access the Internet so I have enabled 2 way forwarding between zone LAN and PUBLIC. I then created a rule to block all access from zone PUBLIC to LAN. However, after applying the rule I can still ping from hosts on Wifi guest to wired hosts on zone LAN. Why is that? What is the correct way of achieving this?</p></blockquote></div><p>You are on the right track here. The stumbling block is in the order of the rules. In your firewall config, you first have a default policy for PUBLIC that prohibits all forwarded traffic. You then have an explicit, but unnecessary rule that also prohibits forwarding. You then have two rules, which allow forwarding of traffic to/from PUBLIC and LAN.</p><p>And this last pair of rules is now what allows ping to reach a wired host in LAN from a Wi-fi guest in PUBLIC. It is the last pair in your firewall config which applies to forwarding, and because it is the last, it remains the effective one.</p><p>If you want to only allow Wi-fi guests to reach the Internet, but not other hosts in the LAN zone, then what you must do is a unidirectional forwarding rule that matches only when a specific destination is being used. The following rule accomplishes that:<br /></p><div class="codebox"><pre><code>config rule
   option name &#039;Gateway access for PUBLIC&#039;
   option src &#039;public&#039;
   option dest &#039;lan&#039;
   option dest_ip &#039;192.168.1.10&#039;
   option target &#039;ACCEPT&#039;</code></pre></div><p>This rule replaces the three forwarding-related rules you currently have. </p><p>In order for return traffic to work, you will need to enable connection tracking on the LAN zone. To do this, change your LAN zone config to the following:<br /></p><div class="codebox"><pre><code>config zone
    option name &#039;lan&#039;
    option network &#039;lan&#039;
    option input &#039;ACCEPT&#039;
    option output &#039;ACCEPT&#039;
    option conntrack &#039;1&#039;</code></pre></div><p>As you can see, I have also removed the &quot;forward&quot; option since it is not necessary. The gateway device resides in the same subnet as your LAN, and the logical network &quot;LAN&quot; is bridging together adapters &#039;eth0.1&#039; and probably the admin-side wireless network. Hence, traffic is automatically allowed to flow freely, and no forward is necessary.</p><p>With these changes, clients in PUBLIC should now be able to ping the gateway device at 192.168.1.10. The gateway device can respond to the ping and the packet is allowed back (due to conntrack), but if the gateway tries to ping the clients in PUBLIC, that traffic is blocked. Similarly, traffic from LAN towards PUBLIC is blocked. Clients in PUBLIC also cannot ping clients in LAN (other than the gateway device, that is).</p><p>In order for all other traffic to work from PUBLIC (i.e. web browsing etc.) you will need to either set the gateway address (192.168.1.10) explicitly for all clients in PUBLIC, or you will need to configure and expose a DHCP service in the PUBLIC network. You have not shown the content of your /etc/config/dhcp file, so I cannot say if the service is available or not. </p><p>If the service is available, then you will need the following additional rule in order for clients in PUBLIC to be able to use it:<br /></p><div class="codebox"><pre><code>config rule
    option name &#039;DHCP for PUBLIC&#039;
    option src &#039;public&#039;
    option src_port &#039;67-68&#039;
    option dest_port &#039;67-68&#039;
    option proto &#039;udp&#039;
    option target &#039;ACCEPT&#039;</code></pre></div><p>The return direction is working automatically, because the OUTPUT direction in PUBLIC is allowed by the zone&#039;s policy.</p><p>Note that the router will not answer to DNS requests from the clients in PUBLIC. To allow this as well, add one last rule:<br /></p><div class="codebox"><pre><code>config rule
    option name &#039;DNS for PUBLIC&#039;
    option src &#039;public&#039;
    option dest_port &#039;53&#039;
    option proto &#039;tcp udp&#039;
    option target &#039;ACCEPT&#039;</code></pre></div><p>For a step by step guide on creating a guest WLAN that enforces the information what you&#039;ve just read above, you can check this link: <a href="https://wiki.openwrt.org/doc/recipes/guest-wlan">https://wiki.openwrt.org/doc/recipes/guest-wlan</a>. Note that unlike our setup here, the setup in the link assumes that the wide area access is on a separate logical network. This is not the case for us, since the gateway device is at 192.168.1.10.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p363942">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						19 Aug 2017, 07:12					</div>
				</div>
				<div class="post-content content">
					<p>Hi Antek,</p><p>Thank you for your detail and helpful explanation. I really appreciate it.</p><p>I have tried your suggestion but unfortunately wifi hosts on public zone is unable to ping or access 192.168.1.10 hence the Internet. Here is the latest configurations:</p><div class="codebox"><pre><code>config defaults
    option syn_flood &#039;1&#039;
    option input &#039;ACCEPT&#039;
    option output &#039;ACCEPT&#039;
    option forward &#039;REJECT&#039;

config include
    option path &#039;/etc/firewall.user&#039;

config zone
    option name &#039;lan&#039;
    option network &#039;lan&#039;
    option input &#039;ACCEPT&#039;
    option output &#039;ACCEPT&#039;
    option conntrack &#039;1&#039;

config zone
    option name &#039;public&#039;
    option network &#039;public&#039;
    option output &#039;ACCEPT&#039;
    option forward &#039;REJECT&#039;
    option input &#039;REJECT&#039;

config rule
        option src &#039;public&#039;
        option src_port &#039;67-68&#039;
        option dest_port &#039;67-68&#039;
        option proto &#039;udp&#039;
        option target &#039;ACCEPT&#039;
        option name &#039;Allow DHCP request&#039;

config rule
        option src &#039;public&#039;
        option dest_port &#039;53&#039;
        option proto &#039;tcpudp&#039;
        option target &#039;ACCEPT&#039;
        option name &#039;Allow DNS Queries&#039;

config rule
    option name &#039;Gateway access for PUBLIC&#039;
    option src &#039;public&#039;
    option dest &#039;lan&#039;
    option dest_ip &#039;192.168.1.10&#039;
    option target &#039;ACCEPT&#039;</code></pre></div><p>As trial and error, I have also tried configurations below to allow everything from public to lan except to subnet 192.168.1.0/24 but I still can ping any host on 192.168.1.0/24 subnet.</p><div class="codebox"><pre><code>config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config rule
        option src &#039;public&#039;
        option src_port &#039;67-68&#039;
        option dest_port &#039;67-68&#039;
        option proto &#039;udp&#039;
        option target &#039;ACCEPT&#039;
        option name &#039;Allow DHCP request&#039;

config rule
        option src &#039;public&#039;
        option dest_port &#039;53&#039;
        option proto &#039;tcpudp&#039;
        option target &#039;ACCEPT&#039;
        option name &#039;Allow DNS Queries&#039;

config zone
        option name &#039;lan&#039;
        option network &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;

config zone
        option name &#039;public&#039;
        option network &#039;public&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;
        option input &#039;REJECT&#039;

config forwarding
        option dest &#039;lan&#039;
        option src &#039;public&#039;

config forwarding
        option dest &#039;public&#039;
        option src &#039;lan&#039;

config rule
        option name &#039;Deny public to lan&#039;
        option src &#039;public&#039;
        option dest &#039;lan&#039;
        option target &#039;DROP&#039;
        option dest_ip &#039;192.168.1.10/24&#039;</code></pre></div><p>I even swapped the the forwarding and rule like below but I still can ping any host on the subnet.<br /></p><div class="codebox"><pre><code>config forwarding
        option dest &#039;public&#039;
        option src &#039;lan&#039;

config rule
        option name &#039;Deny public to lan&#039;
        option src &#039;public&#039;
        option dest &#039;lan&#039;
        option target &#039;DROP&#039;
        option dest_ip &#039;192.168.1.10/24&#039;

config forwarding
        option dest &#039;lan&#039;
        option src &#039;public&#039;</code></pre></div><p>What could be the problem?</p><p>Regards,</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p363953">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						19 Aug 2017, 14:52					</div>
				</div>
				<div class="post-content content">
					<p>I don&#039;t think the firewall rules know how to deal with CIDR-notation i.e. &#039;192.168.1.10/24&#039;. If you want to use a range of individual IPs or block out entire networks, then you&#039;ll need to resort to adding an <a href="https://wiki.openwrt.org/doc/uci/firewall#ip_sets">IP Set</a>. I have not used IP Sets in my firewall rules, so I can&#039;t give any good examples.</p><p>The latest configuration you posted seems correct to me, so the problem could be somewhere else. Perhaps it is a routing table issue? Using the first configuration, type &#039;route -n&#039; on an SSH shell and post the result here.</p><p>You should also verify the settings on your wireless clients. Join a wireless client into the &quot;public&quot; network, and ensure it gets configured correctly. If you use DHCP on the wireless client, ensure it gets a good IP address and has the correct gateway setting. The DNS settings on the client might still be incorrect unless you&#039;ve fixed them in /etc/config/dhcp. If you use static addressing on the wireless clients, then ensure the settings are correct.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364004">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						20 Aug 2017, 11:33					</div>
				</div>
				<div class="post-content content">
					<p>Thanks Antek.</p><p>Actually even if I specified the IP 192.168.1.10 without /24, it makes no difference, I can still ping it using the trial and error configurations.</p><p>Here is the result of route -n</p><p>Kernel IP routing table<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Genmask&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Flags Metric Ref&nbsp; &nbsp; Use Iface<br />0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192.168.1.10&nbsp; &nbsp; 0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />10.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; 10.0.0.1&nbsp; &nbsp; &nbsp; &nbsp; 255.255.255.0&nbsp; &nbsp;UG&nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 wlan0-1<br />192.168.1.0&nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0&nbsp; &nbsp;U&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp; 0 br-lan<br />root@pejalan:/tmp/log#</p><p>I am quite sure the wireless client is working as I can access the Internet with the trial and error configurations.</p><p>By the way, how can I see the logs of the firewall including the accepted traffic? I can see the blocked traffic on kernel logs on Luci. Where is it if use command line?</p><p>Thanks</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364026">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						20 Aug 2017, 17:44					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>zorrox wrote:</cite><blockquote><p>Here is the result of route -n</p></blockquote></div><p>This routing table seems ok. Do you have any Linux clients in the wireless network? If you use &#039;route -n&#039; for them, what does the result look like? If you have only Windows clients, you can use &#039;route print&#039; command.</p><p>Another thing you can try is change the &#039;conntrack&#039; option in the LAN zone to the &#039;masq&#039; option, with the same value of &#039;1. This creates masquerade rules so traffic coming from the &#039;public&#039; network that is forwarded to the LAN network is subjected to a source address rewrite (source NAT).</p><p>Your scenario is pretty unique since the gateway device resides in the &quot;lan&quot; network. Usual router configs have a &quot;lan&quot; network, a &quot;guest&quot; wi-fi and then a &quot;wan&quot; network through which the gateway device, and Internet, are reachable. This three-network setup makes the routing rules much simpler to write.</p><p>If nothing else works, you can always use the &quot;trial and error&quot; configuration. In my opinion it gives a bit too much visibility for the wireless clients, but if the user accounts and passwords of your router and all LAN-side devices are secure enough, then it shouldn&#039;t be a problem.</p><div class="quotebox"><cite>zorrox wrote:</cite><blockquote><p>By the way, how can I see the logs of the firewall including the accepted traffic? I can see the blocked traffic on kernel logs on Luci. Where is it if use command line?</p></blockquote></div><p>The &#039;dmesg&#039; command prints the content of the kernel log from the command-line. The &#039;logread&#039; command prints the system log, again from the command-line.</p><p>The following two options, defined in the &#039;zone&#039; entries in /etc/config/firewall:<br /></p><div class="codebox"><pre><code>    option log &#039;1&#039;
    option log_limit &#039;10/minute&#039;</code></pre></div><p>will create firewall rules that write an entry to either the kernel log or the system log for rejected and dropped traffic on a per-zone basis, and will limit the number of log entries to 10 entries per minute so the kernel log doesn&#039;t get flooded.</p><p>I do not know how to configure the firewall so that it prints log entries for accepted traffic.</p>											<p class="post-edited">(Last edited by <strong>Antek</strong> on 20 Aug 2017, 17:45)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364087">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						21 Aug 2017, 18:13					</div>
				</div>
				<div class="post-content content">
					<p>Hi Antek,</p><p>I have only Android clients so far and the netstat command output looks ok:</p><p>Kernel IP routing table:<br />Destination&nbsp; &nbsp; &nbsp;Gateway&nbsp; &nbsp; &nbsp;Genmask<br />0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10.0.0.1&nbsp; &nbsp; &nbsp; 0.0.0.0<br />10.0.0.0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0&nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0</p><p>Since my gateway resides on the lan network, is it possible to have a wan network which only gateway 192.168.1.10 resides but the rest is on the lan network? Which interface should I assign to this wan network?</p><p>The reason I have the gateway in lan network because I thought it could reduce delay introduced by routing since there is one more router to connect to the Internet through my home ADSL. So I thought if this gateway is not on the same lan network, the routing delay may be higher. Is that a correct assumption? </p><p>Yes I can use the trial and error configuration but the rule that blocks connection from public to lan is not working as I mentioned in the previous post.</p><p>Thanks for the tips on the firewall logs.</p>											<p class="post-edited">(Last edited by <strong>zorrox</strong> on 21 Aug 2017, 18:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364095">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						21 Aug 2017, 22:54					</div>
				</div>
				<div class="post-content content">
					<p>A thought occurred to me: perhaps we need to be a bit more explicit on the routing configuration. Modify your Public network in the /etc/config/network to match this:<br /></p><div class="codebox"><pre><code>config interface &#039;public&#039;
    option proto &#039;static&#039;
    option ipaddr &#039;10.0.0.1&#039;
    option netmask &#039;255.255.255.0&#039;
    option dns &#039;208.67.222.222 208.67.222.220&#039;

config route &#039;Default route for Public&#039;
    option interface &#039;public&#039;
    option target &#039;0.0.0.0&#039;
    option netmask &#039;0.0.0.0&#039;
    option gateway &#039;192.168.1.10&#039;</code></pre></div><p>Remember to retain the &#039;lan&#039; network so it has the &#039;conntrack&#039; option, and the explicit firewall forwarding rule that I wrote earlier.</p><p>Does this change help? Post the &#039;route -n&#039; command from the OpenWRT router after this change.</p><p><strong>Note:</strong> We are modifying the default routing table, so there is a chance that after this change, you&#039;ll lose Internet access from the LAN behind the OpenWRT router. If that happens, just remove the default route and restart.</p><div class="quotebox"><cite>zorrox wrote:</cite><blockquote><p>Since my gateway resides on the lan network, is it possible to have a wan network which only gateway 192.168.1.10 resides but the rest is on the lan network? Which interface should I assign to this wan network?</p></blockquote></div><p>You could either use two /28 segments (192.168.1.0 - 192.168.1.15 and 192.168.1.16 - 192.168.1.31), or you could use 192.168.1.0/24 as the network where the gateway resides, and use 192.168.2.0/24 for the &quot;LAN&quot; behind the OpenWRT.</p><p>It would require you to configure the switch device, and assign VLAN tagging for the ports. Configuring the switch is always a bit tricky, because the configuration needs to be complete, and may cause changes not only to network, firewall and DHCP, but also to Dropbear and uhttpd because the network interfaces change around. The pitfall is that if you make a mistake anywhere in the process, you might end up having to reset your router completely from safe mode or over a TTL serial cable because it becomes inaccessible due to some obscure mistake that you didn&#039;t account for. I&#039;ve been there, and done that. Configuring OpenWRT through a serial cable is NOT fun <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><div class="quotebox"><cite>zorrox wrote:</cite><blockquote><p>The reason I have the gateway in lan network because I thought it could reduce delay introduced by routing since there is one more router to connect to the Internet through my home ADSL. So I thought if this gateway is not on the same lan network, the routing delay may be higher. Is that a correct assumption?</p></blockquote></div><p>This is the correct assumption. Splitting the LAN network to LAN and WAN would introduce one additional routing decision for the &quot;LAN&quot; network behind the OpenWRT router. In your current setup, no such decision is necessary.</p>											<p class="post-edited">(Last edited by <strong>Antek</strong> on 21 Aug 2017, 22:58)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364173">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						23 Aug 2017, 17:14					</div>
				</div>
				<div class="post-content content">
					<p>Hi Antek,</p><p>Sorry for the delay in reply.</p><p>I have tested your suggestion but it is not working. My wifi and wired clients are unable to even get IP from the DHCP server so I cannot run the route -n on the router. I need to reset the router in safe mode to fix it.</p><p>However, the good news is I have successfully made the trial and error configuration working. It turns out that the DROP rule from public to lan must be specific enough to match the traffic, like this:</p><div class="codebox"><pre><code>config rule
    option name &#039;Deny public to lan&#039;
    option src &#039;public&#039;
    option dest &#039;lan&#039;
    option dest_ip &#039;192.168.1.0/24&#039;
    option proto &#039;all&#039;
    option target &#039;DROP&#039;</code></pre></div><p>Previously I omitted the &quot;option proto&quot; line but after rearranging the option lines and adding &quot;option proto &#039;all&#039;&quot;, it works. I guess I will stick with this for now.</p><p>I would like to thank you again for your wonderful help and suggestion. I really appreciate it.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364185">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						23 Aug 2017, 20:42					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>zorrox wrote:</cite><blockquote><p>I have tested your suggestion but it is not working. My wifi and wired clients are unable to even get IP from the DHCP server so I cannot run the route -n on the router. I need to reset the router in safe mode to fix it.</p></blockquote></div><p>Did the DHCP stop working after adding the default rule? That&#039;s really strange indeed, and quite unexpected, especially for the wired clients since they shouldn&#039;t be affected by the rules of the &#039;public&#039; network.</p><div class="quotebox"><cite>zorrox wrote:</cite><blockquote><p>However, the good news is I have successfully made the trial and error configuration working. It turns out that the DROP rule from public to lan must be specific enough to match the traffic, like this:</p><div class="codebox"><pre><code>config rule
    option name &#039;Deny public to lan&#039;
    option src &#039;public&#039;
    option dest &#039;lan&#039;
    option dest_ip &#039;192.168.1.0/24&#039;
    option proto &#039;all&#039;
    option target &#039;DROP&#039;</code></pre></div><p>Previously I omitted the &quot;option proto&quot; line but after rearranging the option lines and adding &quot;option proto &#039;all&#039;&quot;, it works. I guess I will stick with this for now.</p></blockquote></div><p>This sounds logical, as the default value for &quot;proto&quot; is &quot;tcpudp&quot;. So icmp etc. was able to pass through. I&#039;m surprised that the &quot;dest_ip&quot; field accepts CIDR notation, the documentation doesn&#039;t explicitly state this. Good to know for future reference <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Glad you got it working, and good to hear if my ideas helped you at least a little bit, although I couldn&#039;t figure out the exact solution <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364252">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						24 Aug 2017, 18:23					</div>
				</div>
				<div class="post-content content">
					<p>Now I am having problem to deny NEW connection from public to lan. The rule<br /></p><div class="codebox"><pre><code>config rule
    option name &#039;Deny public to lan&#039;
    option src &#039;public&#039;
    option dest &#039;lan&#039;
    option dest_ip &#039;192.168.1.0/24&#039;
    option proto &#039;all&#039;
    option target &#039;DROP&#039;</code></pre></div><p>drops everything including ESTABLISHED and RELATED connections from public to lan. How do I specify to drop NEW connection from public to lan only? I tried adding option extra argument like below but it does not seem to work.</p><div class="codebox"><pre><code>config rule
    option name &#039;Allow Established Connection&#039;
    option src &#039;public&#039;
    option dest &#039;lan&#039;
    option dest_ip &#039;192.168.1.0/24&#039;
    option proto &#039;all&#039;
    option target &#039;ACCEPT&#039;
    option extra &#039;-m state --state RELATED,ESTABLISHED&#039;</code></pre></div><p>Any ideas?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364276">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						24 Aug 2017, 21:28					</div>
				</div>
				<div class="post-content content">
					<p>The &#039;extra&#039; option should do what you want. Can you post the entire firewall config as it now is, for reference?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364301">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						25 Aug 2017, 05:15					</div>
				</div>
				<div class="post-content content">
					<p>Here it is:</p><div class="codebox"><pre><code>config defaults
        option syn_flood &#039;1&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config zone
        option name &#039;lan&#039;
        option network &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;ACCEPT&#039;
        option log &#039;1&#039;

config zone
        option name &#039;public&#039;
        option network &#039;public&#039;
        option output &#039;ACCEPT&#039;
        option input &#039;REJECT&#039;
        option forward &#039;ACCEPT&#039;
        option log &#039;1&#039;


config rule
        option name &#039;Allow DHCP request&#039;
        option src &#039;public&#039;
        option src_port &#039;67-68&#039;
        option dest_port &#039;67-68&#039;
        option proto &#039;udp&#039;
        option target &#039;ACCEPT&#039;

config rule
        option name &#039;Allow DNS Queries&#039;
        option src &#039;public&#039;
        option dest_port &#039;53&#039;
        option proto &#039;tcpudp&#039;
        option target &#039;ACCEPT&#039;


config forwarding
        option src &#039;lan&#039;
        option dest &#039;public&#039;

config forwarding
        option dest &#039;lan&#039;
        option src &#039;public&#039;

config rule
        option name &#039;Allow Established Connection&#039;
        option src &#039;public&#039;
        option dest &#039;lan&#039;
        option dest_ip &#039;192.168.1.0/24&#039;
        option proto &#039;all&#039;
        option target &#039;ACCEPT&#039;
        option extra &#039;-m state --state RELATED,ESTABLISHED&#039;

config rule
        option name &#039;Deny public to lan&#039;
        option src &#039;public&#039;
        option dest &#039;lan&#039;
        option dest_ip &#039;192.168.1.0/24&#039;
        option proto &#039;all&#039;
        option target &#039;DROP&#039;</code></pre></div><p>When I ping from 192.168.1.114 to 10.0.0.65, I see this on firewall logs which I think it is blocking echo reply from 10.0.0.65:</p><div class="codebox"><pre><code>[29392.010000] DROP(dest lan)IN=wlan0-1 OUT=br-lan MAC=c6:e9:84:d5:11:d7:70:5a:0f:52:4d:37:08:00 SRC=10.0.0.65 DST=192.168.1.114 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=19861 PROTO=ICMP TYPE=0 CODE=0 ID=3845 SEQ=12
[29393.050000] DROP(dest lan)IN=wlan0-1 OUT=br-lan MAC=c6:e9:84:d5:11:d7:70:5a:0f:52:4d:37:08:00 SRC=10.0.0.65 DST=192.168.1.114 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=20548 PROTO=ICMP TYPE=0 CODE=0 ID=3845 SEQ=13
[29394.070000] DROP(dest lan)IN=wlan0-1 OUT=br-lan MAC=c6:e9:84:d5:11:d7:70:5a:0f:52:4d:37:08:00 SRC=10.0.0.65 DST=192.168.1.114 LEN=84 TOS=0x00 PREC=0x00 TTL=254 ID=21184 PROTO=ICMP TYPE=0 CODE=0 ID=3845 SEQ=14</code></pre></div><p>Please help</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364306">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						25 Aug 2017, 07:11					</div>
				</div>
				<div class="post-content content">
					<p>What happens if you remove the &#039;Allow established connection&#039; rule completely, and instead use the &#039;option extra&#039; in the Deny rule, to make it affect only new connections? </p><p>Like so:<br /></p><div class="codebox"><pre><code>config rule
        option name &#039;Deny public to lan&#039;
        option src &#039;public&#039;
        option dest &#039;lan&#039;
        option dest_ip &#039;192.168.1.0/24&#039;
        option proto &#039;all&#039;
        option target &#039;DROP&#039;
        option extra &#039;-m state --state NEW&#039;</code></pre></div><p>You can also use &#039;iptables --list&#039; in order to print the whole filter table chain structure. It might help in rooting out the issue. Sometimes the UCI config file does not print the whole picture, when the scenario is complex enough.</p><p>EDIT: Also, I see that the &#039;conntrack&#039; option has been removed from the &#039;lan&#039; zone. I think this option is necessary in order for the stateful firewall to work in the first place. Perhaps try adding this option first, and if that doesn&#039;t work, then try with the modified Deny rule?</p>											<p class="post-edited">(Last edited by <strong>Antek</strong> on 25 Aug 2017, 07:13)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364328">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						25 Aug 2017, 17:57					</div>
				</div>
				<div class="post-content content">
					<p>Hi Antek</p><p>Adding the conntrack again solves the issue. Thank you very much.</p><p>By the way how do I know when to add conntract to a zone? If I have a wan zone, should it have conntrack too?</p><p>Currently I am using your suggestion to add the&nbsp; &quot;option extra &#039;-m state --state NEW&#039;&quot; to the deny rule and it works like charm. Thanks again.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p364335">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						25 Aug 2017, 19:21					</div>
				</div>
				<div class="post-content content">
					<p>You&#039;re welcome <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><div class="quotebox"><cite>zorrox wrote:</cite><blockquote><p>By the way how do I know when to add conntract to a zone? If I have a wan zone, should it have conntrack too?</p></blockquote></div><p>If a zone is involved in a firewall rule that relies on tracking the state of the connection (NEW, ESTABLISHED, RELATED etc.) then the &#039;conntrack&#039; option needs to be set on this zone. If the firewall rule is associated with two zones (forwarded traffic) then the option needs to be set on at least one of the zones.</p><p>Usually a WAN zone has the &#039;masq&#039; option which causes outbound packets to get their source address re-written to the&nbsp; IP address which the router&#039;s interface is using in this network. The &#039;masq&#039; option also implicitly enables &#039;conntrack&#039;. Armed with these two options, the zone both knows to accept the return-packet (due to &#039;conntrack&#039;), and knows where it should be forwarded to (due to &#039;masq&#039;).</p><p>If your LAN zone uses public IPs, then you can use just the &#039;conntrack&#039; option on the WAN zone to enable the stateful firewall without the source address re-write.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365157">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						10 Sep 2017, 10:14					</div>
				</div>
				<div class="post-content content">
					<p>Hi Antek,</p><p>Need you help again. I just realized recently that tcp connection from lan to public is always terminated after a few seconds despite ping works with no drop. For example, I run an SSH server on 10.0.0.164 and connect to it from 192.168.1.177. The initial connection is fine I can login and get authenticated and get the shell prompt. However after around 20 seconds the shell just hangs. The SSH server is still running and I can connect again without restarting the ssh server. The same problem happens when I try to print to a printer on public network from lan network, the printer will print about almost a quarter of the page before stopping. Please find below the last part of tcpdump capture of the ssh connection when it hangs:</p><div class="codebox"><pre><code>15:07:40.196715 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5052:5168, ack 4140, win 1629, options [nop,nop,TS val 154798 ecr 5641639], length 116
15:07:40.196879 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5168, win 249, options [nop,nop,TS val 5641892 ecr 154798], length 0
15:07:40.690788 IP 192.168.1.177.45709 &gt; 10.0.0.164.60805: Flags [FP.], seq 0:104, ack 1, win 249, options [nop,nop,TS val 5642016 ecr 146432], length 104
15:07:41.200863 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5168:5284, ack 4140, win 1629, options [nop,nop,TS val 154999 ecr 5641892], length 116
15:07:41.201023 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5284, win 249, options [nop,nop,TS val 5642143 ecr 154999], length 0
15:07:42.191301 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5284:5400, ack 4140, win 1629, options [nop,nop,TS val 155197 ecr 5642143], length 116
15:07:42.191454 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5400, win 249, options [nop,nop,TS val 5642391 ecr 155197], length 0
15:07:43.207483 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5400:5516, ack 4140, win 1629, options [nop,nop,TS val 155400 ecr 5642391], length 116
15:07:43.207640 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5516, win 249, options [nop,nop,TS val 5642645 ecr 155400], length 0
15:07:44.207775 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5516:5632, ack 4140, win 1629, options [nop,nop,TS val 155600 ecr 5642645], length 116
15:07:44.207940 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5632, win 249, options [nop,nop,TS val 5642895 ecr 155600], length 0
15:07:45.199236 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5632:5748, ack 4140, win 1629, options [nop,nop,TS val 155799 ecr 5642895], length 116
15:07:45.199407 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5748, win 249, options [nop,nop,TS val 5643143 ecr 155799], length 0
15:07:46.199007 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5748:5864, ack 4140, win 1629, options [nop,nop,TS val 155998 ecr 5643143], length 116
15:07:46.199173 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5864, win 249, options [nop,nop,TS val 5643393 ecr 155998], length 0
15:07:47.200189 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5864:5980, ack 4140, win 1629, options [nop,nop,TS val 156199 ecr 5643393], length 116
15:07:47.200356 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5980, win 249, options [nop,nop,TS val 5643643 ecr 156199], length 0
15:07:47.414063 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5864:5980, ack 4140, win 1629, options [nop,nop,TS val 156240 ecr 5643393], length 116
15:07:47.414197 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5980, win 249, options [nop,nop,TS val 5643696 ecr 156240,nop,nop,sack 1 {5864:5980}], length 0
15:07:47.823494 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5864:5980, ack 4140, win 1629, options [nop,nop,TS val 156322 ecr 5643393], length 116
15:07:47.823665 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5980, win 249, options [nop,nop,TS val 5643799 ecr 156322,nop,nop,sack 1 {5864:5980}], length 0
15:07:48.639662 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5864:5980, ack 4140, win 1629, options [nop,nop,TS val 156486 ecr 5643393], length 116
15:07:48.639797 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5980, win 249, options [nop,nop,TS val 5644003 ecr 156486,nop,nop,sack 1 {5864:5980}], length 0
15:07:50.284380 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5864:5980, ack 4140, win 1629, options [nop,nop,TS val 156815 ecr 5643393], length 116
15:07:50.284548 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5980, win 249, options [nop,nop,TS val 5644414 ecr 156815,nop,nop,sack 1 {5864:5980}], length 0
15:07:53.572103 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5864:5980, ack 4140, win 1629, options [nop,nop,TS val 157472 ecr 5643393], length 116
15:07:53.572260 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5980, win 249, options [nop,nop,TS val 5645236 ecr 157472,nop,nop,sack 1 {5864:5980}], length 0
15:08:00.154094 IP 10.0.0.164.60805 &gt; 192.168.1.177.46016: Flags [P.], seq 5864:5980, ack 4140, win 1629, options [nop,nop,TS val 158788 ecr 5643393], length 116
15:08:00.154256 IP 192.168.1.177.46016 &gt; 10.0.0.164.60805: Flags [.], ack 5980, win 249, options [nop,nop,TS val 5646881 ecr 158788,nop,nop,sack 1 {5864:5980}], length 0</code></pre></div><br /><br /><p>Thanks</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365160">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						10 Sep 2017, 12:29					</div>
				</div>
				<div class="post-content content">
					<p>Introducing additional services into the Public network which need to be accessed from LAN as well changes your network topology so much that I think you&#039;ll need to re-design it. The services which need to be accessible from both networks should be placed into a demilitarized zone, and the WAN network should be segregated to a zone of its own.</p><p>The firewall rule that we wrote was a quick way to block traffic. Your network complexity has outgrown the rule, and thus you need to plan it a-new.</p><p>Take out pen &amp; paper, and draw the entire network topology on paper. Place services that you want to expose to more than one network into a zone of their own. Also put the edge gateway into a zone of its own. This makes it easier to write access rules.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365209">
				<div class="post-metadata">
					<div class="post-num">Post #19</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						11 Sep 2017, 10:46					</div>
				</div>
				<div class="post-content content">
					<p>This network is a home network which I do not plan to expand or redesign and hope to keep it simple. I appreciate your suggestion but as of now I think I will first try to look for a solution to solve this problem.</p><p>By the way, I have used logread and dmesg to check the logs to get&nbsp; more clues. Can you tell me where else I can find other logs or any other commands to view the logs?</p><p>Regards</p>											<p class="post-edited">(Last edited by <strong>zorrox</strong> on 11 Sep 2017, 16:41)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365234">
				<div class="post-metadata">
					<div class="post-num">Post #20</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						11 Sep 2017, 21:57					</div>
				</div>
				<div class="post-content content">
					<p>Although I cannot be sure of this, I tend to think that these intermittent disconnections might be caused by the inherent complexity of your current configuration.</p><p>The UCI system is capable of creating pretty amazing firewall configurations based on the instructions it is given, but it is by no means complete or fail-safe. This fact bit me in the ankle when I had the need to create time-based limitations for the Internet-connected devices that our kids use. I had to resort to the &#039;firewall.user&#039; script file and non-UCI custom chains, all because the UCI system adds some default entries high up in the iptables filter table that cannot be effectively overridden in UCI config alone. And it does this even without you necessarily knowing it!</p><p>I think you should use &#039;iptables -t filter --list&#039;, &#039;iptables -t nat --list&#039; and &#039;iptables -t mangle --list&#039; in order to get a complete, full overview of all the intertwined rules that the current configuration establishes. Perhaps by analyzing these rules in detail we can get a better view on what is truly going on, and possibly pinpoint the failure.</p><p>For example, my innocent-looking UCI config:<br /></p><div class="codebox"><pre><code>root@OpenWRT:~# cat /etc/config/firewall

config defaults
        option syn_flood &#039;1&#039;
        option input &#039;REJECT&#039;
        option output &#039;REJECT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;lan&#039;
        option network &#039;lan&#039;
        option input &#039;ACCEPT&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;REJECT&#039;

config zone
        option name &#039;wan&#039;
        option network &#039;wan&#039;
        option input &#039;DROP&#039;
        option output &#039;ACCEPT&#039;
        option forward &#039;DROP&#039;
        option masq &#039;1&#039;
        option mtu_fix &#039;1&#039;

config forwarding
        option src &#039;lan&#039;
        option dest &#039;wan&#039;

config rule
        option name &#039;Allow-DHCP-Renew&#039;
        option src &#039;wan&#039;
        option proto &#039;udp&#039;
        option dest_port &#039;68&#039;
        option target &#039;ACCEPT&#039;

config include
        option path &#039;/etc/firewall.user&#039;

config include &#039;miniupnpd&#039;
        option type &#039;script&#039;
        option path &#039;/usr/share/miniupnpd/firewall.include&#039;
        option family &#039;any&#039;
        option reload &#039;1&#039;</code></pre></div><p>creates quite a complex configuration already: <a href="http://jekor.com/gressgraph/graph/e7641786ebe2591092ea5d69b46a69f2">http://jekor.com/gressgraph/graph/e7641 â€¦ 69b46a69f2</a>. </p><p>And this graph just shows the filter table, without any active UPnP redirects <img src="https://forum.openwrt.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365257">
				<div class="post-metadata">
					<div class="post-num">Post #21</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						12 Sep 2017, 09:50					</div>
				</div>
				<div class="post-content content">
					<p>Thank you for your explanation of the complexity of the firewall. It is always good to learn something new.<br />I do not really have the skills and knowledge to use the commands you suggested so I need to study further on how to use them. <br />For your information, the disconnection is not intermittent, so far all TCP connections from &quot;lan&quot; to &quot;public&quot; will always drop after about 20 seconds. I have even removed the deny rule below to allow full access from &quot;public&quot; to &quot;lan&quot; but the same issue persists. I am now looking for a way to view other logs on the device. </p><div class="codebox"><pre><code>config rule
        option name &#039;Deny public to lan&#039;
        option src &#039;public&#039;
        option dest &#039;lan&#039;
        option dest_ip &#039;192.168.1.0/24&#039;
        option proto &#039;all&#039;
        option target &#039;DROP&#039;
        option extra &#039;-m state --state NEW&#039;</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365281">
				<div class="post-metadata">
					<div class="post-num">Post #22</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						12 Sep 2017, 20:18					</div>
				</div>
				<div class="post-content content">
					<p>That sounds really strange. I can&#039;t really think of any reason why the iptables would drop the connection at the 20 seconds mark. Just a thought, but perhaps there&#039;s some sort of an auto-timeout at the SSH server?</p><p>Can you elaborate a little bit on the network topology? Is the SSH server, and the printer, directly connected to the OpenWRT router? Is the SSH server on a computer of its own, or is it hosted on the OpenWRT and just listens on the &quot;public&quot; network&#039;s interfaces? How is the printer shared to the network, is there a daemon running on OpenWRT, or does the printer have its own DHCP client and a printer daemon?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365310">
				<div class="post-metadata">
					<div class="post-num">Post #23</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						13 Sep 2017, 14:10					</div>
				</div>
				<div class="post-content content">
					<p>I do not think the SSH server has auto-timeout because when assigned with LAN ip address, there is no connection drop issue.</p><p>Here is my simplified network topology:</p><p><span class="postimg"><img src="https://img42.com/XVgbV" alt="https://img42.com/XVgbV" /></span></p><p>The SSH server is actually running on my android phone which is connected to WIFI on PUBLIC interface assigned with IP 10.0.0.x. The printer is also connected to the same WIFI. However If the android phone is connected to LAN interface WIFI which is assigned with IP 192.168.1.x, there is no connection drop issue connecting from devices on the same network. Any device can connect to the printer wirelessly using WIFI. The printer is just a normal WIFI HP printer. All devices get the IP from OpenWRT DHCP server running on LAN and PUBLIC interfaces. Please find below other configurations on openwrt:</p><p>DHCP:<br />config dhcp &#039;lan&#039;<br />&nbsp; &nbsp; option interface &#039;lan&#039;<br />&nbsp; &nbsp; option start &#039;100&#039;<br />&nbsp; &nbsp; option limit &#039;150&#039;<br />&nbsp; &nbsp; option leasetime &#039;12h&#039;<br />&nbsp; &nbsp; option dhcpv6 &#039;server&#039;<br />&nbsp; &nbsp; option ra &#039;server&#039;<br />&nbsp; &nbsp; option ra_management &#039;1&#039;<br />&nbsp; &nbsp; list dhcp_option &#039;3,192.168.1.10&#039;</p><p>config dhcp &#039;public&#039;<br />&nbsp; &nbsp; option interface &#039;public&#039;<br />&nbsp; &nbsp; option start &#039;50&#039;<br />&nbsp; &nbsp; option limit &#039;200&#039;<br />&nbsp; &nbsp; option leasetime &#039;6h&#039;</p><br /><p>network:<br />config interface &#039;lan&#039;<br />&nbsp; &nbsp; option force_link &#039;1&#039;<br />&nbsp; &nbsp; option type &#039;bridge&#039;<br />&nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; option ipaddr &#039;192.168.1.1&#039;<br />&nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option ip6assign &#039;60&#039;<br />&nbsp; &nbsp; option _orig_ifname &#039;eth0.1 wlan0 wlan1&#039;<br />&nbsp; &nbsp; option _orig_bridge &#039;true&#039;<br />&nbsp; &nbsp; option gateway &#039;192.168.1.10&#039;<br />&nbsp; &nbsp; option dns &#039;208.67.222.222 208.67.220.220&#039;<br />&nbsp; &nbsp; option ifname &#039;eth0.1 eth0.100&#039;<br />&nbsp; &nbsp; option stp &#039;1&#039;</p><p>config interface &#039;public&#039;<br />&nbsp; &nbsp; option proto &#039;static&#039;<br />&nbsp; &nbsp; option ipaddr &#039;10.0.0.1&#039;<br />&nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option _orig_ifname &#039;wlan0-1&#039;<br />&nbsp; &nbsp; option _orig_bridge &#039;true&#039;<br />&nbsp; &nbsp; option dns &#039;208.67.222.222 208.67.220.220&#039;</p><p>config switch<br />&nbsp; &nbsp; option name &#039;switch0&#039;<br />&nbsp; &nbsp; option reset &#039;1&#039;<br />&nbsp; &nbsp; option enable_vlan &#039;1&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; option vlan &#039;1&#039;<br />&nbsp; &nbsp; option vid &#039;1&#039;<br />&nbsp; &nbsp; option ports &#039;0t 1&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; option vlan &#039;3&#039;<br />&nbsp; &nbsp; option ports &#039;0t 1t 5&#039;<br />&nbsp; &nbsp; option vid &#039;600&#039;</p><p>config interface &#039;iptv&#039;<br />&nbsp; &nbsp; option proto &#039;dhcp&#039;<br />&nbsp; &nbsp; option ifname &#039;eth0.600&#039;</p><p>config route<br />&nbsp; &nbsp; option interface &#039;public&#039;<br />&nbsp; &nbsp; option target &#039;10.0.0.0&#039;<br />&nbsp; &nbsp; option netmask &#039;255.255.255.0&#039;<br />&nbsp; &nbsp; option gateway &#039;10.0.0.1&#039;</p><p>config switch_vlan<br />&nbsp; &nbsp; option device &#039;switch0&#039;<br />&nbsp; &nbsp; option vlan &#039;4&#039;<br />&nbsp; &nbsp; option vid &#039;100&#039;<br />&nbsp; &nbsp; option ports &#039;0t 1t 2 3 4&#039;</p><p>Wireless:<br />config wifi-iface<br />&nbsp; &nbsp; option device &#039;radio0&#039;<br />&nbsp; &nbsp; option mode &#039;ap&#039;<br />&nbsp; &nbsp; option ssid &#039;mynetworky&#039;<br />&nbsp; &nbsp; option encryption &#039;psk-mixed&#039;<br />&nbsp; &nbsp; option network &#039;lan&#039;</p><p>config wifi-iface<br />&nbsp; &nbsp; option device &#039;radio0&#039;<br />&nbsp; &nbsp; option mode &#039;ap&#039;<br />&nbsp; &nbsp; option ssid &#039;Duyuf&#039;<br />&nbsp; &nbsp; option encryption &#039;psk-mixed&#039;<br />&nbsp; &nbsp; option network &#039;public&#039;</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365332">
				<div class="post-metadata">
					<div class="post-num">Post #24</div>
					<div class="post-author">Antek</div>
					<div class="post-datetime">
						13 Sep 2017, 23:17					</div>
				</div>
				<div class="post-content content">
					<p>Ok, I see it now.</p><p>A few clarifying questions while I digest your config:<br />- Does the device running the pfSense firewall terminate the DSL link, or do you have a separate DSL modem?<br />- Apparently your ISP exposes their Internet service through VID 100 and an IPTV service through VID 600. Correct?<br />- What is the purpose of VID 1? Is it required to reach the management interface of the pfSense firewall?<br />- How do you want to use the OpenDNS DNS service? Only for your OWRT router, or for all wired and wireless clients as well?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p365358">
				<div class="post-metadata">
					<div class="post-num">Post #25</div>
					<div class="post-author">zorrox</div>
					<div class="post-datetime">
						14 Sep 2017, 12:22					</div>
				</div>
				<div class="post-content content">
					<p>My answers are below:</p><p>- Does the device running the pfSense firewall terminate the DSL link, or do you have a separate DSL modem?<br />Yes, terminated at pfsense</p><p>- Apparently your ISP exposes their Internet service through VID 100 and an IPTV service through VID 600. Correct?</p><p>My ISP Internet service is on VLAN 500 but this only configured on pfsense. VLAN 100 is only configured on openwrt. The openwrt has trunk connection to pfsense. The truth is I am also not really good with VLAN, I am still can not figure out why VLAN 100 configured on openwrt works while Internet connection on pfsense is on VLAN 500. You may able to figure this out. <br />VLAN 600 is configured on openwrt and pfsense for IPTV. The LAN interface and WAN interface on pfsense are configured with VLAN 600 and bridged on pfsense to enable IPTV. I think this is on layer 2 all the way to my ISP network.&nbsp; </p><p>- What is the purpose of VID 1? Is it required to reach the management interface of the pfSense firewall?</p><p>Not really. It was there based on other users configuration in my country which I stumbled on the Internet who subscribed to the same service. I do not remove it as I do not know how it can affect my network.</p><br /><p>- How do you want to use the OpenDNS DNS service? Only for your OWRT router, or for all wired and wireless clients as well?</p><p>I use OpenDNS for HTTPS web filtering to complement pfsense HTTP filtering. It is actually configured on openwrt only but all clients get DNS IP which is the openwrt interface IP. All clients DNS requests are relayed to OpenDNS by Openwrt.</p><p>I also observe that there is no drop connection between clients on 10.0.0.x. using the same SSH server and printer. </p><p>Thanks</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>