<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> (with Luci) how to forward packets to wan IP that are coming from lan?</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 30 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p83107">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						3 Mar 2009, 16:21					</div>
				</div>
				<div class="post-content content">
					<p>So, my setup is:<br />..........<br />lan IP 192.168.1.1<br />wan IP 71.246.215.8</p><p>config &#039;redirect&#039;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;src&#039; &#039;wan&#039;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;_name&#039; &#039;webserver&#039;&nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;proto&#039; &#039;tcp&#039;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;src_dport&#039; &#039;80&#039;&nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; option &#039;dest_ip&#039; &#039;192.168.1.8&#039;<br />..........</p><p> - http to 71.246.215.8 from wan works fine, forwards to 192.168.1.8<br /> - http to 192.168.1.1 from lan works fine, goes to Luci admin console<br /> - http to 71.246.215.8 from lan is wrong, SHOULD go to 192.168.1.8</p><p>So, I want to forward packets from the lan, addressed to the wan IP, as if they were external.</p><p>The desired behaviour from inside the lan is that I use 192.168.1.1 to get the Luci console, but that going via the DNS name (gogobeat.com) that resolves to 71.246.215.8 should forward as if it came from the wan.</p><p>How can I do this???&nbsp; I know it can be done, just not sure how...</p>											<p class="post-edited">(Last edited by <strong>toehser</strong> on 3 Mar 2009, 16:26)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83125">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						3 Mar 2009, 19:25					</div>
				</div>
				<div class="post-content content">
					<p>Maybe it would help if I understood what read the config file and what the format rules are?</p><p>I used to be OK with raw &#039;iptables&#039; stuff, though it has been a long while.</p><p>It certainly doesn&#039;t look as though the Luci interface gives the kind of options to do what I want?</p><p>So I guess I would have to manually edit the /etc/config/firewall file?</p><p>But I&#039;m not sure where documentation is for that thing, it certainly isn&#039;t iptables syntax.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83128">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						3 Mar 2009, 19:45					</div>
				</div>
				<div class="post-content content">
					<p>Hi.</p><p>The rules generated by LuCI are indeed in /etc/config/firewall. However, LuCI covers everything this iptables abstraction layer provides, so you won&#039;t be able to achieve your desired behaviour by editing /etc/config/firewall. As an alternative solution, you can add this to /etc/config/firewall:<br /></p><div class="codebox"><pre><code>config include
  option path /etc/firewall.user</code></pre></div><p>The file /etc/firewall.user is treated as a plain shell script then which is executed right after the default rules are built. Put manual iptables commands there to redirect traffic originating from lan and targeted at your wan ip to the correct chain.</p><p>~ JoW</p>											<p class="post-edited">(Last edited by <strong>jow</strong> on 3 Mar 2009, 19:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83131">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						3 Mar 2009, 20:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jow wrote:</cite><blockquote><p>The rules generated by LuCI are indeed in /etc/config/firewall. However, LuCI covers everything this iptables abstraction layer provides,</p></blockquote></div><p>Are you sure?&nbsp; I don&#039;t think so.</p><p>I&#039;m looking at the docs now for the uci firewall stuff - <a href="http://dev.luci.freifunk-halle.net/docsrv/section.firewall.redirect.xml">http://dev.luci.freifunk-halle.net/docs … direct.xml</a> -</p><p>... and I see docs, for example, for src-mac, for the source MAC address ...</p><p>... this is clearly an option covered by the /etc/config/firewall UCI stuff, but NOT supported by the Luci GUI interface ...</p><p>??? am I missing something</p><p>... It looks like I probably can do what I want with /etc/config/firewall, which would have the benefit of maybe showing up / being modifiable via future versions of Luci ...</p><p>From what I see, LuCI does _NOT_ cover everything the /etc/config/firewall provides, at least, not in 8.09.</p><p>Or am I missing some parts of LuCI?&nbsp; Maybe there is a &quot;third level&quot; beyond &quot;essentials&quot; and &quot;administration&quot; (expert? advanced?)?</p><p>Or are things like &quot;src-mac&quot; not really supported, and I&#039;m looking at the wrong web pages?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83132">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">Yanira</div>
					<div class="post-datetime">
						3 Mar 2009, 20:35					</div>
				</div>
				<div class="post-content content">
					<p>For UCI CLI:</p><div class="codebox"><pre><code>root@OpenWrt:~# uci add firewall include
root@OpenWrt:~# uci set firewall.@include[0].path=/etc/firewall.user
root@OpenWrt:~# uci commit firewall</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83133">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						3 Mar 2009, 20:41					</div>
				</div>
				<div class="post-content content">
					<p>On the other hand, it seems to provide:<br /> dest Destination zone<br /> dest_ip Destination IP address<br /> dest_port Destination port<br /> proto Protocol<br /> src Source zone<br /> src_dport Source destination port<br /> src_ip Source IP address<br /> src_mac Option src_mac<br /> src_port Source port</p><p>as options in /etc/config/firewall... more than the GUI provides... but...</p><p>... NOT including &quot;src_dip Source destination IP address&quot;...</p><p>The &quot;dest&quot; fields are where I&#039;m redirecting to.</p><p>The &quot;src&quot; fields are about the packet as it came in.</p><p>I have 2 packets, one came in to 192.168.1.1, one came in to 71.246.215.8.</p><p>But both are zone &quot;lan&quot;, both are src dport &quot;80&quot; ... what I really need is &quot;src_dip&quot; or &quot;src_dest_ip&quot;.</p><p>Unless I&#039;m missing something?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83134">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">CyrusFF</div>
					<div class="post-datetime">
						3 Mar 2009, 20:42					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>toehser wrote:</cite><blockquote><div class="quotebox"><cite>jow wrote:</cite><blockquote><p>The rules generated by LuCI are indeed in /etc/config/firewall. However, LuCI covers everything this iptables abstraction layer provides,</p></blockquote></div><p>Are you sure?&nbsp; I don&#039;t think so.</p><p>... this is clearly an option covered by the /etc/config/firewall UCI stuff, but NOT supported by the Luci GUI interface ...</p><p>??? am I missing something</p></blockquote></div><p>You can find it in Administration -&gt; Network -&gt; Firewall -&gt; Redirect if you click on the Edit-Button of a row (the one left of the delete button).</p><p>Jow is right, everything except the include-sections should be covered.</p>											<p class="post-edited">(Last edited by <strong>CyrusFF</strong> on 3 Mar 2009, 20:46)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83135">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						3 Mar 2009, 20:45					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>Yanira wrote:</cite><blockquote><p>For UCI CLI:</p><div class="codebox"><pre><code>root@OpenWrt:~# uci add firewall include
root@OpenWrt:~# uci set firewall.@include[0].path=/etc/firewall.user
root@OpenWrt:~# uci commit firewall</code></pre></div></blockquote></div><p>OK.&nbsp; I guess I was hoping this would be a common enough configuration that it would have a UCI way.</p><p>Since I&#039;m running the authoritative DNS, it is not simple to just give a different address to the hostname internally.</p><p>Since the webserver uses virtual domains, an to boot there are absolute references to the name in the pages, it isn&#039;t simple to use another name without the canonical one working.</p><p>So, to raw iptables it is...&nbsp; I guess I have to crack out the &#039;man iptables&#039;?</p><p>Or has anyone done something similar enough to point me to a snippet?</p><p>Being able to do this would be a nice feature to have...</p><p>But, if raw iptables it is, then raw iptables it is.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83136">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						3 Mar 2009, 20:51					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>CyrusFF wrote:</cite><blockquote><p>You can find it in Administration -&gt; Network -&gt; Firewall -&gt; Redirect if you click on the Edit-Button of a row (the one left of the delete button).</p><p>Jow is right, everything except the include-sections should be covered.</p></blockquote></div><p>Got it.&nbsp; So the expected current behaviour is that there is no way without the include to have requests from inside the lan to the wan-IP behave the same way they would if they originated from the wan?&nbsp; I guess what I really want is a way to treat a packet from 192.168.1.x to 71.246.215.8 as if it was zone wan- as though it had looped out and back in.</p><p>What about the alternative- is it possible to have the router not even have the wan IP, to give that to a machine on the lan, and have all requests from the wan go to that machine?&nbsp; Does the router have to have a wan IP?&nbsp; I only get one static IP without paying way more than a few more static IPs should cost.&nbsp; I would be fine if I could configure an internal machine with that IP, and only have NAT traffic go to the others...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83143">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						3 Mar 2009, 21:50					</div>
				</div>
				<div class="post-content content">
					<p>Would enhancing this require change both to UCI (C) and LuCI (Lua)?&nbsp; Or just to UCI and the Lua part will automatically pick up and bind GUI components?</p><p>Or is there a 3rd piece, with UCI managing config structures, LuCI as GUI for modifications, and then back-ends to do actual (i.e. iptables) work?</p><p>If I want to enhance it, could I get some feedback on whether this would be generally desired, or something I would just keep locally?</p><p>UCI comes from BSD or something, doesn&#039;t it?&nbsp; Wish it was all just in Lua, I used to use Lua on tomsrtbt.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83159">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						3 Mar 2009, 23:53					</div>
				</div>
				<div class="post-content content">
					<p>So, I&#039;m clearly more ignorant than I thought, I thought:</p><p>iptables -t nat -I zone_lan_prerouting -p tcp --dport 80 -d 71.246.215.8 -j DNAT --to 192.168.1.8:80<br />iptables -t filter -I zone_lan_forward -d 192.168.1.8/32 -p tcp --dport 80 -j ACCEPT</p><p>would work, but, no, what am I missing?&nbsp; Is there a better place to ask this question?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83160">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						4 Mar 2009, 00:05					</div>
				</div>
				<div class="post-content content">
					<p>Hi.</p><p>If you want to change the default behaviour, you would have to change the uci firewall backend in /lib/firewall/uci_firewall.sh. You&#039;ll see a fw_redirect() procedure there which generates the actual port forwarding rules. I&#039;m not sure whether it&#039;s solveable in a generic way, afaik you&#039;d need to create appropriate iptables rules in each other zone when adding a portforward, so that it does not only match traffic from e.g. wan-&gt;lan but lan-&gt;lan or xyz-&gt;lan too.</p><p>If you extend the firewall uci (which happens indirectly by editing the shell backend) you&#039;d have to add the appropriate optiosn to LuCI too which is not that hard, but one step at the time.</p><p>Afaik UCI is no BSD thing, iirc it was developed as successor of the old nvram based config system but I might be wrong.</p><p>HTH, JoW</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83162">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						4 Mar 2009, 00:09					</div>
				</div>
				<div class="post-content content">
					<p>So <a href="http://people.freebsd.org/~abial/UCI.html">http://people.freebsd.org/~abial/UCI.html</a> is just coincidence.</p><p>As far as my iptables example failing - any ideas?</p><p>I&#039;ll have to figure out how to get iptables to log on openwrt, operating blindly didn&#039;t work.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83481">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						8 Mar 2009, 22:44					</div>
				</div>
				<div class="post-content content">
					<p>Ok, FWIW, what WORKS for this, which I&#039;m going to be too lazy to submit a uci/luci patch to manage, was this, in the firewall.user:</p><p>iptables -t nat -A zone_lan_prerouting -p tcp -m tcp -s 192.168.1.0/24 -d 71.246.215.8 --dport 80 -j DNAT --to-destination 192.168.1.8:80<br />iptables -t nat -N toms_internal_nat<br />iptables -t nat -A POSTROUTING -j toms_internal_nat<br />iptables -t nat -A toms_internal_nat -p tcp -m tcp -d 192.168.1.8 --dport 80 -s 192.168.1.0/24 -j SNAT --to-source 192.168.1.1</p><p>the one rule says that traffic from the internal lan to the wan IP gets d-natted to the internal webserver.<br />the other rule says that that traffics is s-natted to come from the router, so returns can match up right.</p><p>Personally, I think this should be the right way 99% of the time... And more likely shoudl be the _default_ than something that requires this much thinking...</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p83488">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">toehser</div>
					<div class="post-datetime">
						9 Mar 2009, 00:54					</div>
				</div>
				<div class="post-content content">
					<p>Missed one thing and had it too complex:</p><p>iptables -t nat -A prerouting_lan -p tcp -m tcp -s 192.168.1.0/24 -d 71.246.215.8 --dport 80 -j DNAT --to-destination 192.168.1.8:80<br />iptables -t nat -A postrouting_rule -p tcp -m tcp -d 192.168.1.8 --dport 80 -s 192.168.1.0/24 -j SNAT --to-source 192.168.1.1<br />iptables -t filter -A forwarding_lan -d 192.168.1.8 -s 192.168.1.0/24 -p tcp -m tcp --dport 80 -j ACCEPT</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p95266">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">jaimesilva</div>
					<div class="post-datetime">
						3 Oct 2009, 00:09					</div>
				</div>
				<div class="post-content content">
					<p>Thanks a lot, this has been of great help to me.</p><p>I needed to apply it to multiple ports: http, https and ssh (cause I want my laptop&#039;s Gnome sftp bookmarks to work when I&#039;m in and out of the lan) also I have dynamic dns (with dyndns.com) in my domain, however the IP is rarely changed by the ISP (almost static) so I need to get it from the interface.</p><p>Here is what I put in /etc/firewall.user:</p><div class="codebox"><pre><code># This file is interpreted as shell script.
# Put your custom iptables rules here, they will
# be executed with each firewall (re-)start.

lan_src=10.1.52.0/24
wan_ip=$(ifconfig eth0.1 | awk  &#039;/inet addr:/ {print $2}&#039; | awk -F : &#039;{print $2}&#039;)
lan_ip=10.1.52.1
server_ip=10.1.52.2
ports=&quot;80 443 22&quot;

for p in $ports
do
    iptables -t nat -A prerouting_lan -p tcp -m tcp -s $lan_src -d $wan_ip --dport $p -j DNAT --to-destination ${server_ip}:$p
    iptables -t nat -A postrouting_rule -p tcp -m tcp -d $server_ip --dport $p -s $lan_src -j SNAT --to-source $lan_ip
    iptables -t filter -A forwarding_lan -d $server_ip -s $lan_src -p tcp -m tcp --dport $p -j ACCEPT
done</code></pre></div><p>BTW I have a few questions:</p><p>- Is there an easier and/or shorter command to get an interface IP?<br />- How do I get the command &#039;/etc/init.d/firewall reload&#039; to be run each time my wan IP changes?<br />- Or, to avoid all the trouble, can I use the interface (eth0.1) in the rules instead of the IP? How?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p95297">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">jow</div>
					<div class="post-datetime">
						3 Oct 2009, 19:33					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>jaimesilva wrote:</cite><blockquote><p>- Is there an easier and/or shorter command to get an interface IP?</p></blockquote></div><div class="codebox"><pre><code>IP=$(uci -P/var/state get network.wan.ipaddr)</code></pre></div><div class="quotebox"><cite>jaimesilva wrote:</cite><blockquote><p>- How do I get the command &#039;/etc/init.d/firewall reload&#039; to be run each time my wan IP changes?</p></blockquote></div><p>This is the wrong way, put your rules into a hotplug handler instead, e.g. /etc/hotplug.d/iface/90-my-ipt-rules with contents similar to this:<br /></p><div class="codebox"><pre><code>#!/bin/sh
if [ &quot;$ACTION&quot; = &quot;ifup&quot; ] &amp;&amp; [ &quot;$INTERFACE&quot; = &quot;wan&quot; ]; then
  IP=&quot;$(uci -P/var/state get network.$INTERFACE.ipaddr)&quot;
  iptables ...
fi</code></pre></div><p>If you use trunk or really new 8.09 branch revisions you can also use the newly introduced firewall hotplug events: <a href="https://wiki.openwrt.org/doc/firewall#hotplug.hooks.8.09.2">https://wiki.openwrt.org/doc/firewall#h … oks.8.09.2</a></p><div class="quotebox"><cite>jaimesilva wrote:</cite><blockquote><p>- Or, to avoid all the trouble, can I use the interface (eth0.1) in the rules instead of the IP? How?</p></blockquote></div><p>You can get the eth-name of an openwrt interface with </p><div class="codebox"><pre><code>uci -P/var/state get network.wan.ifname</code></pre></div><p>.</p><p>~ JoW</p>											<p class="post-edited">(Last edited by <strong>jow</strong> on 3 Oct 2009, 19:39)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p109951">
				<div class="post-metadata">
					<div class="post-num">Post #18</div>
					<div class="post-author">maddes.b</div>
					<div class="post-datetime">
						27 May 2010, 14:45					</div>
				</div>
				<div class="post-content content">
					<p>Also have a look at <a href="https://forum.openwrt.org/viewtopic.php?id=24719">this HowTo</a> it shows how to get the correct interface name for a network, e.g. wan via pppoe, bridged lan, etc.<br />The script there does not cover 100% of all cases yet, but it gives you a good insight how to do this very flexible in a script.<br />Could come in handy, otherwise ignore it.</p>											<p class="post-edited">(Last edited by <strong>maddes.b</strong> on 27 May 2010, 14:47)</p>
									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>