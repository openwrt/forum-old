<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> OpenVPN Policy-Based Routing + Web UI -- testers needed</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 29 Mar 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p351193">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						5 Feb 2017, 21:29					</div>
				</div>
				<div class="post-content content">
					<p>This thread is no longer monitored. Please ask any questions at <a href="https://forum.lede-project.org/t/openvpn-policy-based-routing-web-ui-testers-needed/1422.">https://forum.lede-project.org/t/openvp … eded/1422.</a></p><p>As the VPNBypass package was well received but was lacking ability to explicitly route specific traffic via OpenVPN tunnel instead of bypassing it, I&#039;ve written a policy-based routing service.</p><p>Please make sure to go over <a href="https://github.com/stangri/openwrt-packages/blob/openvpn-policy-routing/net/openvpn-policy-routing/files/README.md">README</a> or at least its <a href="https://github.com/stangri/openwrt-packages/blob/openvpn-policy-routing/net/openvpn-policy-routing/files/README.md#known-issues">Known Issues</a> section.</p><p>Both openvpn-policy-routing and luci-app-openvpn-policy-routing are available from my own repository: <a href="https://stangri.github.io/openwrt-repo/.">https://stangri.github.io/openwrt-repo/.</a></p><p>I&#039;d welcome any feedback!</p>											<p class="post-edited">(Last edited by <strong>stangri</strong> on 10 May 2017, 07:16)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351631">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						11 Feb 2017, 04:53					</div>
				</div>
				<div class="post-content content">
					<p>From version 3.0, openvpn-policy-routing supports multiple OpenVPN tunnels.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351638">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">marktomlinson32</div>
					<div class="post-datetime">
						11 Feb 2017, 07:30					</div>
				</div>
				<div class="post-content content">
					<p>thanks. trying to install now, will report back</p>											<p class="post-edited">(Last edited by <strong>marktomlinson32</strong> on 11 Feb 2017, 08:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p351699">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						12 Feb 2017, 00:30					</div>
				</div>
				<div class="post-content content">
					<p>From version 3.1 supports strict enforcement of policies when their gateway is down (resulting in network unreachable for affected policies).</p><p>Could be used if you want to ensure that the specific policy (I&#039;ve only tested it with a single local IP) is routed thru specific gateway and has no connectivity when that gateway is down.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p352742">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">marktomlinson32</div>
					<div class="post-datetime">
						23 Feb 2017, 07:54					</div>
				</div>
				<div class="post-content content">
					<p>ok, so i have got it installed, but seem to have an issue..<br />for some reason&nbsp; what ever combination of ip i put in for ip4/port based policies... it&#039;s coming up invalid and as such not saving.&nbsp; for example.. 192.168.2.13<br />any ideas?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p352743">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">marktomlinson32</div>
					<div class="post-datetime">
						23 Feb 2017, 07:56					</div>
				</div>
				<div class="post-content content">
					<p><span class="postimg"><img src="https://s8.postimg.org/58o18i0th/Capture.jpg" alt="https://s8.postimg.org/58o18i0th/Capture.jpg" /></span></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p352746">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						23 Feb 2017, 08:23					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>marktomlinson32 wrote:</cite><blockquote><p>ok, so i have got it installed, but seem to have an issue..<br />for some reason&nbsp; what ever combination of ip i put in for ip4/port based policies... it&#039;s coming up invalid and as such not saving.&nbsp; for example.. 192.168.2.13<br />any ideas?</p></blockquote></div><p>Sorry about that, I was experimenting with datatypes and validation and accidentally pushed the ipk to github. Please redownload and force-reinstall it with:<br /></p><div class="codebox"><pre><code>opkg --force-reinstall install luci-app-openvpn-policy-routing_git-17.027.48745-f5461669a-1_all.ipk</code></pre></div><p>PS. IPv6 is not working yet.</p>											<p class="post-edited">(Last edited by <strong>stangri</strong> on 23 Feb 2017, 08:25)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p355234">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">deese.john</div>
					<div class="post-datetime">
						30 Mar 2017, 06:25					</div>
				</div>
				<div class="post-content content">
					<p>When doing an opkg update I get the following:<br /></p><div class="codebox"><pre><code>Downloading https://raw.githubusercontent.com/stangri/openwrt-repo/master/Packages.gz.
Downloading https://raw.githubusercontent.com/stangri/openwrt-repo/master/Packages.sig.
Signature check failed.</code></pre></div><p>I&#039;m running OpenWrt CC 15.05.1 and followed your instructions. Is there a problem with your build process? Any ideas? I&#039;m excited to try your luci-app, the screenshots look like exactly what I&#039;m looking for!</p>											<p class="post-edited">(Last edited by <strong>deese.john</strong> on 30 Mar 2017, 06:35)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p355305">
				<div class="post-metadata">
					<div class="post-num">Post #9</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						31 Mar 2017, 01:36					</div>
				</div>
				<div class="post-content content">
					<p>Can you post commands and the output of:<br /></p><div class="codebox"><pre><code>echo -e -n &#039;untrusted comment: public key 7ffc7517c4cc0c56\nRWR//HUXxMwMVnx7fESOKO7x8XoW4/dRidJPjt91hAAU2L59mYvHy0Fa\n&#039; &gt; /tmp/stangri-repo.pub
opkg-key add /tmp/stangri-repo.pub</code></pre></div><p>And then run opkg update again.</p><p>PS. I couldn&#039;t figure out why the forum software breaks the first line, it should all be one line:<br />echo -e -n &#039;untrusted comment: public key 7ffc7517c4cc0c56\nRWR//HUXxMwMVnx7fESOKO7x8XoW4/dRidJPjt91hAAU2L59mYvHy0Fa\n&#039; &gt; /tmp/stangri-repo.pub</p>											<p class="post-edited">(Last edited by <strong>stangri</strong> on 31 Mar 2017, 01:38)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p355308">
				<div class="post-metadata">
					<div class="post-num">Post #10</div>
					<div class="post-author">kocrachon</div>
					<div class="post-datetime">
						31 Mar 2017, 01:48					</div>
				</div>
				<div class="post-content content">
					<p>EDIT: Resolved, appears to have been an issue with my VPN, turned off VPN and it worked after that. Leaving for just in case. </p><p>When trying to do the repo add, I get the following</p><br /><div class="codebox"><pre><code>Collected errors:
 * opkg_download: Failed to download https://raw.githubusercontent.com/stangri/openwrt-repo/master/Packages.gz, wget returned 4.
 * opkg_download: Failed to download https://raw.githubusercontent.com/stangri/openwrt-repo/master/Packages.sig, wget returned 4.</code></pre></div>											<p class="post-edited">(Last edited by <strong>kocrachon</strong> on 31 Mar 2017, 02:48)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p355310">
				<div class="post-metadata">
					<div class="post-num">Post #11</div>
					<div class="post-author">kocrachon</div>
					<div class="post-datetime">
						31 Mar 2017, 02:09					</div>
				</div>
				<div class="post-content content">
					<p>I am currently running into two issues. 1) I cannot get domain policy to work. and 2) I cannot get remote-port policy to work. If I do a policy on just an IP/IP range, it seems fine.</p><p>Version info</p><div class="codebox"><pre><code>    root@OpenWrt:~# opkg list-installed | grep policy
    luci-app-openvpn-policy-routing - git-17.080.69173-773734e27-4
    openvpn-policy-routing - 4.1.4-21</code></pre></div><p><strong>For the domain policy</strong></p><div class="codebox"><pre><code>    opkg update; opkg remove dnsmasq; opkg install ipset iptables dnsmasq-full
    Package ipset (6.24-1) installed in root is up to date.
    Package iptables (1.4.21-2) installed in root is up to date.
    Package dnsmasq-full (2.76-1) installed in root is up to date.</code></pre></div><p>I go to domains, and I have this as my &quot;Domains Policies&quot;</p><div class="codebox"><pre><code>/whatismyipaddress.com/hulu.com/netflix.com/wanroute</code></pre></div><p>Netflix still prevents me, and the whatiymyipaddress still shows my VPN IP.</p><p><strong>As for my remote-port based policy.</strong></p><p>Basically, I have remote ports 1001-65535 set to WAN for my local desktop. Some things, like EC2 instances, properly work with my WAN ip if I set my security group /firewall settings to allow my WAN IP. But stuff like Teamspeak and Steam, seem to still be using my VPN IP. I am not sure where this might be comming from.<br />One example, with my VPN on, my steam speeds are slow because of my VPN provider for whatever reason. It slowls builds up. But when I turn off my VPN, my speeds sky rocket. VPN provider issue aside, Steam is supposed to be using the following ports.</p><div class="codebox"><pre><code>27000 through 27037</code></pre></div><p>All of these should be included in my broad IP selection of 1001-65535 to WAN. So I am not sure what the issue is.</p><p>I also tried hosting a game server on port 2302, and when people connect, it shows them the VPN IP, so it seems my remote-port based routing is not working as intended?</p><div class="codebox"><pre><code>    root@OpenWrt:~# opkg list_installed | grep dnsmasq
    dnsmasq-full - 2.76-1
    root@OpenWrt:~# grep ipset /etc/config/dhcp
            list ipset &#039;/hulu.com/netflix.com/nhl.com/whatismyipaddress.com/wanroute&#039;</code></pre></div><p><strong>openvpn-policy-routing file</strong></p><div class="codebox"><pre><code>    config openvpn-policy-routing &#039;config&#039;
            option strict_enforcement &#039;1&#039;
            option verbosity &#039;2&#039;
            option enabled &#039;1&#039;

    config domain-policy
            list ipset &#039;/hulu.com/netflix.com/wanroute&#039;
            list ipset &#039;/whatismyipaddress.com/wanroute&#039;

    config policy
            option gateway &#039;wan&#039;
            option comment &#039;FireTV&#039;
            option local_addrs &#039;192.168.1.150&#039;

    config policy
            option gateway &#039;wan&#039;
            option comment &#039;MyPC-WAN&#039;
            option remote_ports &#039;1001-65535&#039;</code></pre></div><p>My DHCP Config</p><div class="codebox"><pre><code>    config dnsmasq
            option domainneeded &#039;1&#039;
            option boguspriv &#039;1&#039;
            option filterwin2k &#039;0&#039;
            option localise_queries &#039;1&#039;
            option rebind_protection &#039;1&#039;
            option rebind_localhost &#039;1&#039;
            option local &#039;/lan/&#039;
            option domain &#039;lan&#039;
            option expandhosts &#039;1&#039;
            option nonegcache &#039;0&#039;
            option authoritative &#039;1&#039;
            option readethers &#039;1&#039;
            option leasefile &#039;/tmp/dhcp.leases&#039;
            option resolvfile &#039;/tmp/resolv.conf.auto&#039;
            option localservice &#039;1&#039;
            list ipset &#039;/hulu.com/netflix.com/nhl.com/whatismyipaddress.com/wanroute&#039;

    config dhcp &#039;lan&#039;
            option interface &#039;lan&#039;
            option start &#039;100&#039;
            option limit &#039;150&#039;
            option leasetime &#039;12h&#039;
            option dhcpv6 &#039;server&#039;
            option ra &#039;server&#039;
            list dhcp_option &#039;6,209.222.18.222,209.222.18.218&#039;
            option ra_management &#039;1&#039;

    config dhcp &#039;wan&#039;
            option interface &#039;wan&#039;
            option ignore &#039;1&#039;

    config odhcpd &#039;odhcpd&#039;
            option maindhcp &#039;0&#039;
            option leasefile &#039;/tmp/hosts/odhcpd&#039;
            option leasetrigger &#039;/usr/sbin/odhcpd-update&#039;</code></pre></div><p>My DNSMasq config</p><div class="codebox"><pre><code>    # auto-generated config file from /etc/config/dhcp
    conf-file=/etc/dnsmasq.conf
    dhcp-authoritative
    domain-needed
    localise-queries
    read-ethers
    bogus-priv
    expand-hosts
    local-service
    domain=lan
    server=/lan/
    ipset=/hulu.com/netflix.com/nhl.com/whatismyipaddress.com/wanroute
    dhcp-leasefile=/tmp/dhcp.leases
    resolv-file=/tmp/resolv.conf.auto
    stop-dns-rebind
    rebind-localhost-ok
    dhcp-broadcast=tag:needs-broadcast
    addn-hosts=/tmp/hosts
    conf-dir=/tmp/dnsmasq.d
    user=dnsmasq
    group=dnsmasq




    dhcp-range=lan,192.168.1.100,192.168.1.249,255.255.255.0,12h
    dhcp-option=lan,6,209.222.18.222,209.222.18.218
    no-dhcp-interface=br-wan</code></pre></div>											<p class="post-edited">(Last edited by <strong>kocrachon</strong> on 31 Mar 2017, 05:20)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p355317">
				<div class="post-metadata">
					<div class="post-num">Post #12</div>
					<div class="post-author">deese.john</div>
					<div class="post-datetime">
						31 Mar 2017, 03:23					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;ve been doing it in one line, so I don&#039;t believe that is the problem.</p><div class="codebox"><pre><code>root@OpenWrt:~# echo -e -n &#039;untrusted comment: public key 7ffc7517c4cc0c56\nRWR/
/HUXxMwMVnx7fESOKO7x8XoW4/dRidJPjt91hAAU2L59mYvHy0Fa\n&#039; &gt; /tmp/stangri-repo.pub
root@OpenWrt:~# opkg-key add /tmp/stangri-repo.pub
root@OpenWrt:~# opkg update
Downloading https://raw.githubusercontent.com/stangri/openwrt-repo/master/Packages.gz.
Downloading https://raw.githubusercontent.com/stangri/openwrt-repo/master/Packages.sig.
Signature check failed.
Remove wrong Signature file.</code></pre></div><p>Here is the key<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# cat /etc/opkg/keys/7ffc7517c4cc0c56
untrusted comment: public key 7ffc7517c4cc0c56
RWR//HUXxMwMVnx7fESOKO7x8XoW4/dRidJPjt91hAAU2L59mYvHy0Fa</code></pre></div>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p355331">
				<div class="post-metadata">
					<div class="post-num">Post #13</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						31 Mar 2017, 08:31					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>deese.john wrote:</cite><blockquote><p>I&#039;ve been doing it in one line, so I don&#039;t believe that is the problem.</p><div class="codebox"><pre><code>root@OpenWrt:~# echo -e -n &#039;untrusted comment: public key 7ffc7517c4cc0c56\nRWR/
/HUXxMwMVnx7fESOKO7x8XoW4/dRidJPjt91hAAU2L59mYvHy0Fa\n&#039; &gt; /tmp/stangri-repo.pub
root@OpenWrt:~# opkg-key add /tmp/stangri-repo.pub
root@OpenWrt:~# opkg update
Downloading https://raw.githubusercontent.com/stangri/openwrt-repo/master/Packages.gz.
Downloading https://raw.githubusercontent.com/stangri/openwrt-repo/master/Packages.sig.
Signature check failed.
Remove wrong Signature file.</code></pre></div><p>Here is the key<br /></p><div class="codebox"><pre><code>root@OpenWrt:~# cat /etc/opkg/keys/7ffc7517c4cc0c56
untrusted comment: public key 7ffc7517c4cc0c56
RWR//HUXxMwMVnx7fESOKO7x8XoW4/dRidJPjt91hAAU2L59mYvHy0Fa</code></pre></div></blockquote></div><p>Khm, that&#039;s a pickle, let me consult with guru devs and get back to you.</p><br /><p>@kocrachon -- let&#039;s continue that on LEDE forum.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p355336">
				<div class="post-metadata">
					<div class="post-num">Post #14</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						31 Mar 2017, 09:06					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>deese.john wrote:</cite><blockquote><p>I&#039;ve been doing it in one line, so I don&#039;t believe that is the problem.</p></blockquote></div><p>While I&#039;m trying to figure why OpenWrt errors out on the signature you can turn off signature verification by doing:<br /></p><div class="codebox"><pre><code>sed -i &#039;s/option check_signature 1/option check_signature 0/&#039; /etc/opkg.conf</code></pre></div>											<p class="post-edited">(Last edited by <strong>stangri</strong> on 31 Mar 2017, 09:07)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p355511">
				<div class="post-metadata">
					<div class="post-num">Post #15</div>
					<div class="post-author">novowest</div>
					<div class="post-datetime">
						3 Apr 2017, 04:09					</div>
				</div>
				<div class="post-content content">
					<p>I&#039;m seeing the same error (Signature check failed.) using openwrt 15.05.&nbsp; Tried to turn off signature checking.&nbsp; Still an error.<br />FYI.&nbsp; When I try to access /stangri/openwrt-repo/master from a browser, I get an error 400: Invalid request.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p355526">
				<div class="post-metadata">
					<div class="post-num">Post #16</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						3 Apr 2017, 13:30					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>novowest wrote:</cite><blockquote><p>Tried to turn off signature checking.&nbsp; Still an error.</p></blockquote></div><p>What error? Can you post your /etc/opkg.conf?</p><div class="quotebox"><cite>novowest wrote:</cite><blockquote><p>FYI.&nbsp; When I try to access /stangri/openwrt-repo/master from a browser, I get an error 400: Invalid request.</p></blockquote></div><p>Probably because there&#039;s no /stangri/openwrt-repo/master on your computer?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p358138">
				<div class="post-metadata">
					<div class="post-num">Post #17</div>
					<div class="post-author">stangri</div>
					<div class="post-datetime">
						10 May 2017, 07:16					</div>
				</div>
				<div class="post-content content">
					<p>This thread is no longer monitored. Please ask any questions at <a href="https://forum.lede-project.org/t/openvpn-policy-based-routing-web-ui-testers-needed/1422.">https://forum.lede-project.org/t/openvp … eded/1422.</a></p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>