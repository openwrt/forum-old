<!DOCTYPE html>
<html lang="en-US">
<head>

	<title>OpenWrt Forum Archive</title>

	<meta charset="UTF-8">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="assets/css/common.css">

</head>
<body>

<div class="container">

<header class="main-header">
	<h1 class="logo"><a href="index.html"><img src="assets/img/logo.png" width="376" height="88" alt="OpenWrt Forum Archive"></a></h1>
</header>

<aside>
	<p>This is a read-only archive of the old OpenWrt forum. The current OpenWrt forum resides at <a href="https://forum.openwrt.org/">https://forum.openwrt.org/</a>.</p>
	<p class="minor">In May 2018, the OpenWrt forum suffered a total data loss. This archive is an effort to restore and make available as much content as possible. Content may be missing or not representing the latest edited version.</p>
</aside>

<main>
	<header>
		<h1><span class="minor">Topic:</span> TP-Link MR3420 v1.3 extroot problem</h1>
	</header>
	<div class="notice minor">
		<p>
			The content of this topic has been archived
							on 7 Apr 2018.
										There are no obvious gaps in this topic, but there may still be some posts missing at the end.
					</p>
	</div>

	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
			
		
		
			<article class="post" id="p180682">
				<div class="post-metadata">
					<div class="post-num">Post #1</div>
					<div class="post-author">pjiwa</div>
					<div class="post-datetime">
						15 Oct 2012, 19:48					</div>
				</div>
				<div class="post-content content">
					<p>Hi..I&#039;m follow tutorial from <a href="http://wiki.openwrt.org/doc/howto/extroot">http://wiki.openwrt.org/doc/howto/extroot</a> <strong>(OpenWrt Attitude Adjustment (Trunk))</strong> and i set my mr3420 and get like this <span class="postimg"><img src="http://i1086.photobucket.com/albums/j447/affendi_1979/extroot.jpg" alt="http://i1086.photobucket.com/albums/j447/affendi_1979/extroot.jpg" /></span><br />I still unable to use my 320gb HDD with this router <img src="https://forum.openwrt.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p180683">
				<div class="post-metadata">
					<div class="post-num">Post #2</div>
					<div class="post-author">johan666</div>
					<div class="post-datetime">
						15 Oct 2012, 20:31					</div>
				</div>
				<div class="post-content content">
					<p>Obviously you have made some mistakes.<br />check system log see what happen</p><p><span class="postimg"><img src="http://i50.tinypic.com/e6p1z5.jpg" alt="http://i50.tinypic.com/e6p1z5.jpg" /></span></p><p>What have your done actually.&nbsp; (don&#039;t just tell you&#039;ve followed...)<br />320GiB is toooooo much.&nbsp; If you install all packages, you will only need 200MB</p>											<p class="post-edited">(Last edited by <strong>johan666</strong> on 15 Oct 2012, 20:39)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293345">
				<div class="post-metadata">
					<div class="post-num">Post #3</div>
					<div class="post-author">DrStein</div>
					<div class="post-datetime">
						24 Sep 2015, 22:05					</div>
				</div>
				<div class="post-content content">
					<p>A new reborn of this problem: in the latest firmware (Chaos Calmer) it is impossible to implement extroot according <a href="http://wiki.openwrt.org/doc/howto/extroot#chaos_calmer">wiki manual</a>. Not enough space to install necessary packages <em>block-mount kmod-fs-ext4 kmod-usb-storage</em>! Even with <strong>option force_space</strong>.</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293359">
				<div class="post-metadata">
					<div class="post-num">Post #4</div>
					<div class="post-author">kgoerbig</div>
					<div class="post-datetime">
						24 Sep 2015, 23:51					</div>
				</div>
				<div class="post-content content">
					<div class="quotebox"><cite>DrStein wrote:</cite><blockquote><p>A new reborn of this problem: in the latest firmware (Chaos Calmer) it is impossible to implement extroot according <a href="http://wiki.openwrt.org/doc/howto/extroot#chaos_calmer">wiki manual</a>. Not enough space to install necessary packages <em>block-mount kmod-fs-ext4 kmod-usb-storage</em>! Even with <strong>option force_space</strong>.</p></blockquote></div><br /><p>I have it working in CC:</p><p>root@OpenWrt:/# cat /etc/banner<br />&nbsp; _______&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________&nbsp; &nbsp; &nbsp; &nbsp; __<br /> |&nbsp; &nbsp; &nbsp; &nbsp;|.-----.-----.-----.|&nbsp; |&nbsp; |&nbsp; |.----.|&nbsp; |_<br /> |&nbsp; &nbsp;-&nbsp; &nbsp;||&nbsp; _&nbsp; |&nbsp; -__|&nbsp; &nbsp; &nbsp;||&nbsp; |&nbsp; |&nbsp; ||&nbsp; &nbsp;_||&nbsp; &nbsp;_|<br /> |_______||&nbsp; &nbsp;__|_____|__|__||________||__|&nbsp; |____|<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |__| W I R E L E S S&nbsp; &nbsp;F R E E D O M<br /> -----------------------------------------------------<br /> CHAOS CALMER (Bleeding Edge, r46815)<br /> -----------------------------------------------------<br />&nbsp; * 1 1/2 oz Gin&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Shake with a glassful<br />&nbsp; * 1/4 oz Triple Sec&nbsp; &nbsp; &nbsp; &nbsp;of broken ice and pour<br />&nbsp; * 3/4 oz Lime Juice&nbsp; &nbsp; &nbsp; &nbsp;unstrained into a goblet.<br />&nbsp; * 1 1/2 oz Orange Juice<br />&nbsp; * 1 tsp. Grenadine Syrup<br /> -----------------------------------------------------<br />root@OpenWrt:/# df -h<br />Filesystem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; Used Available Use% Mounted on<br />/dev/root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.3M&nbsp; &nbsp; &nbsp; 2.3M&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 100% /rom<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 61.5M&nbsp; &nbsp; &nbsp; 1.1M&nbsp; &nbsp; &nbsp;60.4M&nbsp; &nbsp;2% /tmp<br />/dev/sdb2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;449.1M&nbsp; &nbsp; &nbsp;45.9M&nbsp; &nbsp; 375.6M&nbsp; 11% /overlay<br />overlayfs:/overlay&nbsp; &nbsp; &nbsp; 449.1M&nbsp; &nbsp; &nbsp;45.9M&nbsp; &nbsp; 375.6M&nbsp; 11% /<br />tmpfs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;512.0K&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; 512.0K&nbsp; &nbsp;0% /dev<br />/dev/sda1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 13.9G&nbsp; &nbsp; &nbsp;11.9G&nbsp; &nbsp; &nbsp; 1.3G&nbsp; 90% /mnt/16GB<br />/dev/sdb1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 28.6G&nbsp; &nbsp; 406.8M&nbsp; &nbsp; &nbsp;26.8G&nbsp; &nbsp;1% /mnt/32GB<br />/dev/sdc1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;145.6G&nbsp; &nbsp; &nbsp;40.1G&nbsp; &nbsp; &nbsp;98.1G&nbsp; 29% /mnt/150GB<br />/dev/sdd1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.3T&nbsp; &nbsp; &nbsp;99.9G&nbsp; &nbsp; &nbsp; 1.2T&nbsp; &nbsp;8% /mnt/tera<br />root@OpenWrt:/#</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293394">
				<div class="post-metadata">
					<div class="post-num">Post #5</div>
					<div class="post-author">DrStein</div>
					<div class="post-datetime">
						25 Sep 2015, 10:12					</div>
				</div>
				<div class="post-content content">
					<p>Can you give some instructions? Did you use snapshot or <a href="http://downloads.openwrt.org/chaos_calmer/15.05/ar71xx/generic/openwrt-15.05-ar71xx-generic-tl-mr3420-v1-squashfs-sysupgrade.bin">stable CC firmware</a>? Which extra modules did you install and in what order?</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293440">
				<div class="post-metadata">
					<div class="post-num">Post #6</div>
					<div class="post-author">kgoerbig</div>
					<div class="post-datetime">
						25 Sep 2015, 15:44					</div>
				</div>
				<div class="post-content content">
					<p>I use the snapshot revision of CC. I had issues with the trunk version with USB mounts changing positions after a reboot (ie /dev/sdb2 would change to /dev/sda2 for no apparent reason.)</p><p>The &quot;Make extroot overlay Script&quot;. You have to pre-configure fstab with all of your USB mounts first, and save it as fstab.default in /etc/config. This way, all that configuration is done before hand, and the second section of the script setups up extroot. You have to alter that section to match your own USB mount points that you have partitioned. I recommend using gparted to partition your usb drive in three sections. Section 1 Main storage, section 2 extroot (500MB is plenty), and section 3 swap.</p><p><strong>Please, Please! Be sure you alter these scripts to meet your router&#039;s hardware and usb drive mount points! I have a TP-LINK TL-WDR3600, and these scripts are setup for that particular hardware!</strong></p><br /><p><strong><span class="bbu">Upgrade Script</span></strong> <br /></p><div class="codebox"><pre><code>#!/bin/sh
cd /tmp
rm *.bin
wget http://downloads.openwrt.org/snapshots/trunk/ar71xx/generic/openwrt-ar71xx-generic-tl-wdr3600-v1-squashfs-sysupgrade.bin
sysupgrade -v /tmp/openwrt-ar71xx-generic-tl-wdr3600-v1-squashfs-sysupgrade.bin</code></pre></div><br /><p><strong><span class="bbu">USB Script</span></strong> <br /></p><div class="codebox"><pre><code>#!/bin/sh
rm /etc/opkg.conf
cp /rom/etc/opkg.conf /etc/opkg.conf
opkg update
opkg install blkid kmod-fs-ext4 kmod-fs-vfat kmod-usb-core kmod-usb-storage nano block-extroot block-hotplug block-mount fdisk cfdisk hotplug2 e2fsprogs rsync lftp
reboot</code></pre></div><br /><p><strong><span class="bbu">Make extroot overlay Script</span></strong> <br /></p><div class="codebox"><pre><code>#!/bin/sh
mkdir /temp
rm /etc/config/fstab
cp /etc/config/fstab.default /etc/config/fstab
chmod +x /etc/config/fstab
mkfs.ext4 /dev/sdb2
mount /dev/sdb2 /temp
tar -C /overlay -cvf - . | tar -C /temp -xf -

#Create fstab entries w/ uci
uci add fstab mount
uci set fstab.@mount[-1].device=/dev/sdb2
uci set fstab.@mount[-1].fstype=ext4
uci set fstab.@mount[-1].options=rw,sync,noatime
uci set fstab.@mount[-1].target=/overlay
uci set fstab.@mount[-1].enabled=1

#Make Swap
uci set fstab.swap@[-1].device=/dev/sdb3
uci set fstab.swap@[-1].enabled=1
uci commit fstab
/etc/init.d/fstab restart

#Commit configuration
uci commit

#Reboot
reboot</code></pre></div><br /><p><strong><span class="bbu">Install Packages to extroot Script</span></strong> <br /></p><div class="codebox"><pre><code>#!/bin/sh
rm /etc/opkg.conf
cp /rom/etc/opkg.conf /etc/opkg.conf
opkg update &amp;&amp; for i in $(cat /etc/config/scripts/opkg_installed); do opkg install $i; done</code></pre></div><p><span class="bbu"><strong>****Creates a backup list of all installed packages</strong></span><br />opkg list_installed | cut -f 1 -d &#039; &#039; &gt;&gt; /mnt/16GB/openwrt-cc/opkg_installed</p><br /><p><span class="bbu"><strong>My fstab. I recommend using blkid command to find your uuid&#039;s. I use ext4 and swap partitions only</strong></span><br /></p><div class="codebox"><pre><code>config global
        option anon_swap &#039;0&#039;
        option anon_mount &#039;0&#039;
        option auto_swap &#039;1&#039;
        option auto_mount &#039;1&#039;
        option delay_root &#039;5&#039;
        option check_fs &#039;1&#039;

config mount
        option target &#039;/mnt/16GB&#039;
        option uuid &#039;35f31541-2dd2-42ff-b685-6d1592717fff&#039;
        option enabled &#039;1&#039;

config mount
        option target &#039;/mnt/32GB&#039;
        option uuid &#039;30578db1-24c0-4483-8055-273c8d3eb653&#039;
        option enabled &#039;1&#039;

config mount
        option target &#039;/mnt/150GB&#039;
        option uuid &#039;ffed1564-6582-4742-928b-b1122e936412&#039;
        option enabled &#039;1&#039;

config mount
        option target &#039;/mnt/tera&#039;
        option uuid &#039;d0484bcb-ccc3-4643-8039-4a19ee9a329a&#039;
        option enabled &#039;1&#039;</code></pre></div>											<p class="post-edited">(Last edited by <strong>kgoerbig</strong> on 25 Sep 2015, 18:27)</p>
									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p293471">
				<div class="post-metadata">
					<div class="post-num">Post #7</div>
					<div class="post-author">DrStein</div>
					<div class="post-datetime">
						25 Sep 2015, 20:29					</div>
				</div>
				<div class="post-content content">
					<p>Thank You for very detailed answer! But my main problem is lack of free space, so my procedure stops at this point <br /></p><div class="codebox"><pre><code>opkg install kmod-fs-ext4 kmod-usb-core kmod-usb-storage</code></pre></div><p>These three most important modules cannot be installed because on clean CC firmware I have about 360 kB free space (my router flash is only 4MB). At this time I reverted back to BB firmware and thinking about buying <a href="http://www.aliexpress.com/item/English-Version-xiaomi-router-mini-intelligent-AC-dual-band-2-4G-5GHz-1167Mbps-Wifi-802/2029410897.html">this interesting router</a>. The seller flashes it with latest <a href="http://downloads.openwrt.org.cn/">PandoraBox</a> firmware based on OpenWRT. And it is already supported by OpenWRT in stable CC firmware!</p>									</div>
			</article>

			
		
			
		
		
			<article class="post" id="p307033">
				<div class="post-metadata">
					<div class="post-num">Post #8</div>
					<div class="post-author">kaju666</div>
					<div class="post-datetime">
						10 Jan 2016, 20:31					</div>
				</div>
				<div class="post-content content">
					<p>i have the same problem, but i fixed it, and now i have CC + Luci + exroot + modem working wery good on 4mb router.</p><p>here i write an instruction for that <a href="http://majster.kaju.ovh/2016/01/openwrt-chaos-calmer-1505-na-tp-link-tl.html">http://majster.kaju.ovh/2016/01/openwrt â€¦ nk-tl.html</a></p><p>It is in polish but you can translate it with google translator.</p>									</div>
			</article>

			
		
	
			<div class="notice minor">
			<p>The discussion might have continued from here.</p>
		</div>
	
	<div class="pagination"><div class="pagination-number">Page 1 of 1</div><nav><ul><li class="pagination-current"><span>1</span></li></ul></nav></div>
</main>

</div>


<!-- Created in a hurry and not indicative of usual code quality. Here's a number: 0 -->

</body>
</html>